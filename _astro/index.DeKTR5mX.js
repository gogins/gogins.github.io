/**
 * @license Fraction.js v4.3.7 31/08/2023
 * https://www.xarg.org/2014/03/rational-numbers-in-javascript/
 *
 * Copyright (c) 2023, Robert Eisele (robert@raw.org)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 **/var Ic=2e3,w={s:1,n:0,d:1};function tt(e,t){if(isNaN(e=parseInt(e,10)))throw Bt();return e*t}function M(e,t){if(t===0)throw Dt();var n=Object.create(S.prototype);n.s=e<0?-1:1,e=e<0?-e:e;var s=pt(e,t);return n.n=e/s,n.d=t/s,n}function _e(e){for(var t={},n=e,s=2,r=4;r<=n;){for(;n%s===0;)n/=s,t[s]=(t[s]||0)+1;r+=1+2*s++}return n!==e?n>1&&(t[n]=(t[n]||0)+1):t[e]=(t[e]||0)+1,t}var D=function(e,t){var n=0,s=1,r=1,o=0,i=0,a=0,l=1,h=1,u=0,f=1,d=1,y=1,v=1e7,b;if(e!=null)if(t!==void 0){if(n=e,s=t,r=n*s,n%1!==0||s%1!==0)throw Vc()}else switch(typeof e){case"object":{if("d"in e&&"n"in e)n=e.n,s=e.d,"s"in e&&(n*=e.s);else if(0 in e)n=e[0],1 in e&&(s=e[1]);else throw Bt();r=n*s;break}case"number":{if(e<0&&(r=e,e=-e),e%1===0)n=e;else if(e>0){for(e>=1&&(h=Math.pow(10,Math.floor(1+Math.log(e)/Math.LN10)),e/=h);f<=v&&y<=v;)if(b=(u+d)/(f+y),e===b){f+y<=v?(n=u+d,s=f+y):y>f?(n=d,s=y):(n=u,s=f);break}else e>b?(u+=d,f+=y):(d+=u,y+=f),f>v?(n=d,s=y):(n=u,s=f);n*=h}else(isNaN(e)||isNaN(t))&&(s=n=NaN);break}case"string":{if(f=e.match(/\d+|./g),f===null)throw Bt();if(f[u]==="-"?(r=-1,u++):f[u]==="+"&&u++,f.length===u+1?i=tt(f[u++],r):f[u+1]==="."||f[u]==="."?(f[u]!=="."&&(o=tt(f[u++],r)),u++,(u+1===f.length||f[u+1]==="("&&f[u+3]===")"||f[u+1]==="'"&&f[u+3]==="'")&&(i=tt(f[u],r),l=Math.pow(10,f[u].length),u++),(f[u]==="("&&f[u+2]===")"||f[u]==="'"&&f[u+2]==="'")&&(a=tt(f[u+1],r),h=Math.pow(10,f[u+1].length)-1,u+=3)):f[u+1]==="/"||f[u+1]===":"?(i=tt(f[u],r),l=tt(f[u+2],1),u+=3):f[u+3]==="/"&&f[u+1]===" "&&(o=tt(f[u],r),i=tt(f[u+2],r),l=tt(f[u+4],1),u+=5),f.length<=u){s=l*h,r=n=a+s*o+h*i;break}}default:throw Bt()}if(s===0)throw Dt();w.s=r<0?-1:1,w.n=Math.abs(n),w.d=Math.abs(s)};function Wc(e,t,n){for(var s=1;t>0;e=e*e%n,t>>=1)t&1&&(s=s*e%n);return s}function Hc(e,t){for(;t%2===0;t/=2);for(;t%5===0;t/=5);if(t===1)return 0;for(var n=10%t,s=1;n!==1;s++)if(n=n*10%t,s>Ic)return 0;return s}function Dc(e,t,n){for(var s=1,r=Wc(10,n,t),o=0;o<300;o++){if(s===r)return o;s=s*10%t,r=r*10%t}return 0}function pt(e,t){if(!e)return t;if(!t)return e;for(;;){if(e%=t,!e)return t;if(t%=e,!t)return e}}function S(e,t){if(D(e,t),this instanceof S)e=pt(w.d,w.n),this.s=w.s,this.n=w.n/e,this.d=w.d/e;else return M(w.s*w.n,w.d)}var Dt=function(){return new Error("Division by Zero")},Bt=function(){return new Error("Invalid argument")},Vc=function(){return new Error("Parameters must be integer")};S.prototype={s:1,n:0,d:1,abs:function(){return M(this.n,this.d)},neg:function(){return M(-this.s*this.n,this.d)},add:function(e,t){return D(e,t),M(this.s*this.n*w.d+w.s*this.d*w.n,this.d*w.d)},sub:function(e,t){return D(e,t),M(this.s*this.n*w.d-w.s*this.d*w.n,this.d*w.d)},mul:function(e,t){return D(e,t),M(this.s*w.s*this.n*w.n,this.d*w.d)},div:function(e,t){return D(e,t),M(this.s*w.s*this.n*w.d,this.d*w.n)},clone:function(){return M(this.s*this.n,this.d)},mod:function(e,t){if(isNaN(this.n)||isNaN(this.d))return new S(NaN);if(e===void 0)return M(this.s*this.n%this.d,1);if(D(e,t),w.n===0&&this.d===0)throw Dt();return M(this.s*(w.d*this.n)%(w.n*this.d),w.d*this.d)},gcd:function(e,t){return D(e,t),M(pt(w.n,this.n)*pt(w.d,this.d),w.d*this.d)},lcm:function(e,t){return D(e,t),w.n===0&&this.n===0?M(0,1):M(w.n*this.n,pt(w.n,this.n)*pt(w.d,this.d))},ceil:function(e){return e=Math.pow(10,e||0),isNaN(this.n)||isNaN(this.d)?new S(NaN):M(Math.ceil(e*this.s*this.n/this.d),e)},floor:function(e){return e=Math.pow(10,e||0),isNaN(this.n)||isNaN(this.d)?new S(NaN):M(Math.floor(e*this.s*this.n/this.d),e)},round:function(e){return e=Math.pow(10,e||0),isNaN(this.n)||isNaN(this.d)?new S(NaN):M(Math.round(e*this.s*this.n/this.d),e)},roundTo:function(e,t){return D(e,t),M(this.s*Math.round(this.n*w.d/(this.d*w.n))*w.n,w.d)},inverse:function(){return M(this.s*this.d,this.n)},pow:function(e,t){if(D(e,t),w.d===1)return w.s<0?M(Math.pow(this.s*this.d,w.n),Math.pow(this.n,w.n)):M(Math.pow(this.s*this.n,w.n),Math.pow(this.d,w.n));if(this.s<0)return null;var n=_e(this.n),s=_e(this.d),r=1,o=1;for(var i in n)if(i!=="1"){if(i==="0"){r=0;break}if(n[i]*=w.n,n[i]%w.d===0)n[i]/=w.d;else return null;r*=Math.pow(i,n[i])}for(var i in s)if(i!=="1"){if(s[i]*=w.n,s[i]%w.d===0)s[i]/=w.d;else return null;o*=Math.pow(i,s[i])}return w.s<0?M(o,r):M(r,o)},equals:function(e,t){return D(e,t),this.s*this.n*w.d===w.s*w.n*this.d},compare:function(e,t){D(e,t);var n=this.s*this.n*w.d-w.s*w.n*this.d;return(0<n)-(n<0)},simplify:function(e){if(isNaN(this.n)||isNaN(this.d))return this;e=e||.001;for(var t=this.abs(),n=t.toContinued(),s=1;s<n.length;s++){for(var r=M(n[s-1],1),o=s-2;o>=0;o--)r=r.inverse().add(n[o]);if(Math.abs(r.sub(t).valueOf())<e)return r.mul(this.s)}return this},divisible:function(e,t){return D(e,t),!(!(w.n*this.d)||this.n*w.d%(w.n*this.d))},valueOf:function(){return this.s*this.n/this.d},toFraction:function(e){var t,n="",s=this.n,r=this.d;return this.s<0&&(n+="-"),r===1?n+=s:(e&&(t=Math.floor(s/r))>0&&(n+=t,n+=" ",s%=r),n+=s,n+="/",n+=r),n},toLatex:function(e){var t,n="",s=this.n,r=this.d;return this.s<0&&(n+="-"),r===1?n+=s:(e&&(t=Math.floor(s/r))>0&&(n+=t,s%=r),n+="\\frac{",n+=s,n+="}{",n+=r,n+="}"),n},toContinued:function(){var e,t=this.n,n=this.d,s=[];if(isNaN(t)||isNaN(n))return s;do s.push(Math.floor(t/n)),e=t%n,t=n,n=e;while(t!==1);return s},toString:function(e){var t=this.n,n=this.d;if(isNaN(t)||isNaN(n))return"NaN";e=e||15;var s=Hc(t,n),r=Dc(t,n,s),o=this.s<0?"-":"";if(o+=t/n|0,t%=n,t*=10,t&&(o+="."),s){for(var i=r;i--;)o+=t/n|0,t%=n,t*=10;o+="(";for(var i=s;i--;)o+=t/n|0,t%=n,t*=10;o+=")"}else for(var i=e;t&&i--;)o+=t/n|0,t%=n,t*=10;return o}};S.prototype.sam=function(){return this.floor()};S.prototype.nextSam=function(){return this.sam().add(1)};S.prototype.wholeCycle=function(){return new j(this.sam(),this.nextSam())};S.prototype.cyclePos=function(){return this.sub(this.sam())};S.prototype.lt=function(e){return this.compare(e)<0};S.prototype.gt=function(e){return this.compare(e)>0};S.prototype.lte=function(e){return this.compare(e)<=0};S.prototype.gte=function(e){return this.compare(e)>=0};S.prototype.eq=function(e){return this.compare(e)==0};S.prototype.max=function(e){return this.gt(e)?this:e};S.prototype.maximum=function(...e){return e=e.map(t=>new S(t)),e.reduce((t,n)=>n.max(t),this)};S.prototype.min=function(e){return this.lt(e)?this:e};S.prototype.show=function(){return this.s*this.n+"/"+this.d};S.prototype.or=function(e){return this.eq(0)?e:this};const _=e=>S(e),Gc=(...e)=>e.reduce((t,n)=>t.gcd(n),_(1)),Et=(...e)=>e.reduce((t,n)=>t.lcm(n),_(1));_._original=S;class j{constructor(t,n){this.begin=_(t),this.end=_(n)}get spanCycles(){const t=[];var n=this.begin;const s=this.end,r=s.sam();if(n.equals(s))return[new j(n,s)];for(;s.gt(n);){if(n.sam().equals(r)){t.push(new j(n,this.end));break}const o=n.nextSam();t.push(new j(n,o)),n=o}return t}get duration(){return this.end.sub(this.begin)}cycleArc(){const t=this.begin.cyclePos(),n=t.add(this.duration);return new j(t,n)}withTime(t){return new j(t(this.begin),t(this.end))}withEnd(t){return new j(this.begin,t(this.end))}withCycle(t){const n=this.begin.sam(),s=n.add(t(this.begin.sub(n))),r=n.add(t(this.end.sub(n)));return new j(s,r)}intersection(t){const n=this.begin.max(t.begin),s=this.end.min(t.end);if(!n.gt(s)&&!(n.equals(s)&&(n.equals(this.end)&&this.begin.lt(this.end)||n.equals(t.end)&&t.begin.lt(t.end))))return new j(n,s)}intersection_e(t){const n=this.intersection(t);if(n==null)throw"TimeSpans do not intersect";return n}midpoint(){return this.begin.add(this.duration.div(_(2)))}equals(t){return this.begin.equals(t.begin)&&this.end.equals(t.end)}show(){return this.begin.show()+" → "+this.end.show()}}class z{constructor(t,n,s,r={},o=!1){this.whole=t,this.part=n,this.value=s,this.context=r,this.stateful=o,o&&console.assert(typeof this.value=="function","Stateful values must be functions")}get duration(){let t;return typeof this.value?.duration=="number"?t=_(this.value.duration):t=this.whole.end.sub(this.whole.begin),typeof this.value?.clip=="number"?t.mul(this.value.clip):t}get endClipped(){return this.whole.begin.add(this.duration)}isActive(t){return this.whole.begin<=t&&this.endClipped>=t}isInPast(t){return t>this.endClipped}isInNearPast(t,n){return n-t<=this.endClipped}isInFuture(t){return t<this.whole.begin}isInNearFuture(t,n){return n<this.whole.begin&&n>this.whole.begin-t}isWithinTime(t,n){return this.whole.begin<=n&&this.endClipped>=t}wholeOrPart(){return this.whole?this.whole:this.part}withSpan(t){const n=this.whole?t(this.whole):void 0;return new z(n,t(this.part),this.value,this.context)}withValue(t){return new z(this.whole,this.part,t(this.value),this.context)}hasOnset(){return this.whole!=null&&this.whole.begin.equals(this.part.begin)}hasTag(t){return this.context.tags?.includes(t)}resolveState(t){if(this.stateful&&this.hasOnset()){console.log("stateful");const n=this.value,[s,r]=n(t);return[s,new z(this.whole,this.part,r,this.context,!1)]}return[t,this]}spanEquals(t){return this.whole==null&&t.whole==null||this.whole.equals(t.whole)}equals(t){return this.spanEquals(t)&&this.part.equals(t.part)&&this.value===t.value}show(t=!1){const n=typeof this.value=="object"?t?JSON.stringify(this.value).slice(1,-1).replaceAll('"',"").replaceAll(","," "):JSON.stringify(this.value):this.value;var s="";if(this.whole==null)s="~"+this.part.show;else{var r=this.whole.begin.equals(this.part.begin)&&this.whole.end.equals(this.part.end);this.whole.begin.equals(this.part.begin)||(s=this.whole.begin.show()+" ⇜ "),r||(s+="("),s+=this.part.show(),r||(s+=")"),this.whole.end.equals(this.part.end)||(s+=" ⇝ "+this.whole.end.show())}return"[ "+s+" | "+n+" ]"}showWhole(t=!1){return`${this.whole==null?"~":this.whole.show()}: ${typeof this.value=="object"?t?JSON.stringify(this.value).slice(1,-1).replaceAll('"',"").replaceAll(","," "):JSON.stringify(this.value):this.value}`}combineContext(t){const n=this;return{...n.context,...t.context,locations:(n.context.locations||[]).concat(t.context.locations||[])}}setContext(t){return new z(this.whole,this.part,this.value,t)}ensureObjectValue(){if(typeof this.value!="object")throw new Error(`expected hap.value to be an object, but got "${this.value}". Hint: append .note() or .s() to the end`,"error")}}class yt{constructor(t,n={}){this.span=t,this.controls=n}setSpan(t){return new yt(t,this.controls)}withSpan(t){return this.setSpan(t(this.span))}setControls(t){return new yt(this.span,t)}}const Vt="strudel.log";let Qc=1e3,ke,qe;function F(e,t,n={}){let s=performance.now();ke===e&&s-qe<Qc||(ke=e,qe=s,console.log(`%c${e}`,"background-color: black;color:white;border-radius:15px"),typeof document<"u"&&typeof CustomEvent<"u"&&document.dispatchEvent(new CustomEvent(Vt,{detail:{message:e,type:t,data:n}})))}F.key=Vt;const Uc=e=>/^[a-gA-G][#bs]*[0-9]$/.test(e),Pt=e=>/^[a-gA-G][#bsf]*[0-9]?$/.test(e),Oe=e=>{if(typeof e!="string")return[];const[t,n="",s]=e.match(/^([a-gA-G])([#bsf]*)([0-9]*)$/)?.slice(1)||[];return t?[t,n,s?Number(s):void 0]:[]},Kc={c:0,d:2,e:4,f:5,g:7,a:9,b:11},Zc={"#":1,b:-1,s:1,f:-1},gt=(e,t=3)=>{const[n,s,r=t]=Oe(e);if(!n)throw new Error('not a note: "'+e+'"');const o=Kc[n.toLowerCase()],i=s?.split("").reduce((a,l)=>a+Zc[l],0)||0;return(Number(r)+1)*12+o+i},wt=e=>Math.pow(2,(e-69)/12)*440,Gt=e=>12*Math.log(e/440)/Math.LN2+69,Xc=(e,t)=>{if(typeof e!="object")throw new Error("valueToMidi: expected object value");let{freq:n,note:s}=e;if(typeof n=="number")return Gt(n);if(typeof s=="string")return gt(s);if(typeof s=="number")return s;if(!t)throw new Error("valueToMidi: expected freq or note to be set");return t},xe=e=>wt(typeof e=="number"?e:gt(e)),Yc=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],ta=e=>{const t=Math.floor(e/12)-1;return Yc[e%12]+t},Nt=(e,t)=>(e%t+t)%t;function Be(e,t=0){return isNaN(Number(e))?(F(`"${e}" is not a number, falling back to ${t}`,"warning"),t):e}const ea=(e,t)=>Nt(Math.round(Be(e??0,0)),t),na=e=>{let{value:t,context:n}=e,s=t;if(typeof s=="object"&&!Array.isArray(s)&&(s=s.note||s.n||s.value,s===void 0))throw new Error(`cannot find a playable note for ${JSON.stringify(t)}`);if(typeof s=="number"&&n.type!=="frequency")s=wt(e.value);else if(typeof s=="number"&&n.type==="frequency")s=e.value;else if(typeof s!="string"||!Pt(s))throw new Error("not a note: "+JSON.stringify(s));return s},sa=e=>{let{value:t,context:n}=e;if(typeof t=="object")return t.freq?t.freq:xe(t.note||t.n||t.value);if(typeof t=="number"&&n.type!=="frequency")t=wt(e.value);else if(typeof t=="string"&&Pt(t))t=wt(gt(e.value));else if(typeof t!="number")throw new Error("not a note or frequency: "+t);return t},ze=(e,t)=>e.slice(t).concat(e.slice(0,t)),Ee=(...e)=>e.reduce((t,n)=>(...s)=>t(n(...s)),t=>t),ra=(...e)=>Ee(...e.reverse()),Pe=e=>e.filter(t=>t!=null),ot=e=>[].concat(...e),dt=e=>e,oa=(e,t)=>e,Qt=(e,t)=>Array.from({length:t-e+1},(n,s)=>s+e);function C(e,t,n=e.length){const s=function r(...o){if(o.length>=n)return e.apply(this,o);{const i=function(...a){return r.apply(this,o.concat(a))};return t&&t(i,o),i}};return t&&t(s,[]),s}function Ut(e){const t=Number(e);if(!isNaN(t))return t;if(Pt(e))return gt(e);throw new Error(`cannot parse as numeral: "${e}"`)}function Kt(e,t){return(...n)=>e(...n.map(t))}function V(e){return Kt(e,Ut)}function je(e){const t=Number(e);if(!isNaN(t))return t;const n={pi:Math.PI,w:1,h:.5,q:.25,e:.125,s:.0625,t:1/3,f:.2,x:1/6}[e];if(typeof n<"u")return n;throw new Error(`cannot parse as fractional: "${e}"`)}const ia=e=>Kt(e,je),Zt=function(e,t){return[t.slice(0,e),t.slice(e)]},Xt=(e,t,n)=>t.map((s,r)=>e(s,n[r])),$e=(e,t,n)=>Math.min(Math.max(e,t),n),ca=["Do","Reb","Re","Mib","Mi","Fa","Solb","Sol","Lab","La","Sib","Si"],aa=["Sa","Re","Ga","Ma","Pa","Dha","Ni"],ua=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Hb","H"],la=["Ni","Pab","Pa","Voub","Vou","Ga","Dib","Di","Keb","Ke","Zob","Zo"],ha=["I","Ro","Ha","Ni","Ho","He","To"],fa=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],pa=(e,t="letters")=>{const s=(t==="solfeggio"?ca:t==="indian"?aa:t==="german"?ua:t==="byzantine"?la:t==="japanese"?ha:fa)[e%12],r=Math.floor(e/12)-1;return s+r};function Re(e){const t=new TextEncoder().encode(e);return btoa(String.fromCharCode(...t))}function Fe(e){const t=new Uint8Array(atob(e).split("").map(s=>s.charCodeAt(0)));return new TextDecoder().decode(t)}function da(e){return encodeURIComponent(Re(e))}function ma(e){return Fe(decodeURIComponent(e))}function Le(e,t){return Array.isArray(e)?e.map(t):Object.fromEntries(Object.entries(e).map(([n,s],r)=>[n,t(s,n,r)]))}function ya(e,t,n){if(t?.value!==void 0&&Object.keys(t).length===1)return F("[warn]: Can't do arithmetic on control pattern."),e;const s=Object.keys(e).filter(r=>Object.keys(t).includes(r));return Object.assign({},e,t,Object.fromEntries(s.map(r=>[r,n(e[r],t[r])])))}C((e,t)=>e*t);C((e,t)=>t.map(e));function Je(e,t=60){let n=0,s=_(0),r=[""],o="";for(;r[0].length<t;){const i=e.queryArc(n,n+1),a=i.filter(u=>u.hasOnset()).map(u=>u.duration),l=Gc(...a),h=l.inverse();r=r.map(u=>u+"|"),o+="|";for(let u=0;u<h;u++){const[f,d]=[s,s.add(l)],y=i.filter(b=>b.whole.begin.lte(f)&&b.whole.end.gte(d)),v=y.length-r.length;v>0&&(r=r.concat(Array(v).fill(o))),r=r.map((b,q)=>{const k=y[q];if(k){const R=k.whole.begin.eq(f)?""+k.value:"-";return b+R}return b+"."}),o+=".",s=s.add(l)}n++}return r.join(`
`)}let Lt;const wa=e=>Lt=e;class m{constructor(t,n=void 0){this.query=t,this._Pattern=!0,this.__tactus=n}get tactus(){return this.__tactus??_(1)}set tactus(t){this.__tactus=_(t)}setTactus(t){return this.tactus=t,this}withValue(t){const n=new m(s=>this.query(s).map(r=>r.withValue(t)));return n.tactus=this.tactus,n}fmap(t){return this.withValue(t)}appWhole(t,n){const s=this,r=function(o){const i=s.query(o),a=n.query(o),l=function(h,u){const f=h.part.intersection(u.part);if(f!=null)return new z(t(h.whole,u.whole),f,h.value(u.value),u.combineContext(h))};return ot(i.map(h=>Pe(a.map(u=>l(h,u)))))};return new m(r)}appBoth(t){const n=this,s=function(o,i){if(!(o==null||i==null))return o.intersection_e(i)},r=n.appWhole(s,t);return r.tactus=Et(t.tactus,n.tactus),r}appLeft(t){const n=this,s=function(o){const i=[];for(const a of n.query(o)){const l=t.query(o.setSpan(a.wholeOrPart()));for(const h of l){const u=a.whole,f=a.part.intersection(h.part);if(f){const d=a.value(h.value),y=h.combineContext(a),v=new z(u,f,d,y);i.push(v)}}}return i},r=new m(s);return r.tactus=this.tactus,r}appRight(t){const n=this,s=function(o){const i=[];for(const a of t.query(o)){const l=n.query(o.setSpan(a.wholeOrPart()));for(const h of l){const u=a.whole,f=h.part.intersection(a.part);if(f){const d=h.value(a.value),y=a.combineContext(h),v=new z(u,f,d,y);i.push(v)}}}return i},r=new m(s);return r.tactus=t.tactus,r}bindWhole(t,n){const s=this,r=function(o){const i=function(l,h){return new z(t(l.whole,h.whole),h.part,h.value,Object.assign({},l.context,h.context,{locations:(l.context.locations||[]).concat(h.context.locations||[])}))},a=function(l){return n(l.value).query(o.setSpan(l.part)).map(h=>i(l,h))};return ot(s.query(o).map(l=>a(l)))};return new m(r)}bind(t){const n=function(s,r){if(!(s==null||r==null))return s.intersection_e(r)};return this.bindWhole(n,t)}join(){return this.bind(dt)}outerBind(t){return this.bindWhole(n=>n,t)}outerJoin(){return this.outerBind(dt)}innerBind(t){return this.bindWhole((n,s)=>s,t)}innerJoin(){return this.innerBind(dt)}resetJoin(t=!1){const n=this;return new m(s=>n.discreteOnly().query(s).map(r=>r.value.late(t?r.whole.begin:r.whole.begin.cyclePos()).query(s).map(o=>new z(o.whole?o.whole.intersection(r.whole):void 0,o.part.intersection(r.part),o.value).setContext(r.combineContext(o))).filter(o=>o.part)).flat())}restartJoin(){return this.resetJoin(!0)}squeezeJoin(){const t=this;function n(s){const r=t.discreteOnly().query(s);function o(a){const h=a.value._focusSpan(a.wholeOrPart()).query(s.setSpan(a.part));function u(f,d){let y;if(d.whole&&f.whole&&(y=d.whole.intersection(f.whole),!y))return;const v=d.part.intersection(f.part);if(!v)return;const b=d.combineContext(f);return new z(y,v,d.value,b)}return h.map(f=>u(a,f))}return ot(r.map(o)).filter(a=>a)}return new m(n)}squeezeBind(t){return this.fmap(t).squeezeJoin()}queryArc(t,n,s={}){try{return this.query(new yt(new j(t,n),s))}catch(r){return F(`[query]: ${r.message}`,"error"),[]}}splitQueries(){const t=this,n=s=>ot(s.span.spanCycles.map(r=>t.query(s.setSpan(r))));return new m(n)}withQuerySpan(t){return new m(n=>this.query(n.withSpan(t)))}withQuerySpanMaybe(t){const n=this;return new m(s=>{const r=s.withSpan(t);return r.span?n.query(r):[]})}withQueryTime(t){return new m(n=>this.query(n.withSpan(s=>s.withTime(t))))}withHapSpan(t){return new m(n=>this.query(n).map(s=>s.withSpan(t)))}withHapTime(t){return this.withHapSpan(n=>n.withTime(t))}withHaps(t){const n=new m(s=>t(this.query(s),s));return n.tactus=this.tactus,n}withHap(t){return this.withHaps(n=>n.map(t))}setContext(t){return this.withHap(n=>n.setContext(t))}withContext(t){const n=this.withHap(s=>s.setContext(t(s.context)));return this.__pure!==void 0&&(n.__pure=this.__pure,n.__pure_loc=this.__pure_loc),n}stripContext(){return this.withHap(t=>t.setContext({}))}withLoc(t,n){const s={start:t,end:n},r=this.withContext(o=>{const i=(o.locations||[]).concat([s]);return{...o,locations:i}});return this.__pure&&(r.__pure=this.__pure,r.__pure_loc=s),r}filterHaps(t){return new m(n=>this.query(n).filter(t))}filterValues(t){return new m(n=>this.query(n).filter(s=>t(s.value))).setTactus(this.tactus)}removeUndefineds(){return this.filterValues(t=>t!=null)}onsetsOnly(){return this.filterHaps(t=>t.hasOnset())}discreteOnly(){return this.filterHaps(t=>t.whole)}defragmentHaps(){return this.discreteOnly().withHaps(n=>{const s=[];for(var r=0;r<n.length;++r){for(var o=!0,i=n[r];o;){const h=JSON.stringify(n[r].value);for(var a=!1,l=r+1;l<n.length;l++){const u=n[l];if(i.whole.equals(u.whole)){if(i.part.begin.eq(u.part.end)){if(h===JSON.stringify(u.value)){i=new z(i.whole,new j(u.part.begin,i.part.end),i.value),n.splice(l,1),a=!0;break}}else if(u.part.begin.eq(i.part.end)&&h==JSON.stringify(u.value)){i=new z(i.whole,new j(i.part.begin,u.part.end),i.value),n.splice(l,1),a=!0;break}}}o=a}s.push(i)}return s})}firstCycle(t=!1){var n=this;return t||(n=n.stripContext()),n.query(new yt(new j(_(0),_(1))))}get firstCycleValues(){return this.firstCycle().map(t=>t.value)}get showFirstCycle(){return this.firstCycle().map(t=>`${t.value}: ${t.whole.begin.toFraction()} - ${t.whole.end.toFraction()}`)}sortHapsByPart(){return this.withHaps(t=>t.sort((n,s)=>n.part.begin.sub(s.part.begin).or(n.part.end.sub(s.part.end)).or(n.whole.begin.sub(s.whole.begin).or(n.whole.end.sub(s.whole.end)))))}asNumber(){return this.fmap(Ut)}_opIn(t,n){return this.fmap(n).appLeft(g(t))}_opOut(t,n){return this.fmap(n).appRight(g(t))}_opMix(t,n){return this.fmap(n).appBoth(g(t))}_opSqueeze(t,n){const s=g(t);return this.fmap(r=>s.fmap(o=>n(r)(o))).squeezeJoin()}_opSqueezeOut(t,n){const s=this;return g(t).fmap(o=>s.fmap(i=>n(i)(o))).squeezeJoin()}_opReset(t,n){return g(t).fmap(r=>this.fmap(o=>n(o)(r))).resetJoin()}_opRestart(t,n){return g(t).fmap(r=>this.fmap(o=>n(o)(r))).restartJoin()}layer(...t){return $(...t.map(n=>n(this)))}superimpose(...t){return this.stack(...t.map(n=>n(this)))}stack(...t){return $(this,...t)}sequence(...t){return U(this,...t)}seq(...t){return U(this,...t)}cat(...t){return ne(this,...t)}fastcat(...t){return X(this,...t)}slowcat(...t){return nt(this,...t)}onTrigger(t,n=!0){return this.withHap(s=>s.setContext({...s.context,onTrigger:(...r)=>{s.context.onTrigger?.(...r),t(...r)},dominantTrigger:s.context.dominantTrigger||n}))}log(t=(s,r)=>`[hap] ${r.showWhole(!0)}`,n=(s,r)=>({hap:r})){return this.onTrigger((...s)=>{F(t(...s),void 0,n(...s))},!1)}logValues(t=dt){return this.log((n,s)=>t(s.value))}drawLine(){return console.log(Je(this)),this}}function ga(e,t){let n=[];return t.forEach(s=>{const r=n.findIndex(([o])=>e(s,o));r===-1?n.push([s]):n[r].push(s)}),n}const ba=(e,t)=>e.spanEquals(t);m.prototype.collect=function(){return this.withHaps(e=>ga(ba,e).map(t=>new z(t[0].whole,t[0].part,t,{})))};m.prototype.arpWith=function(e){return this.collect().fmap(t=>g(e(t))).innerJoin().withHap(t=>new z(t.whole,t.part,t.value.value,t.combineContext(t.value)))};m.prototype.arp=function(e){return this.arpWith(t=>e.fmap(n=>t[n%t.length]))};function xt(e){return!Array.isArray(e)&&typeof e=="object"}function va(e,t,n){return xt(e)||xt(t)?(xt(e)||(e={value:e}),xt(t)||(t={value:t}),ya(e,t,n)):n(e,t)}(function(){const e={set:[(n,s)=>s],keep:[n=>n],keepif:[(n,s)=>s?n:void 0],add:[V((n,s)=>n+s)],sub:[V((n,s)=>n-s)],mul:[V((n,s)=>n*s)],div:[V((n,s)=>n/s)],mod:[V(Nt)],pow:[V(Math.pow)],band:[V((n,s)=>n&s)],bor:[V((n,s)=>n|s)],bxor:[V((n,s)=>n^s)],blshift:[V((n,s)=>n<<s)],brshift:[V((n,s)=>n>>s)],lt:[(n,s)=>n<s],gt:[(n,s)=>n>s],lte:[(n,s)=>n<=s],gte:[(n,s)=>n>=s],eq:[(n,s)=>n==s],eqt:[(n,s)=>n===s],ne:[(n,s)=>n!=s],net:[(n,s)=>n!==s],and:[(n,s)=>n&&s],or:[(n,s)=>n||s],func:[(n,s)=>s(n)]},t=["In","Out","Mix","Squeeze","SqueezeOut","Reset","Restart"];for(const[n,[s,r]]of Object.entries(e)){m.prototype["_"+n]=function(o){return this.fmap(i=>s(i,o))},Object.defineProperty(m.prototype,n,{get:function(){const o=this,i=(...a)=>o[n].in(...a);for(const a of t)i[a.toLowerCase()]=function(...l){var h=o;l=U(l),r&&(h=r(h),l=r(l));var u;return n==="keepif"?(u=h["_op"+a](l,f=>d=>s(f,d)),u=u.removeUndefineds()):u=h["_op"+a](l,f=>d=>va(f,d,s)),u};return i.squeezein=i.squeeze,i}});for(const o of t)m.prototype[o.toLowerCase()]=function(...i){return this.set[o.toLowerCase()](i)}}m.prototype.struct=function(...n){return this.keepif.out(...n)},m.prototype.structAll=function(...n){return this.keep.out(...n)},m.prototype.mask=function(...n){return this.keepif.in(...n)},m.prototype.maskAll=function(...n){return this.keep.in(...n)},m.prototype.reset=function(...n){return this.keepif.reset(...n)},m.prototype.resetAll=function(...n){return this.keep.reset(...n)},m.prototype.restart=function(...n){return this.keepif.restart(...n)},m.prototype.restartAll=function(...n){return this.keep.restart(...n)}})();const Ie=$,We=$,He=jt;m.prototype.factories={pure:K,stack:$,slowcat:nt,fastcat:X,cat:ne,timecat:it,sequence:U,seq:Ue,polymeter:jt,pm:He,polyrhythm:Ie,pr:We};const bt=e=>new m(()=>[],_(e)),O=bt(1),_a=bt(0);function K(e){function t(s){return s.span.spanCycles.map(r=>new z(_(r.begin).wholeCycle(),r,e))}const n=new m(t,1);return n.__pure=e,n}function Yt(e){return e instanceof m||e?._Pattern}function g(e){return Yt(e)?e:Lt&&typeof e=="string"?Lt(e):K(e)}function $(...e){e=e.map(s=>Array.isArray(s)?U(...s):g(s));const t=s=>ot(e.map(r=>r.query(s))),n=new m(t);return n.tactus=Et(...e.map(s=>s.tactus)),n}function te(e,t){if(t=t.map(o=>Array.isArray(o)?U(...o):g(o)),t.length===0)return O;if(t.length===1)return t[0];const[n,...s]=t.map(o=>o.tactus),r=n.maximum(...s);return $(...e(r,t))}function De(...e){return te((t,n)=>n.map(s=>s.tactus.eq(t)?s:it(s,bt(t.sub(s.tactus)))),e)}function Ve(...e){return te((t,n)=>n.map(s=>s.tactus.eq(t)?s:it(bt(t.sub(s.tactus)),s)),e)}function Ge(...e){return te((t,n)=>n.map(s=>{if(s.tactus.eq(t))return s;const r=bt(t.sub(s.tactus).div(2));return it(r,s,r)}),e)}function ka(e,...t){const[n,...s]=t.map(i=>i.tactus),r=n.maximum(...s),o={centre:Ge,left:De,right:Ve,expand:$,repeat:(...i)=>Ke(r,...i)};return e.inhabit(o).fmap(i=>i(...t)).innerJoin().setTactus(r)}function nt(...e){if(e=e.map(n=>Array.isArray(n)?X(...n):g(n)),e.length==1)return e[0];const t=function(n){const s=n.span,r=Nt(s.begin.sam(),e.length),o=e[r];if(!o)return[];const i=s.begin.floor().sub(s.begin.div(e.length).floor());return o.withHapTime(a=>a.add(i)).query(n.setSpan(s.withTime(a=>a.sub(i))))};return new m(t).splitQueries()}function ee(...e){e=e.map(g);const t=function(n){const s=Math.floor(n.span.begin)%e.length;return e[s]?.query(n)||[]};return new m(t).splitQueries()}function ne(...e){return nt(...e)}function it(...e){const t=i=>Array.isArray(i)?i:[i.tactus,i];if(e=e.map(t),e.length==1){const i=g(e[0][1]);return i.tactus=e[0][0],i}const n=e.map(i=>i[0]).reduce((i,a)=>i.add(a),_(0));let s=_(0);const r=[];for(const[i,a]of e){const l=s.add(i);r.push(g(a)._compress(s.div(n),l.div(n))),s=l}const o=$(...r);return o.tactus=n,o}const Qe=it;function qa(...e){const t=e.reduce((n,[s])=>n+s,0);return e=e.map(([n,s])=>[n,s.fast(n)]),it(...e).slow(t)}function X(...e){let t=nt(...e);return e.length>1&&(t=t._fast(e.length),t.tactus=e.length),t}function U(...e){return X(...e)}function Aa(...e){e=e.map(r=>Array.isArray(r)?r.map(g):[g(r)]);const t=Et(...e.map(r=>_(r.length)));let n=[];for(let r=0;r<t;++r)n.push(...e.map(o=>o.length==0?O:o[r%o.length]));n=n.filter(r=>r.tactus>0);const s=n.reduce((r,o)=>r.add(o.tactus),_(0));return n=it(...n),n.tactus=s,n}function Ue(...e){return X(...e)}function Jt(e){return Array.isArray(e)?e.length==0?[O,0]:e.length==1?Jt(e[0]):[X(...e.map(t=>Jt(t)[0])),e.length]:[g(e),1]}const Ca=p("toTactus",function(e,t){return t.fast(_(e).div(t.tactus))});function se(e,...t){const n=t.map(r=>Jt(r));if(n.length==0)return O;e==0&&(e=n[0][1]);const s=[];for(const r of n)r[1]!=0&&(e==r[1]?s.push(r[0]):s.push(r[0]._fast(_(e).div(_(r[1])))));return $(...s)}function Ke(e,...t){return t.length==0?O:Array.isArray(t[0])?se(e,...t):jt(...t).toTactus(e)}function jt(...e){if(Array.isArray(e[0]))return se(0,...e);if(e.length==0)return O;const t=e[0].tactus,[n,...s]=e,r=$(n,...s.map(o=>o._slow(o.tactus.div(t))));return r.tactus=t,r}const Ta=C((e,t)=>g(t).mask(e)),Na=C((e,t)=>g(t).struct(e)),Sa=C((e,t)=>g(t).superimpose(...e)),Ma=C((e,t)=>g(t).set(e)),Oa=C((e,t)=>g(t).keep(e)),xa=C((e,t)=>g(t).keepif(e)),Ba=C((e,t)=>g(t).add(e)),za=C((e,t)=>g(t).sub(e)),Ea=C((e,t)=>g(t).mul(e)),Pa=C((e,t)=>g(t).div(e)),ja=C((e,t)=>g(t).mod(e)),$a=C((e,t)=>g(t).pow(e)),Ra=C((e,t)=>g(t).band(e)),Fa=C((e,t)=>g(t).bor(e)),La=C((e,t)=>g(t).bxor(e)),Ja=C((e,t)=>g(t).blshift(e)),Ia=C((e,t)=>g(t).brshift(e)),Wa=C((e,t)=>g(t).lt(e)),Ha=C((e,t)=>g(t).gt(e)),Da=C((e,t)=>g(t).lte(e)),Va=C((e,t)=>g(t).gte(e)),Ga=C((e,t)=>g(t).eq(e)),Qa=C((e,t)=>g(t).eqt(e)),Ua=C((e,t)=>g(t).ne(e)),Ka=C((e,t)=>g(t).net(e)),Za=C((e,t)=>g(t).and(e)),Xa=C((e,t)=>g(t).or(e)),Ya=C((e,t)=>g(t).func(e));function p(e,t,n=!0,s=!1){if(Array.isArray(e)){const i={};for(const a of e)i[a]=p(a,t,n);return i}const r=t.length;var o;return n?o=function(...i){i=i.map(g);const a=i[i.length-1];let l;if(r===1)l=t(a);else{const h=i.slice(0,-1);if(h.every(u=>u.__pure!=null)){const u=h.map(d=>d.__pure),f=h.filter(d=>d.__pure_loc).map(d=>d.__pure_loc);l=t(...u,a),l=l.withContext(d=>{const y=(d.locations||[]).concat(f);return{...d,locations:y}})}else{const[u,...f]=h;let d=(...y)=>t(...y,a);d=C(d,null,r-1),l=f.reduce((y,v)=>y.appLeft(v),u.fmap(d)).innerJoin()}}return s&&(l.tactus=a.tactus),l}:o=function(...i){i=i.map(g);const a=t(...i);return s&&(a.tactus=i[i.length-1].tactus),a},m.prototype[e]=function(...i){if(r===2&&i.length!==1)i=[U(...i)];else if(r!==i.length+1)throw new Error(`.${e}() expects ${r-1} inputs but got ${i.length}.`);return i=i.map(g),o(...i,this)},r>1&&(m.prototype["_"+e]=function(...i){return t(...i,this)}),C(o,null,r)}const tu=p("round",function(e){return e.asNumber().fmap(t=>Math.round(t))}),eu=p("floor",function(e){return e.asNumber().fmap(t=>Math.floor(t))}),nu=p("ceil",function(e){return e.asNumber().fmap(t=>Math.ceil(t))}),su=p("toBipolar",function(e){return e.fmap(t=>t*2-1)}),ru=p("fromBipolar",function(e){return e.fmap(t=>(t+1)/2)}),ou=p("range",function(e,t,n){return n.mul(t-e).add(e)}),iu=p("rangex",function(e,t,n){return n._range(Math.log(e),Math.log(t)).fmap(Math.exp)}),cu=p("range2",function(e,t,n){return n.fromBipolar()._range(e,t)}),au=p("ratio",e=>e.fmap(t=>Array.isArray(t)?t.slice(1).reduce((n,s)=>n/s,t[0]):t)),uu=p("compress",function(e,t,n){return e=_(e),t=_(t),e.gt(t)||e.gt(1)||t.gt(1)||e.lt(0)||t.lt(0)?O:n._fastGap(_(1).div(t.sub(e)))._late(e)}),{compressSpan:lu,compressspan:hu}=p(["compressSpan","compressspan"],function(e,t){return t._compress(e.begin,e.end)}),{fastGap:fu,fastgap:pu}=p(["fastGap","fastgap"],function(e,t){const n=function(r){const o=r.begin.sam(),i=r.begin.sub(o).mul(e).min(1),a=r.end.sub(o).mul(e).min(1);if(!(i>=1))return new j(o.add(i),o.add(a))},s=function(r){const o=r.part.begin,i=r.part.end,a=o.sam(),l=o.sub(a).div(e).min(1),h=i.sub(a).div(e).min(1),u=new j(a.add(l),a.add(h)),f=r.whole?new j(u.begin.sub(o.sub(r.whole.begin).div(e)),u.end.add(r.whole.end.sub(i).div(e))):void 0;return new z(f,u,r.value,r.context)};return t.withQuerySpanMaybe(n).withHap(s).splitQueries()}),du=p("focus",function(e,t,n){return e=_(e),t=_(t),n._fast(_(1).div(t.sub(e))).late(e.cyclePos())}),{focusSpan:mu,focusspan:yu}=p(["focusSpan","focusspan"],function(e,t){return t._focus(e.begin,e.end)}),wu=p("ply",function(e,t){const n=t.fmap(s=>K(s)._fast(e)).squeezeJoin();return n.tactus=t.tactus.mul(e),n}),{fast:gu,density:Ih}=p(["fast","density"],function(e,t){if(e===0)return O;e=_(e);const s=t.withQueryTime(r=>r.mul(e)).withHapTime(r=>r.div(e));return s.tactus=e.mul(t.tactus),s}),bu=p("hurry",function(e,t){return t._fast(e).mul(K({speed:e}))}),{slow:vu,sparsity:_u}=p(["slow","sparsity"],function(e,t){return e===0?O:t._fast(_(1).div(e))}),ku=p("inside",function(e,t,n){return t(n._slow(e))._fast(e)}),qu=p("outside",function(e,t,n){return t(n._fast(e))._slow(e)}),Au=p("lastOf",function(e,t,n){const s=Array(e-1).fill(n);return s.push(t(n)),ee(...s)}),{firstOf:Cu,every:Tu}=p(["firstOf","every"],function(e,t,n){const s=Array(e-1).fill(n);return s.unshift(t(n)),ee(...s)}),Nu=p("apply",function(e,t){return e(t)}),Su=p("cpm",function(e,t){return t._fast(e/60/1)}),Mu=p("early",function(e,t){return e=_(e),t.withQueryTime(n=>n.add(e)).withHapTime(n=>n.sub(e))},!0,!0),Ou=p("late",function(e,t){return e=_(e),t._early(_(0).sub(e))},!0,!0),xu=p("zoom",function(e,t,n){t=_(t),e=_(e);const s=t.sub(e);return n.withQuerySpan(r=>r.withCycle(o=>o.mul(s).add(e))).withHapSpan(r=>r.withCycle(o=>o.sub(e).div(s))).splitQueries()}),{zoomArc:Bu,zoomarc:zu}=p(["zoomArc","zoomarc"],function(e,t){return t.zoom(e.begin,e.end)}),Eu=p("linger",function(e,t){return e==0?O:e<0?t._zoom(e.add(1),1)._slow(e):t._zoom(0,e)._slow(e)},!0,!0),Pu=p("segment",function(e,t){return t.struct(K(!0)._fast(e)).setTactus(e)}),{invert:ju,inv:$u}=p(["invert","inv"],function(e){return e.fmap(t=>!t)},!0,!0),Ru=p("when",function(e,t,n){return e?t(n):n}),Fu=p("off",function(e,t,n){return $(n,t(n.late(e)))}),Lu=p("brak",function(e){return e.when(nt(!1,!0),t=>X(t,O)._late(.25))}),Ze=p("rev",function(e){const t=function(n){const s=n.span,r=s.begin.sam(),o=s.begin.nextSam(),i=function(l){const h=l.withTime(f=>r.add(o.sub(f))),u=h.begin;return h.begin=h.end,h.end=u,h};return e.query(n.setSpan(i(s))).map(l=>l.withSpan(i))};return new m(t).splitQueries()},!1,!0),Ju=p("pressBy",function(e,t){return t.fmap(n=>K(n).compress(e,1)).squeezeJoin()}),Iu=p("press",function(e){return e._pressBy(.5)});m.prototype.hush=function(){return O};const Wu=p("palindrome",function(e){return e.lastOf(2,Ze)},!0,!0),{juxBy:Hu,juxby:Du}=p(["juxBy","juxby"],function(e,t,n){e/=2;const s=function(i,a,l){return a in i?i[a]:l},r=n.withValue(i=>Object.assign({},i,{pan:s(i,"pan",.5)-e})),o=t(n.withValue(i=>Object.assign({},i,{pan:s(i,"pan",.5)+e})));return $(r,o).setTactus(Et(r.tactus,o.tactus))}),Vu=p("jux",function(e,t){return t._juxBy(1,e,t)}),{echoWith:Gu,echowith:Qu,stutWith:Uu,stutwith:Ku}=p(["echoWith","echowith","stutWith","stutwith"],function(e,t,n,s){return $(...Qt(0,e-1).map(r=>n(s.late(_(t).mul(r)),r)))}),Zu=p("echo",function(e,t,n,s){return s._echoWith(e,t,(r,o)=>r.gain(Math.pow(n,o)))}),Xu=p("stut",function(e,t,n,s){return s._echoWith(e,n,(r,o)=>r.gain(Math.pow(t,o)))}),re=function(e,t,n=!1){return e=_(e),nt(...Qt(0,e.sub(1)).map(s=>n?t.late(_(s).div(e)):t.early(_(s).div(e))))},Yu=p("iter",function(e,t){return re(e,t,!1)},!0,!0),{iterBack:tl,iterback:el}=p(["iterBack","iterback"],function(e,t){return re(e,t,!0)},!0,!0),{repeatCycles:nl}=p("repeatCycles",function(e,t){return nt(...Array(e).fill(t))},!0,!0),oe=function(e,t,n,s=!1,r=!1){const o=Array(e-1).fill(!1);o.unshift(!0);const i=re(e,U(...o),!s);return r||(n=n.repeatCycles(e)),n.when(i,t)},{chunk:sl,slowchunk:rl,slowChunk:ol}=p(["chunk","slowchunk","slowChunk"],function(e,t,n){return oe(e,t,n,!1,!1)}),{chunkBack:il,chunkback:cl}=p(["chunkBack","chunkback"],function(e,t,n){return oe(e,t,n,!0)}),{fastchunk:al,fastChunk:ul}=p(["fastchunk","fastChunk"],function(e,t,n){return oe(e,t,n,!1,!0)}),ll=p("bypass",function(e,t){return e=!!parseInt(e),e?O:t},!0,!0),hl=p("ribbon",(e,t,n)=>n.early(e).restart(K(1).slow(t))),fl=p("hsla",(e,t,n,s,r)=>r.color(`hsla(${e}turn,${t*100}%,${n*100}%,${s})`)),pl=p("hsl",(e,t,n,s)=>s.color(`hsl(${e}turn,${t*100}%,${n*100}%)`));m.prototype.tag=function(e){return this.withContext(t=>({...t,tags:(t.tags||[]).concat([e])}))};const dl=p("chop",function(e,t){const s=Array.from({length:e},(o,i)=>i).map(o=>({begin:o/e,end:(o+1)/e})),r=function(o){return U(s.map(i=>Object.assign({},o,i)))};return t.squeezeBind(r).setTactus(t.tactus.mul(e))}),ml=p("striate",function(e,t){const s=Array.from({length:e},(o,i)=>i).map(o=>({begin:o/e,end:(o+1)/e})),r=nt(...s);return t.set(r)._fast(e)}),Xe=function(e,t,n=.5){return t.speed(1/e*n).unit("c").slow(e)},Ye=p("slice",function(e,t,n){return e.innerBind(s=>t.outerBind(r=>n.outerBind(o=>{o=o instanceof Object?o:{s:o};const i=Array.isArray(s)?s[r]:r/s,a=Array.isArray(s)?s[r+1]:(r+1)/s;return K({begin:i,end:a,_slices:s,...o})}))).setTactus(t.tactus)},!1),yl=p("splice",function(e,t,n){const s=Ye(e,t,n);return new m(r=>{const o=r.controls._cps||1;return s.query(r).map(a=>a.withValue(l=>({speed:o/l._slices/a.whole.duration*(l.speed||1),unit:"c",...l})))}).setTactus(t.tactus)},!1),{loopAt:wl,loopat:gl}=p(["loopAt","loopat"],function(e,t){return new m(n=>Xe(e,t,n.controls._cps).query(n))}),bl=p("fit",e=>e.withHaps((t,n)=>t.map(s=>s.withValue(r=>({...r,speed:(n.controls._cps||1)/s.whole.duration,unit:"c"}))))),{loopAtCps:vl,loopatcps:_l}=p(["loopAtCps","loopatcps"],function(e,t,n){return Xe(e,n,t)}),kl=e=>K(1).withValue(()=>g(e())).innerJoin();let Ae=e=>e<.5?1:1-(e-.5)/.5,tn=(e,t,n)=>{t=g(t),e=g(e),n=g(n);let s=t.fmap(o=>({gain:Ae(o)})),r=t.fmap(o=>({gain:Ae(1-o)}));return $(e.mul(s),n.mul(r))};m.prototype.xfade=function(e,t){return tn(this,e,t)};function $t(e){let t=Array.isArray(e);e=t?e:[e];const n=e[0],s=i=>{let a;if(typeof i=="object"&&i.value!==void 0&&(a={...i},i=i.value,delete a.value),t&&Array.isArray(i)){const l=a||{};return i.forEach((h,u)=>{u<e.length&&(l[e[u]]=h)}),l}else return a?(a[n]=i,a):{[n]:i}},r=(...i)=>U(...i).withValue(s),o=function(...i){return i.length?this.set(r(...i)):this.fmap(s)};return m.prototype[n]=o,r}function c(e,...t){const n=Array.isArray(e)?e[0]:e;let s={};return s[n]=$t(e),t.forEach(r=>{s[r]=s[n],m.prototype[r]=m.prototype[n]}),s}const{s:en,sound:nn}=c(["s","n","gain"],"sound"),{source:sn,src:rn}=c("source","src"),{n:on}=c("n"),{note:cn}=c(["note","n"]),{accelerate:an}=c("accelerate"),{velocity:un}=c("velocity"),{gain:ln}=c("gain"),{postgain:hn}=c("postgain"),{amp:fn}=c("amp"),{attack:pn,att:dn}=c("attack","att"),{fmh:mn}=c(["fmh","fmi"],"fmh"),{fmi:yn,fm:wn}=c(["fmi","fmh"],"fm"),{fmenv:gn}=c("fmenv"),{fmattack:bn}=c("fmattack"),{fmdecay:vn}=c("fmdecay"),{fmsustain:_n}=c("fmsustain"),{fmrelease:kn}=c("fmrelease"),{fmvelocity:qn}=c("fmvelocity"),{bank:An}=c("bank"),{analyze:Cn}=c("analyze"),{fft:Tn}=c("fft"),{decay:Nn,dec:Sn}=c("decay","dec"),{sustain:Mn,sus:On}=c("sustain","sus"),{release:xn,rel:Bn}=c("release","rel"),{hold:zn}=c("hold"),{bandf:En,bpf:Pn,bp:jn}=c(["bandf","bandq","bpenv"],"bpf","bp"),{bandq:$n,bpq:Rn}=c("bandq","bpq"),{begin:Fn}=c("begin"),{end:Ln}=c("end"),{loop:Jn}=c("loop"),{loopBegin:In,loopb:Wn}=c("loopBegin","loopb"),{loopEnd:Hn,loope:Dn}=c("loopEnd","loope"),{crush:Vn}=c("crush"),{coarse:Gn}=c("coarse"),{channels:Qn,ch:Un}=c("channels","ch"),{phaserrate:Kn,phasr:Zn}=c("phaserrate","phasr"),{phaser:Xn,ph:Yn}=c(["phaser","phaserdepth","phasercenter","phasersweep"],"ph"),{phasersweep:ts,phs:es}=c("phasersweep","phs"),{phasercenter:ns,phc:ss}=c("phasercenter","phc"),{phaserdepth:rs,phd:os,phasdp:is}=c("phaserdepth","phd","phasdp"),{channel:cs}=c("channel"),{cut:as}=c("cut"),{cutoff:us,ctf:ls,lpf:hs,lp:fs}=c(["cutoff","resonance","lpenv"],"ctf","lpf","lp"),{lpenv:ps,lpe:ds}=c("lpenv","lpe"),{hpenv:ms,hpe:ys}=c("hpenv","hpe"),{bpenv:ws,bpe:gs}=c("bpenv","bpe"),{lpattack:bs,lpa:vs}=c("lpattack","lpa"),{hpattack:_s,hpa:ks}=c("hpattack","hpa"),{bpattack:qs,bpa:As}=c("bpattack","bpa"),{lpdecay:Cs,lpd:Ts}=c("lpdecay","lpd"),{hpdecay:Ns,hpd:Ss}=c("hpdecay","hpd"),{bpdecay:Ms,bpd:Os}=c("bpdecay","bpd"),{lpsustain:xs,lps:Bs}=c("lpsustain","lps"),{hpsustain:zs,hps:Es}=c("hpsustain","hps"),{bpsustain:Ps,bps:js}=c("bpsustain","bps"),{lprelease:$s,lpr:Rs}=c("lprelease","lpr"),{hprelease:Fs,hpr:Ls}=c("hprelease","hpr"),{bprelease:Js,bpr:Is}=c("bprelease","bpr"),{ftype:Ws}=c("ftype"),{fanchor:Hs}=c("fanchor"),{vib:Ds,vibrato:Vs,v:Gs}=c(["vib","vibmod"],"vibrato","v"),{noise:Qs}=c("noise"),{vibmod:Us,vmod:Ks}=c(["vibmod","vib"],"vmod"),{hcutoff:Zs,hpf:Xs,hp:Ys}=c(["hcutoff","hresonance","hpenv"],"hpf","hp"),{hresonance:tr,hpq:er}=c("hresonance","hpq"),{resonance:nr,lpq:sr}=c("resonance","lpq"),{djf:rr}=c("djf"),{delay:or}=c(["delay","delaytime","delayfeedback"]),{delayfeedback:ir,delayfb:cr,dfb:ar}=c("delayfeedback","delayfb","dfb"),{delaytime:ur,delayt:lr,dt:hr}=c("delaytime","delayt","dt"),{lock:fr}=c("lock"),{detune:pr,det:dr}=c("detune","det"),{unison:mr}=c("unison"),{spread:yr}=c("spread"),{dry:wr}=c("dry"),{fadeTime:gr,fadeOutTime:br}=c("fadeTime","fadeOutTime"),{fadeInTime:vr}=c("fadeInTime"),{freq:_r}=c("freq"),{pattack:kr,patt:qr}=c("pattack","patt"),{pdecay:Ar,pdec:Cr}=c("pdecay","pdec"),{psustain:Tr,psus:Nr}=c("psustain","psus"),{prelease:Sr,prel:Mr}=c("prelease","prel"),{penv:Or}=c("penv"),{pcurve:xr}=c("pcurve"),{panchor:Br}=c("panchor"),{gate:zr,gat:Er}=c("gate","gat"),{leslie:Pr}=c("leslie"),{lrate:jr}=c("lrate"),{lsize:$r}=c("lsize"),{activeLabel:Rr}=c("activeLabel"),{label:Fr}=c(["label","activeLabel"]),{degree:Lr}=c("degree"),{mtranspose:Jr}=c("mtranspose"),{ctranspose:Ir}=c("ctranspose"),{harmonic:Wr}=c("harmonic"),{stepsPerOctave:Hr}=c("stepsPerOctave"),{octaveR:Dr}=c("octaveR"),{nudge:Vr}=c("nudge"),{octave:Gr}=c("octave"),{orbit:Qr}=c("orbit"),{overgain:Ur}=c("overgain"),{overshape:Kr}=c("overshape"),{pan:Zr}=c("pan"),{panspan:Xr}=c("panspan"),{pansplay:Yr}=c("pansplay"),{panwidth:to}=c("panwidth"),{panorient:eo}=c("panorient"),{rate:no}=c("rate"),{slide:so}=c("slide"),{semitone:ro}=c("semitone"),{voice:oo}=c("voice"),{chord:io}=c("chord"),{dictionary:co,dict:ao}=c("dictionary","dict"),{anchor:uo}=c("anchor"),{offset:lo}=c("offset"),{octaves:ho}=c("octaves"),{mode:fo}=c(["mode","anchor"]),{room:po}=c(["room","size"]),{roomlp:mo,rlp:yo}=c("roomlp","rlp"),{roomdim:wo,rdim:go}=c("roomdim","rdim"),{roomfade:bo,rfade:vo}=c("roomfade","rfade"),{ir:_o,iresponse:ko}=c(["ir","i"],"iresponse"),{roomsize:qo,size:Ao,sz:Co,rsize:To}=c("roomsize","size","sz","rsize"),{shape:No}=c(["shape","shapevol"]),{distort:So,dist:Mo}=c(["distort","distortvol"],"dist"),{compressor:Oo}=c(["compressor","compressorRatio","compressorKnee","compressorAttack","compressorRelease"]),{compressorKnee:xo}=c("compressorKnee"),{compressorRatio:Bo}=c("compressorRatio"),{compressorAttack:zo}=c("compressorAttack"),{compressorRelease:Eo}=c("compressorRelease"),{speed:Po}=c("speed"),{unit:jo}=c("unit"),{squiz:$o}=c("squiz"),{vowel:Ro}=c("vowel"),{waveloss:Fo}=c("waveloss"),{density:ql}=c("density"),{expression:Lo}=c("expression"),{sustainpedal:Jo}=c("sustainpedal"),{tremolodepth:Io,tremdp:Wo}=c("tremolodepth","tremdp"),{tremolorate:Ho,tremr:Do}=c("tremolorate","tremr"),{fshift:Vo}=c("fshift"),{fshiftnote:Go}=c("fshiftnote"),{fshiftphase:Qo}=c("fshiftphase"),{triode:Uo}=c("triode"),{krush:Ko}=c("krush"),{kcutoff:Zo}=c("kcutoff"),{octer:Xo}=c("octer"),{octersub:Yo}=c("octersub"),{octersubsub:ti}=c("octersubsub"),{ring:ei}=c("ring"),{ringf:ni}=c("ringf"),{ringdf:si}=c("ringdf"),{freeze:ri}=c("freeze"),{xsdelay:oi}=c("xsdelay"),{tsdelay:ii}=c("tsdelay"),{real:ci}=c("real"),{imag:ai}=c("imag"),{enhance:ui}=c("enhance"),{partials:li}=c("partials"),{comb:hi}=c("comb"),{smear:fi}=c("smear"),{scram:pi}=c("scram"),{binshift:di}=c("binshift"),{hbrick:mi}=c("hbrick"),{lbrick:yi}=c("lbrick"),{midichan:wi}=c("midichan"),{control:gi}=c("control"),{ccn:bi}=c("ccn"),{ccv:vi}=c("ccv"),{polyTouch:_i}=c("polyTouch"),{midibend:ki}=c("midibend"),{miditouch:qi}=c("miditouch"),{ctlNum:Ai}=c("ctlNum"),{frameRate:Ci}=c("frameRate"),{frames:Ti}=c("frames"),{hours:Ni}=c("hours"),{midicmd:Si}=c("midicmd"),{minutes:Mi}=c("minutes"),{progNum:Oi}=c("progNum"),{seconds:xi}=c("seconds"),{songPtr:Bi}=c("songPtr"),{uid:zi}=c("uid"),{val:Ei}=c("val"),{cps:Pi}=c("cps"),{clip:ji,legato:$i}=c("clip","legato"),{duration:Ri,dur:Fi}=c("duration","dur"),{zrand:Li}=c("zrand"),{curve:Ji}=c("curve"),{deltaSlide:Ii}=c("deltaSlide"),{pitchJump:Wi}=c("pitchJump"),{pitchJumpTime:Hi}=c("pitchJumpTime"),{lfo:Di,repeatTime:Vi}=c("lfo","repeatTime"),{znoise:Gi}=c("znoise"),{zmod:Qi}=c("zmod"),{zcrush:Ui}=c("zcrush"),{zdelay:Ki}=c("zdelay"),{tremolo:Zi}=c("tremolo"),{zzfx:Xi}=c("zzfx"),{color:Yi,colour:tc}=c(["color","colour"]);let ie=(...e)=>e.reduce((t,n)=>Object.assign(t,{[n]:$t(n)}),{});const ec=p("adsr",(e,t)=>{e=Array.isArray(e)?e:[e];const[n,s,r,o]=e;return t.set({attack:n,decay:s,sustain:r,release:o})}),nc=p("ad",(e,t)=>{e=Array.isArray(e)?e:[e];const[n,s=n]=e;return t.attack(n).decay(s)}),sc=p("ds",(e,t)=>{e=Array.isArray(e)?e:[e];const[n,s=0]=e;return t.set({decay:n,sustain:s})}),rc=p("ar",(e,t)=>{e=Array.isArray(e)?e:[e];const[n,s=n]=e;return t.set({attack:n,release:s})}),Al=Object.freeze(Object.defineProperty({__proto__:null,accelerate:an,activeLabel:Rr,ad:nc,adsr:ec,amp:fn,analyze:Cn,anchor:uo,ar:rc,att:dn,attack:pn,bandf:En,bandq:$n,bank:An,begin:Fn,binshift:di,bp:jn,bpa:As,bpattack:qs,bpd:Os,bpdecay:Ms,bpe:gs,bpenv:ws,bpf:Pn,bpq:Rn,bpr:Is,bprelease:Js,bps:js,bpsustain:Ps,ccn:bi,ccv:vi,ch:Un,channel:cs,channels:Qn,chord:io,clip:ji,coarse:Gn,color:Yi,colour:tc,comb:hi,compressor:Oo,compressorAttack:zo,compressorKnee:xo,compressorRatio:Bo,compressorRelease:Eo,control:gi,cps:Pi,createParam:$t,createParams:ie,crush:Vn,ctf:ls,ctlNum:Ai,ctranspose:Ir,curve:Ji,cut:as,cutoff:us,dec:Sn,decay:Nn,degree:Lr,delay:or,delayfb:cr,delayfeedback:ir,delayt:lr,delaytime:ur,deltaSlide:Ii,density:ql,det:dr,detune:pr,dfb:ar,dict:ao,dictionary:co,dist:Mo,distort:So,djf:rr,dry:wr,ds:sc,dt:hr,dur:Fi,duration:Ri,end:Ln,enhance:ui,expression:Lo,fadeInTime:vr,fadeOutTime:br,fadeTime:gr,fanchor:Hs,fft:Tn,fm:wn,fmattack:bn,fmdecay:vn,fmenv:gn,fmh:mn,fmi:yn,fmrelease:kn,fmsustain:_n,fmvelocity:qn,frameRate:Ci,frames:Ti,freeze:ri,freq:_r,fshift:Vo,fshiftnote:Go,fshiftphase:Qo,ftype:Ws,gain:ln,gat:Er,gate:zr,harmonic:Wr,hbrick:mi,hcutoff:Zs,hold:zn,hours:Ni,hp:Ys,hpa:ks,hpattack:_s,hpd:Ss,hpdecay:Ns,hpe:ys,hpenv:ms,hpf:Xs,hpq:er,hpr:Ls,hprelease:Fs,hps:Es,hpsustain:zs,hresonance:tr,imag:ai,ir:_o,iresponse:ko,kcutoff:Zo,krush:Ko,label:Fr,lbrick:yi,legato:$i,leslie:Pr,lfo:Di,lock:fr,loop:Jn,loopBegin:In,loopEnd:Hn,loopb:Wn,loope:Dn,lp:fs,lpa:vs,lpattack:bs,lpd:Ts,lpdecay:Cs,lpe:ds,lpenv:ps,lpf:hs,lpq:sr,lpr:Rs,lprelease:$s,lps:Bs,lpsustain:xs,lrate:jr,lsize:$r,midibend:ki,midichan:wi,midicmd:Si,miditouch:qi,minutes:Mi,mode:fo,mtranspose:Jr,n:on,noise:Qs,note:cn,nudge:Vr,octave:Gr,octaveR:Dr,octaves:ho,octer:Xo,octersub:Yo,octersubsub:ti,offset:lo,orbit:Qr,overgain:Ur,overshape:Kr,pan:Zr,panchor:Br,panorient:eo,panspan:Xr,pansplay:Yr,panwidth:to,partials:li,patt:qr,pattack:kr,pcurve:xr,pdec:Cr,pdecay:Ar,penv:Or,ph:Yn,phasdp:is,phaser:Xn,phasercenter:ns,phaserdepth:rs,phaserrate:Kn,phasersweep:ts,phasr:Zn,phc:ss,phd:os,phs:es,pitchJump:Wi,pitchJumpTime:Hi,polyTouch:_i,postgain:hn,prel:Mr,prelease:Sr,progNum:Oi,psus:Nr,psustain:Tr,rate:no,rdim:go,real:ci,rel:Bn,release:xn,repeatTime:Vi,resonance:nr,rfade:vo,ring:ei,ringdf:si,ringf:ni,rlp:yo,room:po,roomdim:wo,roomfade:bo,roomlp:mo,roomsize:qo,rsize:To,s:en,scram:pi,seconds:xi,semitone:ro,shape:No,size:Ao,slide:so,smear:fi,songPtr:Bi,sound:nn,source:sn,speed:Po,spread:yr,squiz:$o,src:rn,stepsPerOctave:Hr,sus:On,sustain:Mn,sustainpedal:Jo,sz:Co,tremdp:Wo,tremolo:Zi,tremolodepth:Io,tremolorate:Ho,tremr:Do,triode:Uo,tsdelay:ii,uid:zi,unison:mr,unit:jo,v:Gs,val:Ei,velocity:un,vib:Ds,vibmod:Us,vibrato:Vs,vmod:Ks,voice:oo,vowel:Ro,waveloss:Fo,xsdelay:oi,zcrush:Ui,zdelay:Ki,zmod:Qi,znoise:Gi,zrand:Li,zzfx:Xi},Symbol.toStringTag,{value:"Module"})),Cl=function(e,t){const[n,s]=e,[r,o]=t,[i,a]=Zt(s,r);return[[s,n-s],[Xt((l,h)=>l.concat(h),i,o),a]]},Tl=function(e,t){const[n,s]=e,[r,o]=t,[i,a]=Zt(n,o);return[[n,s-n],[Xt((h,u)=>h.concat(u),r,i),a]]},oc=function(e,t){const[n,s]=e;return Math.min(n,s)<=1?[e,t]:oc(...n>s?Cl(e,t):Tl(e,t))},ic=function(e,t){const n=e<0;e=Math.abs(e);const s=t-e,r=Array(e).fill([1]),o=Array(s).fill([0]),i=oc([e,s],[r,o]),a=ot(i[1][0]).concat(ot(i[1][1]));return n?a.map(l=>l===0?1:0):a},ce=function(e,t,n){const s=ic(e,t);return n?ze(s,-n):s},Nl=p("euclid",function(e,t,n){return n.struct(ce(e,t,0))}),{euclidrot:Sl,euclidRot:Ml}=p(["euclidrot","euclidRot"],function(e,t,n,s){return s.struct(ce(e,t,n))}),cc=function(e,t,n,s){if(e<1)return O;const o=ce(e,t,n).join("").split("1").slice(1).map(i=>[i.length+1,!0]);return s.struct(Qe(...o))},Ol=p(["euclidLegato"],function(e,t,n){return cc(e,t,0,n)}),xl=p(["euclidLegatoRot"],function(e,t,n,s){return cc(e,t,n,s)});function ac(e,t,n=.05,s=.1,r=.1,o=globalThis.setInterval,i=globalThis.clearInterval,a=!0){let l=0,h=0,u=10**4,f=.01;const d=P=>n=P(n);r=r||s/2;const y=()=>{const P=e(),I=P+s+r;for(h===0&&(h=P+f);h<I;)h=a?Math.round(h*u)/u:h,h>=P&&t(h,n,l,P),h<P&&console.log("TOO LATE",h),h+=n,l++};let v;const b=()=>{q(),y(),v=o(y,s*1e3)},q=()=>{v!==void 0&&i(v),v=void 0};return{setDuration:d,start:b,stop:()=>{l=0,h=0,q()},pause:()=>q(),duration:n,interval:s,getPhase:()=>h,minLatency:f}}function Bl(e){return new m(t=>[new z(void 0,t.span,e)])}const ut=e=>{const t=n=>[new z(void 0,n.span,e(n.span.midpoint()))];return new m(t)},ae=ut(e=>1-e%1),uc=ae.toBipolar(),Rt=ut(e=>e%1),lc=Rt.toBipolar(),ue=ut(e=>Math.sin(Math.PI*2*e)),hc=ue.fromBipolar(),zl=hc._early(_(1).div(4)),El=ue._early(_(1).div(4)),fc=ut(e=>Math.floor(e*2%2)),Pl=fc.toBipolar(),jl=X(ae,Rt),$l=X(uc,lc),pc=ut(dt),Rl=e=>{const t=e<<13^e,n=t>>17^t;return n<<5^n},Fl=e=>e-Math.trunc(e),Ll=e=>Rl(Math.trunc(Fl(e/300)*536870912)),Jl=e=>e%536870912/536870912,It=e=>Math.abs(Jl(Ll(e))),Il=e=>Rt.range(0,e).floor().segment(e),G=ut(It),Wl=G.toBipolar(),le=e=>G.fmap(t=>t<e),Hl=e=>g(e).fmap(le).innerJoin(),Dl=le(.5),dc=e=>G.fmap(t=>Math.trunc(t*e)),Vl=e=>g(e).fmap(dc).innerJoin(),Y=function(e,t,n=!0){const s=Array.isArray(e),r=Object.keys(e).length;return e=Le(e,g),r===0?O:t.fmap(o=>{let i=o;return s&&(i=n?Math.round(i)%r:$e(Math.round(i),0,e.length-1)),e[i]})},mc=function(e,t){return Array.isArray(t)&&([t,e]=[e,t]),Gl(e,t)},Gl=p("pick",function(e,t){return Y(e,t,!1).innerJoin()}),yc=p("pickmod",function(e,t){return Y(e,t,!0).innerJoin()}),Ql=p("pickF",function(e,t,n){return n.apply(mc(e,t))}),Ul=p("pickmodF",function(e,t,n){return n.apply(yc(e,t))}),Kl=p("pickOut",function(e,t){return Y(e,t,!1).outerJoin()}),Zl=p("pickmodOut",function(e,t){return Y(e,t,!0).outerJoin()}),Xl=p("pickRestart",function(e,t){return Y(e,t,!1).restartJoin()}),Yl=p("pickmodRestart",function(e,t){return Y(e,t,!0).restartJoin()}),th=p("pickReset",function(e,t){return Y(e,t,!1).resetJoin()}),eh=p("pickmodReset",function(e,t){return Y(e,t,!0).resetJoin()}),{inhabit:nh,pickSqueeze:sh}=p(["inhabit","pickSqueeze"],function(e,t){return Y(e,t,!1).squeezeJoin()}),{inhabitmod:rh,pickmodSqueeze:oh}=p(["inhabitmod","pickmodSqueeze"],function(e,t){return Y(e,t,!0).squeezeJoin()}),ih=(e,t)=>(t=t.map(g),t.length==0?O:e.fmap(n=>{const s=Nt(Math.round(n),t.length);return t[s]}).squeezeJoin()),he=(e,t)=>(t=t.map(g),t.length==0?O:e.range(0,t.length).fmap(n=>{const s=Math.min(Math.max(Math.floor(n),0),t.length-1);return t[s]})),Ft=(e,t)=>he(e,t).outerJoin(),wc=(e,t)=>he(e,t).innerJoin(),ch=(...e)=>Ft(G,e);m.prototype.choose=function(...e){return Ft(this,e)};m.prototype.choose2=function(...e){return Ft(this.fromBipolar(),e)};const gc=(...e)=>wc(G.segment(1),e),ah=gc,bc=function(e,...t){const n=t.map(a=>g(a[0])),s=[];let r=0;for(const a of t)r+=a[1],s.push(r);const o=r,i=function(a){const l=a*o;return n[s.findIndex(h=>h>l,s)]};return e.fmap(i)},uh=(...e)=>bc(...e).outerJoin(),lh=(...e)=>uh(G,...e),vc=(...e)=>bc(G,...e).innerJoin(),hh=vc,_c=e=>{const t=e.fmap(Math.floor),n=e.fmap(o=>Math.floor(o)+1),s=o=>6*o**5-15*o**4+10*o**3,r=o=>i=>a=>i+s(o)*(a-i);return e.sub(t).fmap(r).appBoth(t.fmap(It)).appBoth(n.fmap(It))},fh=_c(pc.fmap(e=>Number(e))),ph=p("degradeByWith",(e,t,n)=>n.fmap(s=>r=>s).appLeft(e.filterValues(s=>s>t))),dh=p("degradeBy",function(e,t){return t._degradeByWith(G,e)}),mh=p("degrade",e=>e._degradeBy(.5)),yh=p("undegradeBy",function(e,t){return t._degradeByWith(G.fmap(n=>1-n),e)}),wh=p("undegrade",e=>e._undegradeBy(.5)),gh=p("sometimesBy",function(e,t,n){return g(e).fmap(s=>$(n._degradeBy(s),t(n._undegradeBy(1-s)))).innerJoin()}),bh=p("sometimes",function(e,t){return t._sometimesBy(.5,e)}),vh=p("someCyclesBy",function(e,t,n){return g(e).fmap(s=>$(n._degradeByWith(G._segment(1),s),t(n._degradeByWith(G.fmap(r=>1-r)._segment(1),1-s)))).innerJoin()}),_h=p("someCycles",function(e,t){return t._someCyclesBy(.5,e)}),kh=p("often",function(e,t){return t.sometimesBy(.75,e)}),qh=p("rarely",function(e,t){return t.sometimesBy(.25,e)}),Ah=p("almostNever",function(e,t){return t.sometimesBy(.1,e)}),Ch=p("almostAlways",function(e,t){return t.sometimesBy(.9,e)}),Th=p("never",function(e,t){return t}),Nh=p("always",function(e,t){return e(t)});let zt;try{zt=window?.speechSynthesis}catch{console.warn("cannot use window: not in browser?")}let Ce=zt?.getVoices();function Sh(e,t,n){zt.cancel();const s=new SpeechSynthesisUtterance(e);s.lang=t,Ce=zt.getVoices();const r=Ce.filter(o=>o.lang.includes(t));typeof n=="number"?s.voice=r[n%r.length]:typeof n=="string"&&(s.voice=r.find(o=>o.name===o)),speechSynthesis.speak(s)}const Mh=p("speak",function(e,t,n){return n.onTrigger((s,r)=>{Sh(r.value,e,t)})}),kc=async(...e)=>{const t=await Promise.allSettled(e),n=t.filter(s=>s.status==="fulfilled").map(s=>s.value);return t.forEach((s,r)=>{s.status==="rejected"&&console.warn(`evalScope: module with index ${r} could not be loaded:`,s.reason)}),n.forEach(s=>{Object.entries(s).forEach(([r,o])=>{globalThis[r]=o})}),n};function Oh(e,t={}){const{wrapExpression:n=!0,wrapAsync:s=!0}=t;n&&(e=`{${e}}`),s&&(e=`(async ()=>${e})()`);const r=`"use strict";return (${e})`;return Function(r)()}const qc=async(e,t)=>{let n={};if(t){const o=t(e);e=o.output,n=o}return{mode:"javascript",pattern:await Oh(e,{wrapExpression:!!t}),meta:n}};class xh{constructor({onTrigger:t,onToggle:n,getTime:s}){this.started=!1,this.cps=.5,this.lastTick=0,this.getTime=s,this.time_at_last_tick_message=0,this.num_cycles_at_cps_change=0,this.onToggle=n,this.latency=.1,this.cycle=0,this.id=Math.round(Date.now()*Math.random()),this.worker_time_dif,this.worker=new SharedWorker(new URL("/assets/clockworker-OodvW4tn.js",import.meta.url)),this.worker.port.start(),this.channel=new BroadcastChannel("strudeltick");let r=0;const o=20,i=10**3,a=(u,f,d)=>{const y=s()-(u+f)+d;if(this.worker_time_dif==null)this.worker_time_dif=y;else{const b=Math.round((this.worker_time_dif*r+y*1)/(r+1)*i)/i;b!=this.worker_time_dif&&(r=4),this.worker_time_dif=b}r=Math.min(r+1,o)},l=u=>{const{num_cycles_at_cps_change:f,cps:d,num_seconds_at_cps_change:y,num_seconds_since_cps_change:v,begin:b,end:q,tickdeadline:k,cycle:E}=u;this.cps=d,this.cycle=E,a(y,v,k),h(b,q,f,y),this.time_at_last_tick_message=this.getTime()},h=(u,f,d,y)=>{if(this.started===!1)return;this.pattern.queryArc(u,f,{_cps:this.cps}).forEach(b=>{if(b.hasOnset()){const q=(b.whole.begin-d)/this.cps+y+this.latency+this.worker_time_dif,k=b.duration/this.cps;t?.(b,0,k,this.cps,q)}})};this.channel.onmessage=u=>{if(!this.started)return;const{payload:f,type:d}=u.data;switch(d){case"tick":l(f)}}}sendMessage(t,n){this.worker.port.postMessage({type:t,payload:n,id:this.id})}now(){const t=(this.getTime()-this.time_at_last_tick_message)*this.cps;return this.cycle+t}setCps(t=1){this.sendMessage("cpschange",{cps:t})}setCycle(t){this.sendMessage("setcycle",{cycle:t})}setStarted(t){this.sendMessage("toggle",{started:t}),this.started=t,this.onToggle?.(t)}start(){F("[cyclist] start"),this.setStarted(!0)}stop(){this.worker_time_dif=null,F("[cyclist] stop"),this.setStarted(!1)}setPattern(t,n=!1){this.pattern=t,n&&!this.started&&this.start()}log(t,n,s){const r=s.filter(o=>o.hasOnset());console.log(`${t.toFixed(4)} - ${n.toFixed(4)} ${Array(r.length).fill("I").join("")}`)}}class Ac{constructor({interval:t,onTrigger:n,onToggle:s,onError:r,getTime:o,latency:i=.1,setInterval:a,clearInterval:l}){this.started=!1,this.cps=.5,this.num_ticks_since_cps_change=0,this.lastTick=0,this.lastBegin=0,this.lastEnd=0,this.getTime=o,this.num_cycles_at_cps_change=0,this.seconds_at_cps_change,this.onToggle=s,this.latency=i,this.clock=ac(o,(h,u,f,d)=>{this.num_ticks_since_cps_change===0&&(this.num_cycles_at_cps_change=this.lastEnd,this.seconds_at_cps_change=h),this.num_ticks_since_cps_change++;const v=this.num_ticks_since_cps_change*u*this.cps;try{const b=this.lastEnd;this.lastBegin=b;const q=this.num_cycles_at_cps_change+v;this.lastEnd=q;const k=this.pattern.queryArc(b,q,{_cps:this.cps});this.lastTick=h,k.forEach(E=>{if(E.hasOnset()){const R=(E.whole.begin-this.num_cycles_at_cps_change)/this.cps+this.seconds_at_cps_change+i,P=E.duration/this.cps,I=R-h;n?.(E,I,P,this.cps,R)}})}catch(b){F(`[cyclist] error: ${b.message}`),r?.(b)}},t,.1,.1,a,l)}now(){if(!this.started)return 0;const t=this.getTime()-this.lastTick-this.clock.duration;return this.lastBegin+t*this.cps}setStarted(t){this.started=t,this.onToggle?.(t)}start(){if(this.num_ticks_since_cps_change=0,this.num_cycles_at_cps_change=0,!this.pattern)throw new Error("Scheduler: no pattern set! call .setPattern first.");F("[cyclist] start"),this.clock.start(),this.setStarted(!0),globalThis.haps_from_outputs=null}pause(){F("[cyclist] pause"),this.clock.pause(),this.setStarted(!1)}stop(){F("[cyclist] stop"),this.clock.stop(),this.lastEnd=0,this.setStarted(!1)}setPattern(t,n=!1){this.pattern=t,n&&!this.started&&this.start()}setCps(t=.5){this.cps!==t&&(this.cps=t,this.num_ticks_since_cps_change=0)}log(t,n,s){const r=s.filter(o=>o.hasOnset());console.log(`${t.toFixed(4)} - ${n.toFixed(4)} ${Array(r.length).fill("I").join("")}`)}}let Wt;function Ht(){if(!Wt)throw new Error("no time set! use setTime to define a time source");return Wt()}function Cc(e){Wt=e}function Bh({defaultOutput:e,onEvalError:t,beforeEval:n,afterEval:s,getTime:r,transpiler:o,onToggle:i,editPattern:a,onUpdateState:l,sync:h=!1,setInterval:u,clearInterval:f}){const d={schedulerError:void 0,evalError:void 0,code:"// LOADING",activeCode:"// LOADING",pattern:void 0,miniLocations:[],widgets:[],pending:!1,started:!1},y=A=>{Object.assign(d,A),d.isDirty=d.code!==d.activeCode,d.error=d.evalError||d.schedulerError,l?.(d)},v={onTrigger:Tc({defaultOutput:e,getTime:r}),getTime:r,onToggle:A=>{y({started:A}),i?.(A)},setInterval:u,clearInterval:f},b=h&&typeof SharedWorker<"u"?new xh(v):new Ac(v);let q={},k;const E=function(){return q={},k=void 0,O},R=(A,N=!0)=>{A=a?.(A)||A,b.setPattern(A,N)};Cc(()=>b.now());const P=()=>b.stop(),I=()=>b.start(),st=()=>b.pause(),vt=()=>b.toggle(),rt=A=>b.setCps(A),lt=A=>b.setCps(A/60),T=function(A){return k=A,O},ct=()=>{m.prototype.p=function(N){return q[N]=this,this},m.prototype.q=function(N){return O};try{for(let N=1;N<10;++N)Object.defineProperty(m.prototype,`d${N}`,{get(){return this.p(N)},configurable:!0}),Object.defineProperty(m.prototype,`p${N}`,{get(){return this.p(N)},configurable:!0}),m.prototype[`q${N}`]=O}catch(N){console.warn("injectPatternMethods: error:",N)}const A=p("cpm",function(N,Z){return Z._fast(N/60/b.cps)});return kc({all:T,hush:E,cpm:A,setCps:rt,setcps:rt,setCpm:lt,setcpm:lt})};return{scheduler:b,evaluate:async(A,N=!0,Z=!0)=>{if(!A)throw new Error("no code to evaluate");try{y({code:A,pending:!0}),await ct(),await n?.({code:A}),Z&&E();let{pattern:x,meta:Q}=await qc(A,o);if(Object.keys(q).length&&(x=$(...Object.values(q))),k&&(x=k(x)),!Yt(x)){const ht=`got "${typeof evaluated}" instead of pattern`;throw new Error(ht+(typeof evaluated=="function"?", did you forget to call a function?":"."))}return F("[eval] code updated"),R(x,N),y({miniLocations:Q?.miniLocations||[],widgets:Q?.widgets||[],activeCode:A,pattern:x,evalError:void 0,schedulerError:void 0,pending:!1}),s?.({code:A,pattern:x,meta:Q}),x}catch(x){F(`[eval] error: ${x.message}`,"error"),y({evalError:x,pending:!1}),t?.(x)}},start:I,stop:P,pause:st,setCps:rt,setPattern:R,setCode:A=>y({code:A}),toggle:vt,state:d}}const Tc=({getTime:e,defaultOutput:t})=>async(n,s,r,o,i)=>{try{(!n.context.onTrigger||!n.context.dominantTrigger)&&await t(n,s,r,o,i),n.context.onTrigger&&await n.context.onTrigger(e()+s,n,e(),o,i)}catch(a){F(`[cyclist] error: ${a.message}`,"error")}},zh=function(e,t={}){const n=document.getElementById("code"),s="background-image:url("+e+");background-size:contain;";n.style=s;const{className:r}=n,o=(l,h)=>{({style:()=>n.style=s+";"+h,className:()=>n.className=h+" "+r})[l]()},i=Object.entries(t).filter(([l,h])=>typeof h=="function");Object.entries(t).filter(([l,h])=>typeof h=="string").forEach(([l,h])=>o(l,h)),i.length},Eh=()=>{const e=document.getElementById("code");e&&(e.style="")};F("🌀 @strudel/core loaded 🌀");globalThis._strudelLoaded&&console.warn(`@strudel/core was loaded more than once...
This might happen when you have multiple versions of strudel installed. 
Please check with "npm ls @strudel/core".`);globalThis._strudelLoaded=!0;const Wh=Object.freeze(Object.defineProperty({__proto__:null,Cyclist:Ac,Fraction:_,Hap:z,Pattern:m,State:yt,TimeSpan:j,__chooseWith:he,_brandBy:le,_irand:dc,_mod:Nt,_polymeterListSteps:se,accelerate:an,activeLabel:Rr,ad:nc,add:Ba,adsr:ec,almostAlways:Ch,almostNever:Ah,always:Nh,amp:fn,analyze:Cn,anchor:uo,and:Za,apply:Nu,ar:rc,arrange:qa,att:dn,attack:pn,backgroundImage:zh,band:Ra,bandf:En,bandq:$n,bank:An,base64ToUnicode:Fe,begin:Fn,binshift:di,bjork:ic,blshift:Ja,bor:Fa,bp:jn,bpa:As,bpattack:qs,bpd:Os,bpdecay:Ms,bpe:gs,bpenv:ws,bpf:Pn,bpq:Rn,bpr:Is,bprelease:Js,bps:js,bpsustain:Ps,brak:Lu,brand:Dl,brandBy:Hl,brshift:Ia,bxor:La,bypass:ll,cat:ne,ccn:bi,ccv:vi,ceil:nu,ch:Un,channel:cs,channels:Qn,choose:ch,chooseCycles:gc,chooseInWith:wc,chooseWith:Ft,chop:dl,chord:io,chunk:sl,chunkBack:il,chunkback:cl,clamp:$e,cleanupUi:Eh,clip:ji,coarse:Gn,code2hash:da,color:Yi,colour:tc,comb:hi,compose:ra,compress:uu,compressSpan:lu,compressor:Oo,compressorAttack:zo,compressorKnee:xo,compressorRatio:Bo,compressorRelease:Eo,compressspan:hu,constant:oa,control:gi,controls:Al,cosine:zl,cosine2:El,cpm:Su,cps:Pi,createClock:ac,createParam:$t,createParams:ie,crush:Vn,ctf:ls,ctlNum:Ai,ctranspose:Ir,curry:C,curve:Ji,cut:as,cutoff:us,dec:Sn,decay:Nn,degrade:mh,degradeBy:dh,degradeByWith:ph,degree:Lr,delay:or,delayfb:cr,delayfeedback:ir,delayt:lr,delaytime:ur,deltaSlide:Ii,det:dr,detune:pr,dfb:ar,dict:ao,dictionary:co,dist:Mo,distort:So,div:Pa,djf:rr,drawLine:Je,dry:wr,ds:sc,dt:hr,dur:Fi,duration:Ri,early:Mu,echo:Zu,echoWith:Gu,echowith:Qu,end:Ln,enhance:ui,eq:Ga,eqt:Qa,euclid:Nl,euclidLegato:Ol,euclidLegatoRot:xl,euclidRot:Ml,euclidrot:Sl,evalScope:kc,evaluate:qc,every:Tu,expression:Lo,fadeInTime:vr,fadeOutTime:br,fadeTime:gr,fanchor:Hs,fast:gu,fastChunk:ul,fastGap:fu,fastcat:X,fastchunk:al,fastgap:pu,fft:Tn,firstOf:Cu,fit:bl,flatten:ot,floor:eu,fm:wn,fmattack:bn,fmdecay:vn,fmenv:gn,fmh:mn,fmi:yn,fmrelease:kn,fmsustain:_n,fmvelocity:qn,focus:du,focusSpan:mu,focusspan:yu,fractionalArgs:ia,frameRate:Ci,frames:Ti,freeze:ri,freq:_r,freqToMidi:Gt,fromBipolar:ru,fshift:Vo,fshiftnote:Go,fshiftphase:Qo,ftype:Ws,func:Ya,gain:ln,gap:bt,gat:Er,gate:zr,getFreq:xe,getFrequency:sa,getPlayableNoteValue:na,getSoundIndex:ea,getTime:Ht,getTrigger:Tc,gt:Ha,gte:Va,harmonic:Wr,hash2code:ma,hbrick:mi,hcutoff:Zs,hold:zn,hours:Ni,hp:Ys,hpa:ks,hpattack:_s,hpd:Ss,hpdecay:Ns,hpe:ys,hpenv:ms,hpf:Xs,hpq:er,hpr:Ls,hprelease:Fs,hps:Es,hpsustain:zs,hresonance:tr,hsl:pl,hsla:fl,hurry:bu,id:dt,imag:ai,inhabit:nh,inhabitmod:rh,inside:ku,inv:$u,invert:ju,ir:_o,irand:Vl,iresponse:ko,isNote:Pt,isNoteWithOctave:Uc,isPattern:Yt,isaw:ae,isaw2:uc,iter:Yu,iterBack:tl,iterback:el,jux:Vu,juxBy:Hu,juxby:Du,kcutoff:Zo,keep:Oa,keepif:xa,krush:Ko,label:Fr,lastOf:Au,late:Ou,lbrick:yi,legato:$i,leslie:Pr,lfo:Di,linger:Eu,listRange:Qt,lock:fr,logKey:Vt,logger:F,loop:Jn,loopAt:wl,loopAtCps:vl,loopBegin:In,loopEnd:Hn,loopat:gl,loopatcps:_l,loopb:Wn,loope:Dn,lp:fs,lpa:vs,lpattack:bs,lpd:Ts,lpdecay:Cs,lpe:ds,lpenv:ps,lpf:hs,lpq:sr,lpr:Rs,lprelease:$s,lps:Bs,lpsustain:xs,lrate:jr,lsize:$r,lt:Wa,lte:Da,mapArgs:Kt,mask:Ta,midi2note:ta,midiToFreq:wt,midibend:ki,midichan:wi,midicmd:Si,miditouch:qi,minutes:Mi,mod:ja,mode:fo,mtranspose:Jr,mul:Ea,n:on,nanFallback:Be,ne:Ua,net:Ka,never:Th,noise:Qs,note:cn,noteToMidi:gt,nothing:_a,nudge:Vr,numeralArgs:V,objectMap:Le,octave:Gr,octaveR:Dr,octaves:ho,octer:Xo,octersub:Yo,octersubsub:ti,off:Fu,offset:lo,often:kh,or:Xa,orbit:Qr,outside:qu,overgain:Ur,overshape:Kr,palindrome:Wu,pan:Zr,panchor:Br,panorient:eo,panspan:Xr,pansplay:Yr,panwidth:to,parseFractional:je,parseNumeral:Ut,partials:li,patt:qr,pattack:kr,pcurve:xr,pdec:Cr,pdecay:Ar,penv:Or,perlin:fh,perlinWith:_c,ph:Yn,phasdp:is,phaser:Xn,phasercenter:ns,phaserdepth:rs,phaserrate:Kn,phasersweep:ts,phasr:Zn,phc:ss,phd:os,phs:es,pick:mc,pickF:Ql,pickOut:Kl,pickReset:th,pickRestart:Xl,pickSqueeze:sh,pickmod:yc,pickmodF:Ul,pickmodOut:Zl,pickmodReset:eh,pickmodRestart:Yl,pickmodSqueeze:oh,pipe:Ee,pitchJump:Wi,pitchJumpTime:Hi,ply:wu,pm:He,polyTouch:_i,polymeter:jt,polymeterSteps:Ke,polyrhythm:Ie,postgain:hn,pow:$a,pr:We,prel:Mr,prelease:Sr,press:Iu,pressBy:Ju,progNum:Oi,psus:Nr,psustain:Tr,pure:K,rand:G,rand2:Wl,randcat:ah,range:ou,range2:cu,rangex:iu,rarely:qh,rate:no,ratio:au,rdim:go,real:ci,ref:kl,register:p,reify:g,rel:Bn,release:xn,removeUndefineds:Pe,repeatCycles:nl,repeatTime:Vi,repl:Bh,resonance:nr,rev:Ze,rfade:vo,ribbon:hl,ring:ei,ringdf:si,ringf:ni,rlp:yo,room:po,roomdim:wo,roomfade:bo,roomlp:mo,roomsize:qo,rotate:ze,round:tu,rsize:To,run:Il,s:en,saw:Rt,saw2:lc,scram:pi,seconds:xi,segment:Pu,semitone:ro,seq:Ue,sequence:U,set:Ma,setStringParser:wa,setTime:Cc,shape:No,signal:ut,silence:O,sine:hc,sine2:ue,size:Ao,slice:Ye,slide:so,slow:vu,slowChunk:ol,slowcat:nt,slowcatPrime:ee,slowchunk:rl,smear:fi,sol2note:pa,someCycles:_h,someCyclesBy:vh,sometimes:bh,sometimesBy:gh,songPtr:Bi,sound:nn,source:sn,sparsity:_u,speak:Mh,speed:Po,splice:yl,splitAt:Zt,spread:yr,square:fc,square2:Pl,squeeze:ih,squiz:$o,src:rn,stack:$,stackBy:ka,stackCentre:Ge,stackLeft:De,stackRight:Ve,steady:Bl,stepcat:Aa,stepsPerOctave:Hr,striate:ml,struct:Na,stut:Xu,stutWith:Uu,stutwith:Ku,sub:za,superimpose:Sa,sus:On,sustain:Mn,sustainpedal:Jo,sz:Co,time:pc,timeCat:Qe,timecat:it,toBipolar:su,toTactus:Ca,tokenizeNote:Oe,tremdp:Wo,tremolo:Zi,tremolodepth:Io,tremolorate:Ho,tremr:Do,tri:jl,tri2:$l,triode:Uo,tsdelay:ii,uid:zi,undegrade:wh,undegradeBy:yh,unicodeToBase64:Re,unison:mr,unit:jo,v:Gs,val:Ei,valueToMidi:Xc,velocity:un,vib:Ds,vibmod:Us,vibrato:Vs,vmod:Ks,voice:oo,vowel:Ro,waveloss:Fo,wchoose:lh,wchooseCycles:vc,when:Ru,wrandcat:hh,xfade:tn,xsdelay:oi,zcrush:Ui,zdelay:Ki,zipWith:Xt,zmod:Qi,znoise:Gi,zoom:xu,zoomArc:Bu,zoomarc:zu,zrand:Li,zzfx:Xi},Symbol.toStringTag,{value:"Module"})),fe=(e="test-canvas",t)=>{let{contextType:n="2d",pixelated:s=!1,pixelRatio:r=window.devicePixelRatio}=t||{},o=document.querySelector("#"+e);if(!o){o=document.createElement("canvas"),o.id=e,o.width=window.innerWidth*r,o.height=window.innerHeight*r,o.style="pointer-events:none;width:100%;height:100%;position:fixed;top:0;left:0",s&&(o.style.imageRendering="pixelated"),document.body.prepend(o);let i;window.addEventListener("resize",()=>{i&&clearTimeout(i),i=setTimeout(()=>{o.width=window.innerWidth*r,o.height=window.innerHeight*r},200)})}return o.getContext(n)};let mt={};function Nc(e){mt[e]!==void 0&&(cancelAnimationFrame(mt[e]),delete mt[e])}function Ph(){Object.keys(mt).forEach(e=>Nc(e))}let et={};m.prototype.draw=function(e,t){if(typeof window>"u")return this;let{id:n=1,lookbehind:s=0,lookahead:r=0}=t,o=Math.max(Ht(),0);Nc(n),s=Math.abs(s),et[n]=(et[n]||[]).filter(h=>!h.isInFuture(o));let i=this.queryArc(o,o+r).filter(h=>h.hasOnset());et[n]=et[n].concat(i);let a;const l=()=>{const h=Ht(),u=h+r;et[n]=et[n].filter(y=>y.isInNearPast(s,h));let f=Math.max(a||u,u-1/10);const d=this.queryArc(f,u).filter(y=>y.hasOnset());et[n]=et[n].concat(d),a=u,e(et[n],h,u,this),mt[n]=requestAnimationFrame(l)};return mt[n]=requestAnimationFrame(l),this};const Hh=(e=!0)=>{const t=fe();e&&t.clearRect(0,0,t.canvas.width,t.canvas.width),Ph(),window.strudelScheduler&&clearInterval(window.strudelScheduler)};m.prototype.onPaint=function(){return console.warn("[draw] onPaint was not overloaded. Some drawings might not work"),this};class jh{constructor(t,n){this.onFrame=t,this.onError=n}start(){const t=this;let n=requestAnimationFrame(function s(r){try{t.onFrame(r)}catch(o){t.onError(o)}n=requestAnimationFrame(s)});t.cancel=()=>{cancelAnimationFrame(n)}}stop(){this.cancel&&this.cancel()}}class Dh{constructor(t,n){this.visibleHaps=[],this.lastFrame=null,this.drawTime=n,this.framer=new jh(()=>{if(!this.scheduler){console.warn("Drawer: no scheduler");return}const s=Math.abs(this.drawTime[0]),r=this.drawTime[1],o=this.scheduler.now()+r;if(this.lastFrame===null){this.lastFrame=o;return}const i=this.scheduler.pattern.queryArc(Math.max(this.lastFrame,o-1/10),o);this.lastFrame=o,this.visibleHaps=(this.visibleHaps||[]).filter(l=>l.endClipped>=o-s-r).concat(i.filter(l=>l.hasOnset()));const a=o-r;t(this.visibleHaps,a,this)},s=>{console.warn("draw error",s)})}setDrawTime(t){this.drawTime=t}invalidate(t=this.scheduler,n){if(!t)return;n=n??t.now(),this.scheduler=t;let[s,r]=this.drawTime;const[o,i]=[Math.max(n,0),n+r+.1];this.visibleHaps=this.visibleHaps.filter(l=>l.whole.begin<n);const a=t.pattern.queryArc(o,i);this.visibleHaps=this.visibleHaps.concat(a)}start(t){this.scheduler=t,this.invalidate(),this.framer.start()}stop(){this.framer&&this.framer.stop()}}function Vh(e){return typeof window>"u"?"#fff":getComputedStyle(document.documentElement).getPropertyValue(e)}let Sc={};function Tt(){return Sc}function Gh(e){Sc=e}let Te="#22222210";m.prototype.animate=function({callback:e,sync:t=!1,smear:n=.5}={}){window.frame&&cancelAnimationFrame(window.frame);const s=fe();let{clientWidth:r,clientHeight:o}=s.canvas;r*=window.devicePixelRatio,o*=window.devicePixelRatio;let i=n===0?"99":Number((1-n)*100).toFixed(0);i=i.length===1?`0${i}`:i,Te=`#200010${i}`;const a=l=>{let h;l=Math.round(l),h=this.slow(1e3).queryArc(l,l),s.fillStyle=Te,s.fillRect(0,0,r,o),h.forEach(u=>{let{x:f,y:d,w:y,h:v,s:b,r:q,angle:k=0,fill:E="darkseagreen"}=u.value;if(y*=r,v*=o,q!==void 0&&k!==void 0){const P=k*2*Math.PI,[I,st]=[(r-y)/2,(o-v)/2];f=I+Math.cos(P)*q*I,d=st+Math.sin(P)*q*st}else f*=r-y,d*=o-v;const R={...u.value,x:f,y:d,w:y,h:v};s.fillStyle=E,b==="rect"?s.fillRect(f,d,y,v):b==="ellipse"&&(s.beginPath(),s.ellipse(f+y/2,d+v/2,y/2,v/2,0,0,2*Math.PI),s.fill()),e&&e(s,R,u)}),window.frame=requestAnimationFrame(a)};return window.frame=requestAnimationFrame(a),O};const{x:Mc,y:Qh,w:Uh,h:Kh,angle:Zh,r:Xh,fill:Yh,smear:tf}=ie("x","y","w","h","angle","r","fill","smear"),ef=p("rescale",function(e,t){return t.mul(Mc(e).w(e).y(e).h(e))}),nf=p("moveXY",function(e,t,n){return n.add(Mc(e).y(t))}),sf=p("zoomIn",function(e,t){const n=K(1).sub(e).div(2);return t.rescale(e).move(n,n)}),Ct=(e,t,n)=>e*(n-t)+t,Ne=e=>{let{value:t}=e;typeof e.value!="object"&&(t={value:t});let{note:n,n:s,freq:r,s:o}=t;if(r)return Gt(r);if(n=n??s,typeof n=="string")try{return gt(n)}catch{return 0}return typeof n=="number"?n:o?"_"+o:t};m.prototype.pianoroll=function(e={}){let{cycles:t=4,playhead:n=.5,overscan:s=0,hideNegative:r=!1,ctx:o=fe(),id:i=1}=e,a=-t*n,l=t*(1-n);const h=(u,f)=>(!r||u.whole.begin>=0)&&u.isWithinTime(f+a,f+l);return this.draw((u,f)=>{pe({...e,time:f,ctx:o,haps:u.filter(d=>h(d,f))})},{lookbehind:a-s,lookahead:l+s,id:i}),this};function pe({time:e,haps:t,cycles:n=4,playhead:s=.5,flipTime:r=0,flipValues:o=0,hideNegative:i=!1,inactive:a=Tt().foreground,active:l=Tt().foreground,background:h="transparent",smear:u=0,playheadColor:f="white",minMidi:d=10,maxMidi:y=90,autorange:v=0,timeframe:b,fold:q=0,vertical:k=0,labels:E=!1,fill:R=1,fillActive:P=!1,strokeActive:I=!0,stroke:st,hideInactive:vt=0,colorizeInactive:rt=1,fontFamily:lt,ctx:T,id:ct}={}){const J=T.canvas.width,at=T.canvas.height;let A=-n*s,N=n*(1-s);ct&&(t=t.filter(B=>B.hasTag(ct))),b&&(console.warn("timeframe is deprecated! use from/to instead"),A=0,N=b);const Z=k?at:J,x=k?J:at;let Q=k?[Z,0]:[0,Z];const ht=N-A,de=k?[0,x]:[x,0];let St=y-d+1,ft=x/St,Mt=[];r&&Q.reverse(),o&&de.reverse();const{min:xc,max:Bc,values:zc}=t.reduce(({min:B,max:W,values:_t},kt)=>{const H=Ne(kt);return{min:H<B?H:B,max:H>W?H:W,values:_t.includes(H)?_t:[..._t,H]}},{min:1/0,max:-1/0,values:[]});v&&(d=xc,y=Bc,St=y-d+1),Mt=zc.sort((B,W)=>typeof B=="number"&&typeof W=="number"?B-W:typeof B=="number"?1:String(B).localeCompare(String(W))),ft=q?x/Mt.length:x/St,T.fillStyle=h,T.globalAlpha=1,u||(T.clearRect(0,0,J,at),T.fillRect(0,0,J,at)),t.forEach(B=>{const W=B.whole.begin<=e&&B.endClipped>e;let _t=st??(I&&W),kt=!W&&R||W&&P;if(vt&&!W)return;let H=B.value?.color;l=H||l,a=rt&&H||a,H=W?l:a,T.fillStyle=kt?H:"transparent",T.strokeStyle=H;const{velocity:Ec=1,gain:Pc=1}=B.value||{};T.globalAlpha=Ec*Pc;const jc=(B.whole.begin-(r?N:A))/ht,me=Ct(jc,...Q);let qt=Ct(B.duration/ht,0,Z);const ye=Ne(B),$c=q?Mt.indexOf(ye)/Mt.length:(Number(ye)-d)/St,we=Ct($c,...de);let ge=0;const be=Ct(e/ht,...Q);let At;if(k?At=[we+1-(o?ft:0),Z-be+me+ge+1-(r?0:qt),ft-2,qt-2]:At=[me-be+ge+1-(r?qt:0),we+1-(o?0:ft),qt-2,ft-2],_t&&T.strokeRect(...At),kt&&T.fillRect(...At),E){const Rc=B.value.note??B.value.s+(B.value.n?`:${B.value.n}`:""),{label:ve,activeLabel:Fc}=B.value,Lc=(W&&Fc||ve)??Rc;let Jc=k?qt:ft*.75;T.font=`${Jc}px ${lt||"monospace"}`,T.fillStyle=kt?"black":H,T.textBaseline="top",T.fillText(Lc,...At)}}),T.globalAlpha=1;const Ot=Ct(-A/ht,...Q);return T.strokeStyle=f,T.beginPath(),k?(T.moveTo(0,Ot),T.lineTo(x,Ot)):(T.moveTo(Ot,0),T.lineTo(Ot,x)),T.stroke(),this}function Oc(e,t={}){let[n,s]=e;n=Math.abs(n);const r=s+n,o=n/r;return{fold:1,...t,cycles:r,playhead:o}}const $h=(e={})=>(t,n,s,r)=>pe({ctx:t,time:n,haps:s,...Oc(r,e)});m.prototype.punchcard=function(e){return this.onPaint($h(e))};m.prototype.wordfall=function(e){return this.punchcard({vertical:1,labels:1,stroke:0,fillActive:1,active:"white",...e})};function rf(e){const{drawTime:t,...n}=e;pe({...Oc(t),...n})}function Rh(e,t,n,s){const r=(e-90)*Math.PI/180;return[n+Math.cos(r)*t,s+Math.sin(r)*t]}const Se=(e,t,n,s,r=0)=>Rh((e+r)*360,t*e,n,s);function Me(e){let{ctx:t,from:n=0,to:s=3,margin:r=50,cx:o=100,cy:i=100,rotate:a=0,thickness:l=r/2,color:h=Tt().foreground,cap:u="round",stretch:f=1,fromOpacity:d=1,toOpacity:y=1}=e;n*=f,s*=f,a*=f,t.lineWidth=l,t.lineCap=u,t.strokeStyle=h,t.globalAlpha=d,t.beginPath();let[v,b]=Se(n,r,o,i,a);t.moveTo(v,b);const q=1/60;let k=n;for(;k<=s;){const[E,R]=Se(k,r,o,i,a);t.globalAlpha=(k-n)/(s-n)*y,t.lineTo(E,R),k+=q}t.stroke()}function Fh(e){let{stretch:t=1,size:n=80,thickness:s=n/2,cap:r="butt",inset:o=3,playheadColor:i="#ffffff",playheadLength:a=.02,playheadThickness:l=s,padding:h=0,steady:u=1,activeColor:f=Tt().foreground,inactiveColor:d=Tt().gutterForeground,colorizeInactive:y=0,fade:v=!0,ctx:b,time:q,haps:k,drawTime:E,id:R}=e;R&&(k=k.filter(J=>J.hasTag(R)));const[P,I]=[b.canvas.width,b.canvas.height];b.clearRect(0,0,P*2,I*2);const[st,vt]=[P/2,I/2],rt={margin:n/t,cx:st,cy:vt,stretch:t,cap:r,thickness:s},lt={...rt,thickness:l,from:o-a,to:o,color:i},[T]=E,ct=u*q;k.forEach(J=>{const at=J.whole.begin<=q&&J.endClipped>q,A=J.whole.begin-q+o,N=J.endClipped-q+o-h,Z=J.value?.color||f,x=y||at?Z:d,Q=v?1-Math.abs((J.whole.begin-q)/T):1;Me({ctx:b,...rt,from:A,to:N,rotate:ct,color:x,fromOpacity:Q,toOpacity:Q})}),Me({ctx:b,...lt,rotate:ct})}m.prototype.spiral=function(e={}){return this.onPaint((t,n,s,r)=>Fh({ctx:t,time:n,haps:s,drawTime:r,...e}))};let L=[],Lh=(e,t)=>{let n=[],s={get(){return s.lc||s.listen(()=>{})(),s.value},l:t||0,lc:0,listen(r,o){return s.lc=n.push(r,o||s.l)/2,()=>{let i=n.indexOf(r);~i&&(n.splice(i,2),--s.lc||s.off())}},notify(r){let o=!L.length;for(let i=0;i<n.length;i+=2)L.push(n[i],n[i+1],s.value,r);if(o){for(let i=0;i<L.length;i+=4){let a;for(let l=i+1;!a&&(l+=4)<L.length;)L[l]<L[i+1]&&(a=L.push(L[i],L[i+1],L[i+2],L[i+3]));a||L[i](L[i+2],L[i+3])}L.length=0}},off(){},set(r){s.value!==r&&(s.value=r,s.notify())},subscribe(r,o){let i=s.listen(r,o);return r(s.value),i},value:e};return s},of=(e={})=>{let t=Lh(e);return t.setKey=function(n,s){typeof s>"u"?n in t.value&&(t.value={...t.value},delete t.value[n],t.notify(n)):t.value[n]!==s&&(t.value={...t.value,[n]:s},t.notify(n))},t};export{g as $,F as A,kl as B,p as C,Dh as D,sa as E,jh as F,ea as G,Gt as H,na as I,of as J,Wh as K,Ac as L,Tc as M,$e as N,Pt as O,m as P,K as Q,O as R,$ as S,_ as T,Qe as U,Et as V,U as W,X,wc as Y,G as Z,Nt as _,Zh as a,wa as a0,ot as a1,Lh as a2,Bh as a3,da as a4,Xc as a5,kc as a6,ma as a7,ef as b,Hh as c,Vh as d,Tt as e,Yh as f,fe as g,Kh as h,Gh as i,Oc as j,$h as k,rf as l,nf as m,Po as n,No as o,pe as p,gt as q,Xh as r,tf as s,Ut as t,ta as u,Yt as v,Uh as w,Mc as x,Qh as y,sf as z};
//# sourceMappingURL=index.DeKTR5mX.js.map
