import{_ as se}from"./settings.ceb8da38.js";import{n as U,P as V,v as X}from"./index.7dcdd514.js";import{z as q,E as re,f as E,r as L,t as N,F as H,u as ie,q as ce,G as Y}from"./scope.efc95823.js";const I={},G={},Le=e=>I[e];function fe(e,t){var n=t?1e3:1024;if(e<n)return e+" B";var o=t?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],a=-1;do e/=n,++a;while(e>=n);return e.toFixed(1)+" "+o[a]}const ue=async(e,t,n,o,a,r,s)=>{let i=0;a!==void 0&&n!==void 0&&q("[sampler] hap has note and freq. ignoring note","warning");let c=re({freq:a,note:n},36);i=c-36;const f=E();let h;if(Array.isArray(r))h=r[t%r.length];else{const v=l=>H(l)-c,y=Object.keys(r).filter(l=>!l.startsWith("_")).reduce((l,j,S)=>!l||Math.abs(v(j))<Math.abs(v(l))?j:l,null);i=-v(y),h=r[y][t%r[y].length]}s&&(h=await s(h));let b=await K(h,f,e,t);o<0&&(b=le(b));const d=f.createBufferSource();d.buffer=b;const B=1*Math.pow(2,i/12);return d.playbackRate.value=B,d},K=(e,t,n,o=0)=>{const a=n?`sound "${n}:${o}"`:"sample";if(!G[e]){q(`[sampler] load ${a}..`,"load-sample",{url:e});const r=Date.now();G[e]=fetch(e).then(s=>s.arrayBuffer()).then(async s=>{const i=Date.now()-r,c=fe(s.byteLength);q(`[sampler] load ${a}... done! loaded ${c} in ${i}ms`,"loaded-sample",{url:e});const f=await t.decodeAudioData(s);return I[e]=f,f})}return G[e]};function le(e){const t=E(),n=t.createBuffer(e.numberOfChannels,e.length,t.sampleRate);for(let o=0;o<e.numberOfChannels;o++)n.copyToChannel(e.getChannelData(o).slice().reverse(),o,o);return n}const We=e=>I[e],Q=(e,t,n=e._base||"")=>Object.entries(e).forEach(([o,a])=>{if(typeof a=="string"&&(a=[a]),typeof a!="object")throw new Error("wrong sample map format for "+o);n=a._base||n;const r=s=>(n+s).replace("github:","https://raw.githubusercontent.com/");Array.isArray(a)?a=a.map(r):a=Object.fromEntries(Object.entries(a).map(([s,i])=>[s,(typeof i=="string"?[i]:i).map(r)])),t(o,a)});let ee={};function de(e,t){ee[e]=t}function we(e){const t=Object.entries(ee).find(([n])=>e.startsWith(n));if(t)return t[1]}const O=async(e,t=e._base||"",n={})=>{if(typeof e=="string"){const r=we(e);if(r)return r(e);if(e.startsWith("github:")){let[i,c]=e.split("github:");c=c.endsWith("/")?c.slice(0,-1):c,e=`https://raw.githubusercontent.com/${c}/strudel.json`.replace("//strudel.json","/strudel.json")}if(typeof fetch!="function")return;const s=e.split("/").slice(0,-1).join("/");return typeof fetch>"u"?void 0:fetch(e).then(i=>i.json()).then(i=>O(i,t||i._base||s,n)).catch(i=>{throw console.error(i),new Error(`error loading "${e}"`)})}const{prebake:o,tag:a}=n;Q(e,(r,s)=>L(r,(i,c,f)=>te(i,c,f,s),{type:"sample",samples:s,baseUrl:t,prebake:o,tag:a}),t)},J=[];async function te(e,t,n,o,a){let{s:r,freq:s,unit:i,nudge:c=0,cut:f,loop:h,clip:b=void 0,n:d=0,note:B,speed:v=1,loopBegin:y=0,begin:l=0,loopEnd:j=1,end:S=1}=t;if(v===0)return;h=r.startsWith("wt_")?1:t.loop;const P=E(),{attack:w=.001,decay:m=.001,sustain:x=1,release:$=.001}=t,R=e+c,u=await ue(r,d,B,v,s,o,a);if(P.currentTime>e){q(`[sampler] still loading sound "${r}:${d}"`,"highlight");return}if(!u){q(`[sampler] could not load "${r}:${d}"`,"error");return}u.playbackRate.value=Math.abs(v)*u.playbackRate.value,i==="c"&&(u.playbackRate.value=u.playbackRate.value*u.buffer.duration*1);const g=l*u.buffer.duration;h&&(u.loop=!0,u.loopStart=y*u.buffer.duration-g,u.loopEnd=j*u.buffer.duration-g),u.start(R,g);const{node:k,stop:p}=N(w,m,x,$,1,e);u.connect(k);const _=P.createGain();k.connect(_),u.onended=function(){u.disconnect(),k.disconnect(),_.disconnect(),n()};const F={node:_,bufferSource:u,stop:(z,T=b===void 0&&h===void 0)=>{let M=z;if(T){const W=u.buffer.duration/u.playbackRate.value;M=e+(S-l)*W}u.stop(M+$),p(M)}};if(f!==void 0){const z=J[f];z&&(z.node.gain.setValueAtTime(1,R),z.node.gain.linearRampToValueAtTime(0,R+.01)),J[f]=F}return F}const pe=(e,t=1,n="sine")=>{const o=E(),a=o.createOscillator();a.type=n,a.frequency.value=e,a.start();const r=new GainNode(o,{gain:t});return a.connect(r),{node:r,stop:s=>a.stop(s)}},me=(e,t,n,o="sine")=>{const r=e.frequency.value*t,s=r*n;return pe(r,s,o)};function he(){["sine","square","triangle","sawtooth"].forEach(e=>{L(e,(t,n,o)=>{let{attack:a=.001,decay:r=.05,sustain:s=.6,release:i=.01,fmh:c=1,fmi:f,fmenv:h="lin",fmattack:b,fmdecay:d,fmsustain:B,fmrelease:v,fmvelocity:y,fmwave:l="sine",vib:j=0,vibmod:S=.5}=n,{n:P,note:w,freq:m}=n;w=w||36,typeof w=="string"&&(w=H(w)),!m&&typeof w=="number"&&(m=Y(w));const{node:x,stop:$}=ve({t,s:e,freq:m,vib:j,vibmod:S,partials:P});let R,u;if(f){const{node:_,stop:A}=me(x,c,f,l);[b,d,B,v,y].find(F=>F!==void 0)?(b=b??.001,d=d??.001,B=B??1,v=v??.001,y=y??1,u=N(b,d,B,v,y,t),h==="exp"&&(u=ie(b,d,B,v,y,t),u.node.maxValue=f*2,u.node.minValue=1e-5),_.connect(u.node),u.node.connect(x.frequency)):_.connect(x.frequency),R=A}const g=ce(.3),{node:k,stop:p}=N(a,r,s,i,1,t);return x.onended=()=>{x.disconnect(),g.disconnect(),o()},{node:x.connect(g).connect(k),stop:_=>{p(_),u?.stop(_);let A=_+i;$(A),R?.(A)}}},{type:"synth",prebake:!0})})}function _e(e,t){const n=new Float32Array(e+1),o=new Float32Array(e+1),a=E(),r=a.createOscillator(),s={sawtooth:f=>1/f,square:f=>f%2===0?0:1/f,triangle:f=>f%2===0?0:1/(f*f)};if(!s[t])throw new Error(`unknown wave type ${t}`);n[0]=0,o[0]=0;let i=1;for(;i<=e;)n[i]=s[t](i),o[i]=0,i++;const c=a.createPeriodicWave(n,o);return r.setPeriodicWave(c),r}function ve({s:e,freq:t,t:n,vib:o,vibmod:a,partials:r}){let s;!r||e==="sine"?(s=E().createOscillator(),s.type=e||"triangle"):s=_e(r,e),s.frequency.value=Number(t),s.start(n);let i;if(o>0){i=E().createOscillator(),i.frequency.value=o;const c=E().createGain();c.gain.value=a*100,i.connect(c),c.connect(s.detune),i.start(n)}return{node:s,stop:c=>{i?.stop(c),s.stop(c)}}}function ge(e=1,t=.05,n=220,o=0,a=0,r=.1,s=0,i=1,c=0,f=0,h=0,b=0,d=0,B=0,v=0,y=0,l=0,j=1,S=0,P=0){let w=Math.PI*2,m=E().sampleRate,x=W=>W>0?1:-1,$=c*=500*w/m/m,R=n*=(1+t*2*Math.random()-t)*w/m,u=[],g=0,k=0,p=0,_=1,A=0,F=0,z=0,T,M;for(o=o*m+9,S*=m,a*=m,r*=m,l*=m,f*=500*w/m**3,v*=w/m,h*=w/m,b*=m,d=d*m|0,M=o+S+a+r+l|0;p<M;u[p++]=z)++F%(y*100|0)||(z=s?s>1?s>2?s>3?Math.sin((g%w)**3):Math.max(Math.min(Math.tan(g),1),-1):1-(2*g/w%2+2)%2:1-4*Math.abs(Math.round(g/w)-g/w):Math.sin(g),z=(d?1-P+P*Math.sin(w*p/d):1)*x(z)*Math.abs(z)**i*e*1*(p<o?p/o:p<o+S?1-(p-o)/S*(1-j):p<o+S+a?j:p<M-l?(M-p-l)/r*j:0),z=l?z/2+(l>p?0:(p<M-l?1:(M-p)/l)*u[p-l|0]/2):z),T=(n+=c+=f)*Math.cos(v*k++),g+=T-T*B*(1-(Math.sin(p)+1)*1e9%2),_&&++_>b&&(n+=h,R+=h,_=0),d&&!(++A%d)&&(n=R,c=$,_||=1);return u}const be=(e,t)=>{let{s:n,note:o=36,freq:a,zrand:r=0,attack:s=0,decay:i=0,sustain:c=.8,release:f=.1,curve:h=1,slide:b=0,deltaSlide:d=0,pitchJump:B=0,pitchJumpTime:v=0,lfo:y=0,noise:l=0,zmod:j=0,zcrush:S=0,zdelay:P=0,tremolo:w=0,duration:m=.2,zzfx:x}=e;const $=Math.max(m-s-i,0);typeof o=="string"&&(o=H(o)),!a&&typeof o=="number"&&(a=Y(o)),n=n.replace("z_","");const R=["sine","triangle","sawtooth","tan","noise"].indexOf(n)||0;h=n==="square"?0:h;const g=ge(...x||[.25,r,a,s,$,f,R,h,b,d,B,v,y,l,j,S,P,c,i,w]),k=E(),p=k.createBuffer(1,g.length,k.sampleRate);p.getChannelData(0).set(g);const _=E().createBufferSource();return _.buffer=p,_.start(t),{node:_}};function ye(){["zzfx","z_sine","z_sawtooth","z_triangle","z_square","z_tan","z_noise"].forEach(e=>{L(e,(t,n,o)=>{const{node:a}=be({s:e,...n},t);return a.onended=()=>{a.disconnect(),o()},{node:a,stop:()=>{}}},{type:"synth",prebake:!0})})}const ze=U("C8"),Be=(e,t)=>e*t+(1-t)/2;V.prototype.piano=function(){return this.clip(1).s("piano").release(.1).fmap(e=>{const t=X(e),n=Be(Math.min(Math.round(t)/ze,1),.5);return{...e,pan:(e.pan||1)*n}})};let ne;typeof window<"u"&&(ne=window?.__TAURI__);const{BaseDirectory:je,readDir:Se,readBinaryFile:xe,writeTextFile:Ee,readTextFile:Re,exists:ke}=ne?.fs||{},C=je?.Audio,Z="~/music/";async function Me(e){return ke(e+"/strudel.json",{dir:C})}async function Pe(e){const t=await Re(e+"/strudel.json",{dir:C}),n=JSON.parse(t);Q(n,(o,a)=>{L(o,(r,s,i)=>te(r,s,i,a,Fe(e)),{type:"sample",samples:a,fileSystem:!0,tag:"local"})})}async function $e(e){const t=await Se(e,{dir:C,recursive:!0}),o={name:e.split("/").slice(-1)[0],children:t};let a={},r=0;ae(o,(c,f)=>{["wav","mp3"].includes(c.name.split(".").slice(-1)[0])&&(a[f.name]=a[f.name]||[],r+=1,a[f.name].push(c.subpath.slice(1).concat([c.name]).join("/")))});const s=JSON.stringify(a,null,2),i=e+"/strudel.json";await Ee(i,s,{dir:C}),console.log(`wrote strudel.json with ${r} samples to ${e}!`)}de(Z,async e=>{const t=e.replace(Z,"");return await Me(t)||await $e(t),Pe(t)});const ae=(e,t)=>{if(Array.isArray(e?.children))for(const n of e.children)n.subpath=(e.subpath||[]).concat([e.name]),t(n,e),n.children&&ae(n,t)},Ge=e=>["wav","mp3"].includes(e.split(".").slice(-1)[0]);function Ae(e){const t=new Blob([e],{type:"audio/*"});return URL.createObjectURL(t)}const D={};async function oe(e){return D[e]||(D[e]=(async()=>{const t=await xe(e,{dir:C});return Ae(t)})()),D[e]}const Fe=e=>t=>oe(e.endsWith("/")?e+t:e+"/"+t);async function Ne(e){const t=await oe(e),n=E(),o=n.createBufferSource();o.buffer=await K(t,n),o.connect(n.destination),o.start(n.currentTime)}async function He(){await Promise.all([he(),ye(),se(()=>import("./index.9d5085b6.js"),["_astro/index.9d5085b6.js","_astro/index.7dcdd514.js","_astro/index.3d4af9ee.js","_astro/scope.efc95823.js"]).then(({registerSoundfonts:e})=>e()),O("./piano.json","./piano/",{prebake:!0}),O("./vcsl.json","github:sgossner/VCSL/master/",{prebake:!0}),O("./tidal-drum-machines.json","github:ritchse/tidal-drum-machines/main/machines/",{prebake:!0,tag:"drum-machines"}),O("./EmuSP12.json","./EmuSP12/",{prebake:!0,tag:"drum-machines"}),O({casio:["casio/high.wav","casio/low.wav","casio/noise.wav"],crow:["crow/000_crow.wav","crow/001_crow2.wav","crow/002_crow3.wav","crow/003_crow4.wav"],insect:["insect/000_everglades_conehead.wav","insect/001_robust_shieldback.wav","insect/002_seashore_meadow_katydid.wav"],wind:["wind/000_wind1.wav","wind/001_wind10.wav","wind/002_wind2.wav","wind/003_wind3.wav","wind/004_wind4.wav","wind/005_wind5.wav","wind/006_wind6.wav","wind/007_wind7.wav","wind/008_wind8.wav","wind/009_wind9.wav"],jazz:["jazz/000_BD.wav","jazz/001_CB.wav","jazz/002_FX.wav","jazz/003_HH.wav","jazz/004_OH.wav","jazz/005_P1.wav","jazz/006_P2.wav","jazz/007_SN.wav"],metal:["metal/000_0.wav","metal/001_1.wav","metal/002_2.wav","metal/003_3.wav","metal/004_4.wav","metal/005_5.wav","metal/006_6.wav","metal/007_7.wav","metal/008_8.wav","metal/009_9.wav"],east:["east/000_nipon_wood_block.wav","east/001_ohkawa_mute.wav","east/002_ohkawa_open.wav","east/003_shime_hi.wav","east/004_shime_hi_2.wav","east/005_shime_mute.wav","east/006_taiko_1.wav","east/007_taiko_2.wav","east/008_taiko_3.wav"],space:["space/000_0.wav","space/001_1.wav","space/002_11.wav","space/003_12.wav","space/004_13.wav","space/005_14.wav","space/006_15.wav","space/007_16.wav","space/008_17.wav","space/009_18.wav","space/010_2.wav","space/011_3.wav","space/012_4.wav","space/013_5.wav","space/014_6.wav","space/015_7.wav","space/016_8.wav","space/017_9.wav"],numbers:["numbers/0.wav","numbers/1.wav","numbers/2.wav","numbers/3.wav","numbers/4.wav","numbers/5.wav","numbers/6.wav","numbers/7.wav","numbers/8.wav"]},"github:tidalcycles/Dirt-Samples/master/")])}const Oe=U("C8"),Te=(e,t)=>e*t+(1-t)/2;V.prototype.piano=function(){return this.fmap(e=>({...e,clip:e.clip??1})).s("piano").release(.1).fmap(e=>{const t=X(e),n=Te(Math.min(Math.round(t)/Oe,1),.5);return{...e,pan:(e.pan||1)*n}})};export{ue as a,We as b,de as c,he as d,ve as e,be as f,Le as g,ye as h,Se as i,C as j,Ge as k,K as l,Ne as m,He as n,te as o,Q as p,le as r,O as s,_e as w};
//# sourceMappingURL=prebake.1db9593c.js.map
