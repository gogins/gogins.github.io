{"version":3,"file":"index.539d1285.js","sources":["../../../packages/codemirror/codemirror.mjs"],"sourcesContent":["import { defaultKeymap } from '@codemirror/commands';\nimport { javascript } from '@codemirror/lang-javascript';\nimport { defaultHighlightStyle, syntaxHighlighting } from '@codemirror/language';\nimport { EditorState } from '@codemirror/state';\nimport { EditorView, highlightActiveLineGutter, keymap, lineNumbers } from '@codemirror/view';\nimport { Drawer, repl } from '@strudel.cycles/core';\nimport { flashField, flash } from './flash.mjs';\nimport { highlightExtension, highlightMiniLocations } from './highlight.mjs';\nimport { oneDark } from './themes/one-dark';\n\n// https://codemirror.net/docs/guide/\nexport function initEditor({ initialCode = '', onChange, onEvaluate, onStop, theme = oneDark, root }) {\n  let state = EditorState.create({\n    doc: initialCode,\n    extensions: [\n      theme,\n      javascript(),\n      lineNumbers(),\n      highlightExtension,\n      highlightActiveLineGutter(),\n      syntaxHighlighting(defaultHighlightStyle),\n      keymap.of(defaultKeymap),\n      flashField,\n      EditorView.updateListener.of((v) => onChange(v)),\n      keymap.of([\n        {\n          key: 'Ctrl-Enter',\n          run: () => onEvaluate(),\n        },\n        {\n          key: 'Ctrl-.',\n          run: () => onStop(),\n        },\n      ]),\n    ],\n  });\n\n  return new EditorView({\n    state,\n    parent: root,\n  });\n}\n\nexport class StrudelMirror {\n  constructor(options) {\n    const { root, initialCode = '', onDraw, drawTime = [-2, 2], prebake, ...replOptions } = options;\n    this.code = initialCode;\n\n    this.drawer = new Drawer((haps, time) => {\n      const currentFrame = haps.filter((hap) => time >= hap.whole.begin && time <= hap.endClipped);\n      this.highlight(currentFrame, time);\n      onDraw?.(haps, time, currentFrame);\n    }, drawTime);\n\n    const prebaked = prebake();\n    prebaked.then(async () => {\n      if (!onDraw) {\n        return;\n      }\n      const { scheduler, evaluate } = await this.repl;\n      // draw first frame instantly\n      prebaked.then(async () => {\n        await evaluate(this.code, false);\n        this.drawer.invalidate(scheduler);\n        onDraw?.(this.drawer.visibleHaps, 0, []);\n      });\n    });\n\n    this.repl = repl({\n      ...replOptions,\n      onToggle: async (started) => {\n        replOptions?.onToggle?.(started);\n        const { scheduler } = await this.repl;\n        if (started) {\n          this.drawer.start(scheduler);\n        } else {\n          this.drawer.stop();\n        }\n      },\n      beforeEval: async () => {\n        await prebaked;\n      },\n      afterEval: (options) => {\n        replOptions?.afterEval?.(options);\n        this.drawer.invalidate();\n      },\n    });\n    this.editor = initEditor({\n      root,\n      initialCode,\n      onChange: (v) => {\n        this.code = v.state.doc.toString();\n      },\n      onEvaluate: () => this.evaluate(),\n      onStop: () => this.stop(),\n    });\n  }\n  async evaluate() {\n    const { evaluate } = await this.repl;\n    this.flash();\n    await evaluate(this.code);\n  }\n  async stop() {\n    const { scheduler } = await this.repl;\n    scheduler.stop();\n  }\n  flash(ms) {\n    flash(this.editor, ms);\n  }\n  highlight(haps, time) {\n    highlightMiniLocations(this.editor.view, time, haps);\n  }\n}\n"],"names":["initEditor","initialCode","onChange","onEvaluate","onStop","theme","oneDark","root","state","EditorState","javascript","lineNumbers","highlightExtension","highlightActiveLineGutter","syntaxHighlighting","defaultHighlightStyle","keymap","defaultKeymap","flashField","EditorView","v","StrudelMirror","options","onDraw","drawTime","prebake","replOptions","Drawer","haps","time","currentFrame","hap","prebaked","scheduler","evaluate","repl","started","ms","flash","highlightMiniLocations"],"mappings":"wfAWO,SAASA,EAAW,CAAE,YAAAC,EAAc,GAAI,SAAAC,EAAU,WAAAC,EAAY,OAAAC,EAAQ,MAAAC,EAAQC,EAAS,KAAAC,GAAQ,CACpG,IAAIC,EAAQC,EAAY,OAAO,CAC7B,IAAKR,EACL,WAAY,CACVI,EACAK,EAAY,EACZC,EAAa,EACbC,EACAC,EAA2B,EAC3BC,EAAmBC,CAAqB,EACxCC,EAAO,GAAGC,CAAa,EACvBC,EACAC,EAAW,eAAe,GAAIC,GAAMlB,EAASkB,CAAC,CAAC,EAC/CJ,EAAO,GAAG,CACR,CACE,IAAK,aACL,IAAK,IAAMb,EAAY,CACxB,EACD,CACE,IAAK,SACL,IAAK,IAAMC,EAAQ,CACpB,CACT,CAAO,CACF,CACL,CAAG,EAED,OAAO,IAAIe,EAAW,CACpB,MAAAX,EACA,OAAQD,CACZ,CAAG,CACH,CAEO,MAAMc,CAAc,CACzB,YAAYC,EAAS,CACnB,KAAM,CAAE,KAAAf,EAAM,YAAAN,EAAc,GAAI,OAAAsB,EAAQ,SAAAC,EAAW,CAAC,GAAI,CAAC,EAAG,QAAAC,EAAS,GAAGC,CAAW,EAAKJ,EACxF,KAAK,KAAOrB,EAEZ,KAAK,OAAS,IAAI0B,EAAO,CAACC,EAAMC,IAAS,CACvC,MAAMC,EAAeF,EAAK,OAAQG,GAAQF,GAAQE,EAAI,MAAM,OAASF,GAAQE,EAAI,UAAU,EAC3F,KAAK,UAAUD,EAAcD,CAAI,EACjCN,IAASK,EAAMC,EAAMC,CAAY,CAClC,EAAEN,CAAQ,EAEX,MAAMQ,EAAWP,IACjBO,EAAS,KAAK,SAAY,CACxB,GAAI,CAACT,EACH,OAEF,KAAM,CAAE,UAAAU,EAAW,SAAAC,CAAU,EAAG,MAAM,KAAK,KAE3CF,EAAS,KAAK,SAAY,CACxB,MAAME,EAAS,KAAK,KAAM,EAAK,EAC/B,KAAK,OAAO,WAAWD,CAAS,EAChCV,IAAS,KAAK,OAAO,YAAa,EAAG,CAAE,CAAA,CAC/C,CAAO,CACP,CAAK,EAED,KAAK,KAAOY,EAAK,CACf,GAAGT,EACH,SAAU,MAAOU,GAAY,CAC3BV,GAAa,WAAWU,CAAO,EAC/B,KAAM,CAAE,UAAAH,CAAS,EAAK,MAAM,KAAK,KAC7BG,EACF,KAAK,OAAO,MAAMH,CAAS,EAE3B,KAAK,OAAO,MAEf,EACD,WAAY,SAAY,CACtB,MAAMD,CACP,EACD,UAAYV,GAAY,CACtBI,GAAa,YAAYJ,CAAO,EAChC,KAAK,OAAO,YACb,CACP,CAAK,EACD,KAAK,OAAStB,EAAW,CACvB,KAAAO,EACA,YAAAN,EACA,SAAWmB,GAAM,CACf,KAAK,KAAOA,EAAE,MAAM,IAAI,SAAQ,CACjC,EACD,WAAY,IAAM,KAAK,SAAU,EACjC,OAAQ,IAAM,KAAK,KAAM,CAC/B,CAAK,CACF,CACD,MAAM,UAAW,CACf,KAAM,CAAE,SAAAc,CAAQ,EAAK,MAAM,KAAK,KAChC,KAAK,MAAK,EACV,MAAMA,EAAS,KAAK,IAAI,CACzB,CACD,MAAM,MAAO,CACX,KAAM,CAAE,UAAAD,CAAS,EAAK,MAAM,KAAK,KACjCA,EAAU,KAAI,CACf,CACD,MAAMI,EAAI,CACRC,EAAM,KAAK,OAAQD,CAAE,CACtB,CACD,UAAUT,EAAMC,EAAM,CACpBU,EAAuB,KAAK,OAAO,KAAMV,EAAMD,CAAI,CACpD,CACH"}