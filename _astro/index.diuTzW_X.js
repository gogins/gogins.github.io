/**
 * @license Fraction.js v4.3.7 31/08/2023
 * https://www.xarg.org/2014/03/rational-numbers-in-javascript/
 *
 * Copyright (c) 2023, Robert Eisele (robert@raw.org)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 **/var gn=2e3,d={s:1,n:0,d:1};function X(e,t){if(isNaN(e=parseInt(e,10)))throw kt();return e*t}function S(e,t){if(t===0)throw Ft();var n=Object.create(M.prototype);n.s=e<0?-1:1,e=e<0?-e:e;var r=at(e,t);return n.n=e/r,n.d=t/r,n}function he(e){for(var t={},n=e,r=2,s=4;s<=n;){for(;n%r===0;)n/=r,t[r]=(t[r]||0)+1;s+=1+2*r++}return n!==e?n>1&&(t[n]=(t[n]||0)+1):t[e]=(t[e]||0)+1,t}var J=function(e,t){var n=0,r=1,s=1,o=0,i=0,l=0,u=1,h=1,c=0,a=1,y=1,w=1,_=1e7,b;if(e!=null)if(t!==void 0){if(n=e,r=t,s=n*r,n%1!==0||r%1!==0)throw qn()}else switch(typeof e){case"object":{if("d"in e&&"n"in e)n=e.n,r=e.d,"s"in e&&(n*=e.s);else if(0 in e)n=e[0],1 in e&&(r=e[1]);else throw kt();s=n*r;break}case"number":{if(e<0&&(s=e,e=-e),e%1===0)n=e;else if(e>0){for(e>=1&&(h=Math.pow(10,Math.floor(1+Math.log(e)/Math.LN10)),e/=h);a<=_&&w<=_;)if(b=(c+y)/(a+w),e===b){a+w<=_?(n=c+y,r=a+w):w>a?(n=y,r=w):(n=c,r=a);break}else e>b?(c+=y,a+=w):(y+=c,w+=a),a>_?(n=y,r=w):(n=c,r=a);n*=h}else(isNaN(e)||isNaN(t))&&(r=n=NaN);break}case"string":{if(a=e.match(/\d+|./g),a===null)throw kt();if(a[c]==="-"?(s=-1,c++):a[c]==="+"&&c++,a.length===c+1?i=X(a[c++],s):a[c+1]==="."||a[c]==="."?(a[c]!=="."&&(o=X(a[c++],s)),c++,(c+1===a.length||a[c+1]==="("&&a[c+3]===")"||a[c+1]==="'"&&a[c+3]==="'")&&(i=X(a[c],s),u=Math.pow(10,a[c].length),c++),(a[c]==="("&&a[c+2]===")"||a[c]==="'"&&a[c+2]==="'")&&(l=X(a[c+1],s),h=Math.pow(10,a[c+1].length)-1,c+=3)):a[c+1]==="/"||a[c+1]===":"?(i=X(a[c],s),u=X(a[c+2],1),c+=3):a[c+3]==="/"&&a[c+1]===" "&&(o=X(a[c],s),i=X(a[c+2],s),u=X(a[c+4],1),c+=5),a.length<=c){r=u*h,s=n=l+r*o+h*i;break}}default:throw kt()}if(r===0)throw Ft();d.s=s<0?-1:1,d.n=Math.abs(n),d.d=Math.abs(r)};function bn(e,t,n){for(var r=1;t>0;e=e*e%n,t>>=1)t&1&&(r=r*e%n);return r}function vn(e,t){for(;t%2===0;t/=2);for(;t%5===0;t/=5);if(t===1)return 0;for(var n=10%t,r=1;n!==1;r++)if(n=n*10%t,r>gn)return 0;return r}function _n(e,t,n){for(var r=1,s=bn(10,n,t),o=0;o<300;o++){if(r===s)return o;r=r*10%t,s=s*10%t}return 0}function at(e,t){if(!e)return t;if(!t)return e;for(;;){if(e%=t,!e)return t;if(t%=e,!t)return e}}function M(e,t){if(J(e,t),this instanceof M)e=at(d.d,d.n),this.s=d.s,this.n=d.n/e,this.d=d.d/e;else return S(d.s*d.n,d.d)}var Ft=function(){return new Error("Division by Zero")},kt=function(){return new Error("Invalid argument")},qn=function(){return new Error("Parameters must be integer")};M.prototype={s:1,n:0,d:1,abs:function(){return S(this.n,this.d)},neg:function(){return S(-this.s*this.n,this.d)},add:function(e,t){return J(e,t),S(this.s*this.n*d.d+d.s*this.d*d.n,this.d*d.d)},sub:function(e,t){return J(e,t),S(this.s*this.n*d.d-d.s*this.d*d.n,this.d*d.d)},mul:function(e,t){return J(e,t),S(this.s*d.s*this.n*d.n,this.d*d.d)},div:function(e,t){return J(e,t),S(this.s*d.s*this.n*d.d,this.d*d.n)},clone:function(){return S(this.s*this.n,this.d)},mod:function(e,t){if(isNaN(this.n)||isNaN(this.d))return new M(NaN);if(e===void 0)return S(this.s*this.n%this.d,1);if(J(e,t),d.n===0&&this.d===0)throw Ft();return S(this.s*(d.d*this.n)%(d.n*this.d),d.d*this.d)},gcd:function(e,t){return J(e,t),S(at(d.n,this.n)*at(d.d,this.d),d.d*this.d)},lcm:function(e,t){return J(e,t),d.n===0&&this.n===0?S(0,1):S(d.n*this.n,at(d.n,this.n)*at(d.d,this.d))},ceil:function(e){return e=Math.pow(10,e||0),isNaN(this.n)||isNaN(this.d)?new M(NaN):S(Math.ceil(e*this.s*this.n/this.d),e)},floor:function(e){return e=Math.pow(10,e||0),isNaN(this.n)||isNaN(this.d)?new M(NaN):S(Math.floor(e*this.s*this.n/this.d),e)},round:function(e){return e=Math.pow(10,e||0),isNaN(this.n)||isNaN(this.d)?new M(NaN):S(Math.round(e*this.s*this.n/this.d),e)},roundTo:function(e,t){return J(e,t),S(this.s*Math.round(this.n*d.d/(this.d*d.n))*d.n,d.d)},inverse:function(){return S(this.s*this.d,this.n)},pow:function(e,t){if(J(e,t),d.d===1)return d.s<0?S(Math.pow(this.s*this.d,d.n),Math.pow(this.n,d.n)):S(Math.pow(this.s*this.n,d.n),Math.pow(this.d,d.n));if(this.s<0)return null;var n=he(this.n),r=he(this.d),s=1,o=1;for(var i in n)if(i!=="1"){if(i==="0"){s=0;break}if(n[i]*=d.n,n[i]%d.d===0)n[i]/=d.d;else return null;s*=Math.pow(i,n[i])}for(var i in r)if(i!=="1"){if(r[i]*=d.n,r[i]%d.d===0)r[i]/=d.d;else return null;o*=Math.pow(i,r[i])}return d.s<0?S(o,s):S(s,o)},equals:function(e,t){return J(e,t),this.s*this.n*d.d===d.s*d.n*this.d},compare:function(e,t){J(e,t);var n=this.s*this.n*d.d-d.s*d.n*this.d;return(0<n)-(n<0)},simplify:function(e){if(isNaN(this.n)||isNaN(this.d))return this;e=e||.001;for(var t=this.abs(),n=t.toContinued(),r=1;r<n.length;r++){for(var s=S(n[r-1],1),o=r-2;o>=0;o--)s=s.inverse().add(n[o]);if(Math.abs(s.sub(t).valueOf())<e)return s.mul(this.s)}return this},divisible:function(e,t){return J(e,t),!(!(d.n*this.d)||this.n*d.d%(d.n*this.d))},valueOf:function(){return this.s*this.n/this.d},toFraction:function(e){var t,n="",r=this.n,s=this.d;return this.s<0&&(n+="-"),s===1?n+=r:(e&&(t=Math.floor(r/s))>0&&(n+=t,n+=" ",r%=s),n+=r,n+="/",n+=s),n},toLatex:function(e){var t,n="",r=this.n,s=this.d;return this.s<0&&(n+="-"),s===1?n+=r:(e&&(t=Math.floor(r/s))>0&&(n+=t,r%=s),n+="\\frac{",n+=r,n+="}{",n+=s,n+="}"),n},toContinued:function(){var e,t=this.n,n=this.d,r=[];if(isNaN(t)||isNaN(n))return r;do r.push(Math.floor(t/n)),e=t%n,t=n,n=e;while(t!==1);return r},toString:function(e){var t=this.n,n=this.d;if(isNaN(t)||isNaN(n))return"NaN";e=e||15;var r=vn(t,n),s=_n(t,n,r),o=this.s<0?"-":"";if(o+=t/n|0,t%=n,t*=10,t&&(o+="."),r){for(var i=s;i--;)o+=t/n|0,t%=n,t*=10;o+="(";for(var i=r;i--;)o+=t/n|0,t%=n,t*=10;o+=")"}else for(var i=e;t&&i--;)o+=t/n|0,t%=n,t*=10;return o}};M.prototype.sam=function(){return this.floor()};M.prototype.nextSam=function(){return this.sam().add(1)};M.prototype.wholeCycle=function(){return new T(this.sam(),this.nextSam())};M.prototype.cyclePos=function(){return this.sub(this.sam())};M.prototype.lt=function(e){return this.compare(e)<0};M.prototype.gt=function(e){return this.compare(e)>0};M.prototype.lte=function(e){return this.compare(e)<=0};M.prototype.gte=function(e){return this.compare(e)>=0};M.prototype.eq=function(e){return this.compare(e)==0};M.prototype.max=function(e){return this.gt(e)?this:e};M.prototype.min=function(e){return this.lt(e)?this:e};M.prototype.show=function(){return this.s*this.n+"/"+this.d};M.prototype.or=function(e){return this.eq(0)?e:this};const v=e=>M(e),An=(...e)=>e.reduce((t,n)=>t.gcd(n),v(1));v._original=M;class T{constructor(t,n){this.begin=v(t),this.end=v(n)}get spanCycles(){const t=[];var n=this.begin;const r=this.end,s=r.sam();if(n.equals(r))return[new T(n,r)];for(;r.gt(n);){if(n.sam().equals(s)){t.push(new T(n,this.end));break}const o=n.nextSam();t.push(new T(n,o)),n=o}return t}get duration(){return this.end.sub(this.begin)}cycleArc(){const t=this.begin.cyclePos(),n=t.add(this.duration);return new T(t,n)}withTime(t){return new T(t(this.begin),t(this.end))}withEnd(t){return new T(this.begin,t(this.end))}withCycle(t){const n=this.begin.sam(),r=n.add(t(this.begin.sub(n))),s=n.add(t(this.end.sub(n)));return new T(r,s)}intersection(t){const n=this.begin.max(t.begin),r=this.end.min(t.end);if(!n.gt(r)&&!(n.equals(r)&&(n.equals(this.end)&&this.begin.lt(this.end)||n.equals(t.end)&&t.begin.lt(t.end))))return new T(n,r)}intersection_e(t){const n=this.intersection(t);if(n==null)throw"TimeSpans do not intersect";return n}midpoint(){return this.begin.add(this.duration.div(v(2)))}equals(t){return this.begin.equals(t.begin)&&this.end.equals(t.end)}show(){return this.begin.show()+" → "+this.end.show()}}class O{constructor(t,n,r,s={},o=!1){this.whole=t,this.part=n,this.value=r,this.context=s,this.stateful=o,o&&console.assert(typeof this.value=="function","Stateful values must be functions")}get duration(){return this.whole.end.sub(this.whole.begin).mul(typeof this.value?.clip=="number"?this.value?.clip:1)}get endClipped(){return this.whole.begin.add(this.duration)}wholeOrPart(){return this.whole?this.whole:this.part}withSpan(t){const n=this.whole?t(this.whole):void 0;return new O(n,t(this.part),this.value,this.context)}withValue(t){return new O(this.whole,this.part,t(this.value),this.context)}hasOnset(){return this.whole!=null&&this.whole.begin.equals(this.part.begin)}resolveState(t){if(this.stateful&&this.hasOnset()){console.log("stateful");const n=this.value,[r,s]=n(t);return[r,new O(this.whole,this.part,s,this.context,!1)]}return[t,this]}spanEquals(t){return this.whole==null&&t.whole==null||this.whole.equals(t.whole)}equals(t){return this.spanEquals(t)&&this.part.equals(t.part)&&this.value===t.value}show(t=!1){const n=typeof this.value=="object"?t?JSON.stringify(this.value).slice(1,-1).replaceAll('"',"").replaceAll(","," "):JSON.stringify(this.value):this.value;var r="";if(this.whole==null)r="~"+this.part.show;else{var s=this.whole.begin.equals(this.part.begin)&&this.whole.end.equals(this.part.end);this.whole.begin.equals(this.part.begin)||(r=this.whole.begin.show()+" ⇜ "),s||(r+="("),r+=this.part.show(),s||(r+=")"),this.whole.end.equals(this.part.end)||(r+=" ⇝ "+this.whole.end.show())}return"[ "+r+" | "+n+" ]"}showWhole(t=!1){return`${this.whole==null?"~":this.whole.show()}: ${typeof this.value=="object"?t?JSON.stringify(this.value).slice(1,-1).replaceAll('"',"").replaceAll(","," "):JSON.stringify(this.value):this.value}`}combineContext(t){const n=this;return{...n.context,...t.context,locations:(n.context.locations||[]).concat(t.context.locations||[])}}setContext(t){return new O(this.whole,this.part,this.value,t)}ensureObjectValue(){if(typeof this.value!="object")throw new Error(`expected hap.value to be an object, but got "${this.value}". Hint: append .note() or .s() to the end`,"error")}}class st{constructor(t,n={}){this.span=t,this.controls=n}setSpan(t){return new st(t,this.controls)}withSpan(t){return this.setSpan(t(this.span))}setControls(t){return new st(this.span,t)}}const $t="strudel.log";function I(e,t,n={}){console.log(`%c${e}`,"background-color: black;color:white;border-radius:15px"),typeof document<"u"&&typeof CustomEvent<"u"&&document.dispatchEvent(new CustomEvent($t,{detail:{message:e,type:t,data:n}}))}I.key=$t;const kn=e=>/^[a-gA-G][#bs]*[0-9]$/.test(e),Ct=e=>/^[a-gA-G][#bsf]*[0-9]?$/.test(e),be=e=>{if(typeof e!="string")return[];const[t,n="",r]=e.match(/^([a-gA-G])([#bsf]*)([0-9]*)$/)?.slice(1)||[];return t?[t,n,r?Number(r):void 0]:[]},Nn={c:0,d:2,e:4,f:5,g:7,a:9,b:11},Cn={"#":1,b:-1,s:1,f:-1},ft=(e,t=3)=>{const[n,r,s=t]=be(e);if(!n)throw new Error('not a note: "'+e+'"');const o=Nn[n.toLowerCase()],i=r?.split("").reduce((l,u)=>l+Cn[u],0)||0;return(Number(s)+1)*12+o+i},lt=e=>Math.pow(2,(e-69)/12)*440,Lt=e=>12*Math.log(e/440)/Math.LN2+69,Sn=(e,t)=>{if(typeof e!="object")throw new Error("valueToMidi: expected object value");let{freq:n,note:r}=e;if(typeof n=="number")return Lt(n);if(typeof r=="string")return ft(r);if(typeof r=="number")return r;if(!t)throw new Error("valueToMidi: expected freq or note to be set");return t},ve=e=>lt(typeof e=="number"?e:ft(e)),xn=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],Mn=e=>{const t=Math.floor(e/12)-1;return xn[e%12]+t},bt=(e,t)=>(e%t+t)%t;function _e(e,t=0){return isNaN(Number(e))?(I(`"${e}" is not a number, falling back to ${t}`,"warning"),t):e}const Tn=(e,t)=>bt(Math.round(_e(e??0,0)),t),On=e=>{let{value:t,context:n}=e,r=t;if(typeof r=="object"&&!Array.isArray(r)&&(r=r.note||r.n||r.value,r===void 0))throw new Error(`cannot find a playable note for ${JSON.stringify(t)}`);if(typeof r=="number"&&n.type!=="frequency")r=lt(e.value);else if(typeof r=="number"&&n.type==="frequency")r=e.value;else if(typeof r!="string"||!Ct(r))throw new Error("not a note: "+JSON.stringify(r));return r},Bn=e=>{let{value:t,context:n}=e;if(typeof t=="object")return t.freq?t.freq:ve(t.note||t.n||t.value);if(typeof t=="number"&&n.type!=="frequency")t=lt(e.value);else if(typeof t=="string"&&Ct(t))t=lt(ft(e.value));else if(typeof t!="number")throw new Error("not a note or frequency: "+t);return t},qe=(e,t)=>e.slice(t).concat(e.slice(0,t)),Ae=(...e)=>e.reduce((t,n)=>(...r)=>t(n(...r)),t=>t),En=(...e)=>Ae(...e.reverse()),ke=e=>e.filter(t=>t!=null),nt=e=>[].concat(...e),ut=e=>e,Pn=(e,t)=>e,Ht=(e,t)=>Array.from({length:t-e+1},(n,r)=>r+e);function A(e,t,n=e.length){const r=function s(...o){if(o.length>=n)return e.apply(this,o);{const i=function(...l){return s.apply(this,o.concat(l))};return t&&t(i,o),i}};return t&&t(r,[]),r}function Jt(e){const t=Number(e);if(!isNaN(t))return t;if(Ct(e))return ft(e);throw new Error(`cannot parse as numeral: "${e}"`)}function It(e,t){return(...n)=>e(...n.map(t))}function D(e){return It(e,Jt)}function Ne(e){const t=Number(e);if(!isNaN(t))return t;const n={pi:Math.PI,w:1,h:.5,q:.25,e:.125,s:.0625,t:1/3,f:.2,x:1/6}[e];if(typeof n<"u")return n;throw new Error(`cannot parse as fractional: "${e}"`)}const zn=e=>It(e,Ne),Wt=function(e,t){return[t.slice(0,e),t.slice(e)]},Rt=(e,t,n)=>t.map((r,s)=>e(r,n[s])),Ce=(e,t,n)=>Math.min(Math.max(e,t),n),jn=["Do","Reb","Re","Mib","Mi","Fa","Solb","Sol","Lab","La","Sib","Si"],Fn=["Sa","Re","Ga","Ma","Pa","Dha","Ni"],$n=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Hb","H"],Ln=["Ni","Pab","Pa","Voub","Vou","Ga","Dib","Di","Keb","Ke","Zob","Zo"],Hn=["I","Ro","Ha","Ni","Ho","He","To"],Jn=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],In=(e,t="letters")=>{const r=(t==="solfeggio"?jn:t==="indian"?Fn:t==="german"?$n:t==="byzantine"?Ln:t==="japanese"?Hn:Jn)[e%12],s=Math.floor(e/12)-1;return r+s};function Se(e){const t=new TextEncoder().encode(e);return btoa(String.fromCharCode(...t))}function xe(e){const t=new Uint8Array(atob(e).split("").map(r=>r.charCodeAt(0)));return new TextDecoder().decode(t)}function Wn(e){return encodeURIComponent(Se(e))}function Rn(e){return xe(decodeURIComponent(e))}function Me(e,t){return Array.isArray(e)?e.map(t):Object.fromEntries(Object.entries(e).map(([n,r],s)=>[n,t(r,n,s)]))}function Dn(e,t,n){if(typeof t?.value=="number"){const s=Object.keys(e).filter(i=>typeof e[i]=="number"),o=Object.fromEntries(s.map(i=>[i,t.value]));t=Object.assign(t,o),delete t.value}const r=Object.keys(e).filter(s=>Object.keys(t).includes(s));return Object.assign({},e,t,Object.fromEntries(r.map(s=>[s,n(e[s],t[s])])))}A((e,t)=>e*t);A((e,t)=>t.map(e));function Te(e,t=60){let n=0,r=v(0),s=[""],o="";for(;s[0].length<t;){const i=e.queryArc(n,n+1),l=i.filter(c=>c.hasOnset()).map(c=>c.duration),u=An(...l),h=u.inverse();s=s.map(c=>c+"|"),o+="|";for(let c=0;c<h;c++){const[a,y]=[r,r.add(u)],w=i.filter(b=>b.whole.begin.lte(a)&&b.whole.end.gte(y)),_=w.length-s.length;_>0&&(s=s.concat(Array(_).fill(o))),s=s.map((b,N)=>{const g=w[N];if(g){const F=g.whole.begin.eq(a)?""+g.value:"-";return b+F}return b+"."}),o+=".",r=r.add(u)}n++}return s.join(`
`)}let Et;const Vn=e=>Et=e;class p{constructor(t){this.query=t,this._Pattern=!0}withValue(t){return new p(n=>this.query(n).map(r=>r.withValue(t)))}fmap(t){return this.withValue(t)}appWhole(t,n){const r=this,s=function(o){const i=r.query(o),l=n.query(o),u=function(h,c){const a=h.part.intersection(c.part);if(a!=null)return new O(t(h.whole,c.whole),a,h.value(c.value),c.combineContext(h))};return nt(i.map(h=>ke(l.map(c=>u(h,c)))))};return new p(s)}appBoth(t){const n=function(r,s){if(!(r==null||s==null))return r.intersection_e(s)};return this.appWhole(n,t)}appLeft(t){const n=this,r=function(s){const o=[];for(const i of n.query(s)){const l=t.query(s.setSpan(i.wholeOrPart()));for(const u of l){const h=i.whole,c=i.part.intersection(u.part);if(c){const a=i.value(u.value),y=u.combineContext(i),w=new O(h,c,a,y);o.push(w)}}}return o};return new p(r)}appRight(t){const n=this,r=function(s){const o=[];for(const i of t.query(s)){const l=n.query(s.setSpan(i.wholeOrPart()));for(const u of l){const h=i.whole,c=u.part.intersection(i.part);if(c){const a=u.value(i.value),y=i.combineContext(u),w=new O(h,c,a,y);o.push(w)}}}return o};return new p(r)}bindWhole(t,n){const r=this,s=function(o){const i=function(u,h){return new O(t(u.whole,h.whole),h.part,h.value,Object.assign({},u.context,h.context,{locations:(u.context.locations||[]).concat(h.context.locations||[])}))},l=function(u){return n(u.value).query(o.setSpan(u.part)).map(h=>i(u,h))};return nt(r.query(o).map(u=>l(u)))};return new p(s)}bind(t){const n=function(r,s){if(!(r==null||s==null))return r.intersection_e(s)};return this.bindWhole(n,t)}join(){return this.bind(ut)}outerBind(t){return this.bindWhole(n=>n,t)}outerJoin(){return this.outerBind(ut)}innerBind(t){return this.bindWhole((n,r)=>r,t)}innerJoin(){return this.innerBind(ut)}trigJoin(t=!1){const n=this;return new p(r=>n.discreteOnly().query(r).map(s=>s.value.late(t?s.whole.begin:s.whole.begin.cyclePos()).query(r).map(o=>new O(o.whole?o.whole.intersection(s.whole):void 0,o.part.intersection(s.part),o.value).setContext(s.combineContext(o))).filter(o=>o.part)).flat())}trigzeroJoin(){return this.trigJoin(!0)}squeezeJoin(){const t=this;function n(r){const s=t.discreteOnly().query(r);function o(l){const h=l.value._focusSpan(l.wholeOrPart()).query(r.setSpan(l.part));function c(a,y){let w;if(y.whole&&a.whole&&(w=y.whole.intersection(a.whole),!w))return;const _=y.part.intersection(a.part);if(!_)return;const b=y.combineContext(a);return new O(w,_,y.value,b)}return h.map(a=>c(l,a))}return nt(s.map(o)).filter(l=>l)}return new p(n)}squeezeBind(t){return this.fmap(t).squeezeJoin()}queryArc(t,n,r={}){try{return this.query(new st(new T(t,n),r))}catch(s){return I(`[query]: ${s.message}`,"error"),[]}}splitQueries(){const t=this,n=r=>nt(r.span.spanCycles.map(s=>t.query(r.setSpan(s))));return new p(n)}withQuerySpan(t){return new p(n=>this.query(n.withSpan(t)))}withQuerySpanMaybe(t){const n=this;return new p(r=>{const s=r.withSpan(t);return s.span?n.query(s):[]})}withQueryTime(t){return new p(n=>this.query(n.withSpan(r=>r.withTime(t))))}withHapSpan(t){return new p(n=>this.query(n).map(r=>r.withSpan(t)))}withHapTime(t){return this.withHapSpan(n=>n.withTime(t))}withHaps(t){return new p(n=>t(this.query(n),n))}withHap(t){return this.withHaps(n=>n.map(t))}setContext(t){return this.withHap(n=>n.setContext(t))}withContext(t){return this.withHap(n=>n.setContext(t(n.context)))}stripContext(){return this.withHap(t=>t.setContext({}))}withLoc(t,n){const r={start:t,end:n};return this.withContext(s=>{const o=(s.locations||[]).concat([r]);return{...s,locations:o}})}filterHaps(t){return new p(n=>this.query(n).filter(t))}filterValues(t){return new p(n=>this.query(n).filter(r=>t(r.value)))}removeUndefineds(){return this.filterValues(t=>t!=null)}onsetsOnly(){return this.filterHaps(t=>t.hasOnset())}discreteOnly(){return this.filterHaps(t=>t.whole)}defragmentHaps(){return this.discreteOnly().withHaps(n=>{const r=[];for(var s=0;s<n.length;++s){for(var o=!0,i=n[s];o;){const h=JSON.stringify(n[s].value);for(var l=!1,u=s+1;u<n.length;u++){const c=n[u];if(i.whole.equals(c.whole)){if(i.part.begin.eq(c.part.end)){if(h===JSON.stringify(c.value)){i=new O(i.whole,new T(c.part.begin,i.part.end),i.value),n.splice(u,1),l=!0;break}}else if(c.part.begin.eq(i.part.end)&&h==JSON.stringify(c.value)){i=new O(i.whole,new T(i.part.begin,c.part.end),i.value),n.splice(u,1),l=!0;break}}}o=l}r.push(i)}return r})}firstCycle(t=!1){var n=this;return t||(n=n.stripContext()),n.query(new st(new T(v(0),v(1))))}get firstCycleValues(){return this.firstCycle().map(t=>t.value)}get showFirstCycle(){return this.firstCycle().map(t=>`${t.value}: ${t.whole.begin.toFraction()} - ${t.whole.end.toFraction()}`)}sortHapsByPart(){return this.withHaps(t=>t.sort((n,r)=>n.part.begin.sub(r.part.begin).or(n.part.end.sub(r.part.end)).or(n.whole.begin.sub(r.whole.begin).or(n.whole.end.sub(r.whole.end)))))}asNumber(){return this.fmap(Jt)}_opIn(t,n){return this.fmap(n).appLeft(m(t))}_opOut(t,n){return this.fmap(n).appRight(m(t))}_opMix(t,n){return this.fmap(n).appBoth(m(t))}_opSqueeze(t,n){const r=m(t);return this.fmap(s=>r.fmap(o=>n(s)(o))).squeezeJoin()}_opSqueezeOut(t,n){const r=this;return m(t).fmap(o=>r.fmap(i=>n(i)(o))).squeezeJoin()}_opTrig(t,n){return m(t).fmap(s=>this.fmap(o=>n(o)(s))).trigJoin()}_opTrigzero(t,n){return m(t).fmap(s=>this.fmap(o=>n(o)(s))).trigzeroJoin()}layer(...t){return j(...t.map(n=>n(this)))}superimpose(...t){return this.stack(...t.map(n=>n(this)))}stack(...t){return j(this,...t)}sequence(...t){return G(this,...t)}seq(...t){return G(this,...t)}cat(...t){return Gt(this,...t)}fastcat(...t){return tt(this,...t)}slowcat(...t){return Y(this,...t)}onTrigger(t,n=!0){return this.withHap(r=>r.setContext({...r.context,onTrigger:(...s)=>{r.context.onTrigger?.(...s),t(...s)},dominantTrigger:r.context.dominantTrigger||n}))}log(t=(r,s)=>`[hap] ${s.showWhole(!0)}`,n=(r,s)=>({hap:s})){return this.onTrigger((...r)=>{I(t(...r),void 0,n(...r))},!1)}logValues(t=ut){return this.log((n,r)=>t(r.value))}drawLine(){return console.log(Te(this)),this}}function Gn(e,t){let n=[];return t.forEach(r=>{const s=n.findIndex(([o])=>e(r,o));s===-1?n.push([r]):n[s].push(r)}),n}const Qn=(e,t)=>e.spanEquals(t);p.prototype.collect=function(){return this.withHaps(e=>Gn(Qn,e).map(t=>new O(t[0].whole,t[0].part,t,{})))};p.prototype.arpWith=function(e){return this.collect().fmap(t=>m(e(t))).innerJoin().withHap(t=>new O(t.whole,t.part,t.value.value,t.combineContext(t.value)))};p.prototype.arp=function(e){return this.arpWith(t=>e.fmap(n=>t[n%t.length]))};function Un(e,t,n){function r(s){return s instanceof Object&&!(s instanceof Function)}return r(e)||r(t)?(r(e)||(e={value:e}),r(t)||(t={value:t}),Dn(e,t,n)):n(e,t)}(function(){const e={set:[(n,r)=>r],keep:[n=>n],keepif:[(n,r)=>r?n:void 0],add:[D((n,r)=>n+r)],sub:[D((n,r)=>n-r)],mul:[D((n,r)=>n*r)],div:[D((n,r)=>n/r)],mod:[D(bt)],pow:[D(Math.pow)],band:[D((n,r)=>n&r)],bor:[D((n,r)=>n|r)],bxor:[D((n,r)=>n^r)],blshift:[D((n,r)=>n<<r)],brshift:[D((n,r)=>n>>r)],lt:[(n,r)=>n<r],gt:[(n,r)=>n>r],lte:[(n,r)=>n<=r],gte:[(n,r)=>n>=r],eq:[(n,r)=>n==r],eqt:[(n,r)=>n===r],ne:[(n,r)=>n!=r],net:[(n,r)=>n!==r],and:[(n,r)=>n&&r],or:[(n,r)=>n||r],func:[(n,r)=>r(n)]},t=["In","Out","Mix","Squeeze","SqueezeOut","Trig","Trigzero"];for(const[n,[r,s]]of Object.entries(e)){p.prototype["_"+n]=function(o){return this.fmap(i=>r(i,o))},Object.defineProperty(p.prototype,n,{get:function(){const o=this,i=(...l)=>o[n].in(...l);for(const l of t)i[l.toLowerCase()]=function(...u){var h=o;u=G(u),s&&(h=s(h),u=s(u));var c;return n==="keepif"?(c=h["_op"+l](u,a=>y=>r(a,y)),c=c.removeUndefineds()):c=h["_op"+l](u,a=>y=>Un(a,y,r)),c};return i.squeezein=i.squeeze,i}});for(const o of t)p.prototype[o.toLowerCase()]=function(...i){return this.set[o.toLowerCase()](i)}}p.prototype.struct=function(...n){return this.keepif.out(...n)},p.prototype.structAll=function(...n){return this.keep.out(...n)},p.prototype.mask=function(...n){return this.keepif.in(...n)},p.prototype.maskAll=function(...n){return this.keep.in(...n)},p.prototype.reset=function(...n){return this.keepif.trig(...n)},p.prototype.resetAll=function(...n){return this.keep.trig(...n)},p.prototype.restart=function(...n){return this.keepif.trigzero(...n)},p.prototype.restartAll=function(...n){return this.keep.trigzero(...n)}})();const Oe=j,Be=j,Ee=Qt;p.prototype.factories={pure:Q,stack:j,slowcat:Y,fastcat:tt,cat:Gt,timeCat:St,sequence:G,seq:Pe,polymeter:Qt,pm:Ee,polyrhythm:Oe,pr:Be};const E=new p(()=>[]);function Q(e){function t(n){return n.span.spanCycles.map(r=>new O(v(r.begin).wholeCycle(),r,e))}return new p(t)}function Dt(e){return e instanceof p||e?._Pattern}function m(e){return Dt(e)?e:Et&&typeof e=="string"?Et(e):Q(e)}function j(...e){e=e.map(n=>Array.isArray(n)?G(...n):m(n));const t=n=>nt(e.map(r=>r.query(n)));return new p(t)}function Y(...e){e=e.map(n=>Array.isArray(n)?G(...n):m(n));const t=function(n){const r=n.span,s=bt(r.begin.sam(),e.length),o=e[s];if(!o)return[];const i=r.begin.floor().sub(r.begin.div(e.length).floor());return o.withHapTime(l=>l.add(i)).query(n.setSpan(r.withTime(l=>l.sub(i))))};return new p(t).splitQueries()}function Vt(...e){e=e.map(m);const t=function(n){const r=Math.floor(n.span.begin)%e.length;return e[r]?.query(n)||[]};return new p(t).splitQueries()}function Gt(...e){return Y(...e)}function St(...e){const t=e.map(s=>s[0]).reduce((s,o)=>s.add(o),v(0));let n=v(0);const r=[];for(const[s,o]of e){const i=n.add(s);r.push(m(o)._compress(n.div(t),i.div(t))),n=i}return j(...r)}function Kn(...e){const t=e.reduce((n,[r])=>n+r,0);return e=e.map(([n,r])=>[n,r.fast(n)]),St(...e).slow(t)}function tt(...e){return Y(...e)._fast(e.length)}function G(...e){return tt(...e)}function Pe(...e){return tt(...e)}function Pt(e){return Array.isArray(e)?e.length==0?[E,0]:e.length==1?Pt(e[0]):[tt(...e.map(t=>Pt(t)[0])),e.length]:[m(e),1]}function ze(e,...t){const n=t.map(s=>Pt(s));if(n.length==0)return E;e==0&&(e=n[0][1]);const r=[];for(const s of n)s[1]!=0&&(e==s[1]?r.push(s[0]):r.push(s[0]._fast(v(e).div(v(s[1])))));return j(...r)}function Qt(...e){return ze(0,...e)}const Zn=A((e,t)=>m(t).mask(e)),Xn=A((e,t)=>m(t).struct(e)),Yn=A((e,t)=>m(t).superimpose(...e)),tr=A((e,t)=>m(t).set(e)),er=A((e,t)=>m(t).keep(e)),nr=A((e,t)=>m(t).keepif(e)),rr=A((e,t)=>m(t).add(e)),sr=A((e,t)=>m(t).sub(e)),or=A((e,t)=>m(t).mul(e)),ir=A((e,t)=>m(t).div(e)),cr=A((e,t)=>m(t).mod(e)),ar=A((e,t)=>m(t).pow(e)),ur=A((e,t)=>m(t).band(e)),lr=A((e,t)=>m(t).bor(e)),fr=A((e,t)=>m(t).bxor(e)),hr=A((e,t)=>m(t).blshift(e)),pr=A((e,t)=>m(t).brshift(e)),dr=A((e,t)=>m(t).lt(e)),mr=A((e,t)=>m(t).gt(e)),wr=A((e,t)=>m(t).lte(e)),yr=A((e,t)=>m(t).gte(e)),gr=A((e,t)=>m(t).eq(e)),br=A((e,t)=>m(t).eqt(e)),vr=A((e,t)=>m(t).ne(e)),_r=A((e,t)=>m(t).net(e)),qr=A((e,t)=>m(t).and(e)),Ar=A((e,t)=>m(t).or(e)),kr=A((e,t)=>m(t).func(e));function f(e,t,n=!0){if(Array.isArray(e)){const o={};for(const i of e)o[i]=f(i,t,n);return o}const r=t.length;var s;return n?s=function(...o){o=o.map(m);const i=o[o.length-1];if(r===1)return t(i);const[l,...u]=o.slice(0,-1);let h=(...c)=>(Array(r-1).fill().map((a,y)=>c[y]??void 0),t(...c,i));return h=A(h,null,r-1),u.reduce((c,a)=>c.appLeft(a),l.fmap(h)).innerJoin()}:s=function(...o){return o=o.map(m),t(...o)},p.prototype[e]=function(...o){if(r===2&&o.length!==1)o=[G(...o)];else if(r!==o.length+1)throw new Error(`.${e}() expects ${r-1} inputs but got ${o.length}.`);return o=o.map(m),s(...o,this)},r>1&&(p.prototype["_"+e]=function(...o){return t(...o,this)}),A(s,null,r)}const Nr=f("round",function(e){return e.asNumber().fmap(t=>Math.round(t))}),Cr=f("floor",function(e){return e.asNumber().fmap(t=>Math.floor(t))}),Sr=f("ceil",function(e){return e.asNumber().fmap(t=>Math.ceil(t))}),xr=f("toBipolar",function(e){return e.fmap(t=>t*2-1)}),Mr=f("fromBipolar",function(e){return e.fmap(t=>(t+1)/2)}),Tr=f("range",function(e,t,n){return n.mul(t-e).add(e)}),Or=f("rangex",function(e,t,n){return n._range(Math.log(e),Math.log(t)).fmap(Math.exp)}),Br=f("range2",function(e,t,n){return n.fromBipolar()._range(e,t)}),Er=f("ratio",e=>e.fmap(t=>Array.isArray(t)?t.slice(1).reduce((n,r)=>n/r,t[0]):t)),Pr=f("compress",function(e,t,n){return e=v(e),t=v(t),e.gt(t)||e.gt(1)||t.gt(1)||e.lt(0)||t.lt(0)?E:n._fastGap(v(1).div(t.sub(e)))._late(e)}),{compressSpan:zr,compressspan:jr}=f(["compressSpan","compressspan"],function(e,t){return t._compress(e.begin,e.end)}),{fastGap:Fr,fastgap:$r}=f(["fastGap","fastgap"],function(e,t){const n=function(s){const o=s.begin.sam(),i=s.begin.sub(o).mul(e).min(1),l=s.end.sub(o).mul(e).min(1);if(!(i>=1))return new T(o.add(i),o.add(l))},r=function(s){const o=s.part.begin,i=s.part.end,l=o.sam(),u=o.sub(l).div(e).min(1),h=i.sub(l).div(e).min(1),c=new T(l.add(u),l.add(h)),a=s.whole?new T(c.begin.sub(o.sub(s.whole.begin).div(e)),c.end.add(s.whole.end.sub(i).div(e))):void 0;return new O(a,c,s.value,s.context)};return t.withQuerySpanMaybe(n).withHap(r).splitQueries()}),Lr=f("focus",function(e,t,n){return e=v(e),t=v(t),n._fast(v(1).div(t.sub(e))).late(e.cyclePos())}),{focusSpan:Hr,focusspan:Jr}=f(["focusSpan","focusspan"],function(e,t){return t._focus(e.begin,e.end)}),Ir=f("ply",function(e,t){return t.fmap(n=>Q(n)._fast(e)).squeezeJoin()}),{fast:Wr,density:Rr}=f(["fast","density"],function(e,t){return e===0?E:(e=v(e),t.withQueryTime(r=>r.mul(e)).withHapTime(r=>r.div(e)))}),Dr=f("hurry",function(e,t){return t._fast(e).mul(Q({speed:e}))}),{slow:Vr,sparsity:Gr}=f(["slow","sparsity"],function(e,t){return e===0?E:t._fast(v(1).div(e))}),Qr=f("inside",function(e,t,n){return t(n._slow(e))._fast(e)}),Ur=f("outside",function(e,t,n){return t(n._fast(e))._slow(e)}),Kr=f("lastOf",function(e,t,n){const r=Array(e-1).fill(n);return r.push(t(n)),Vt(...r)}),{firstOf:Zr,every:Xr}=f(["firstOf","every"],function(e,t,n){const r=Array(e-1).fill(n);return r.unshift(t(n)),Vt(...r)}),Yr=f("apply",function(e,t){return e(t)}),ts=f("cpm",function(e,t){return t._fast(e/60/1)}),es=f("early",function(e,t){return e=v(e),t.withQueryTime(n=>n.add(e)).withHapTime(n=>n.sub(e))}),ns=f("late",function(e,t){return e=v(e),t._early(v(0).sub(e))}),rs=f("zoom",function(e,t,n){t=v(t),e=v(e);const r=t.sub(e);return n.withQuerySpan(s=>s.withCycle(o=>o.mul(r).add(e))).withHapSpan(s=>s.withCycle(o=>o.sub(e).div(r))).splitQueries()}),{zoomArc:ss,zoomarc:os}=f(["zoomArc","zoomarc"],function(e,t){return t.zoom(e.begin,e.end)}),is=f("linger",function(e,t){return e==0?E:e<0?t._zoom(e.add(1),1)._slow(e):t._zoom(0,e)._slow(e)}),cs=f("segment",function(e,t){return t.struct(Q(!0)._fast(e))}),{invert:as,inv:us}=f(["invert","inv"],function(e){return e.fmap(t=>!t)}),ls=f("when",function(e,t,n){return e?t(n):n}),fs=f("off",function(e,t,n){return j(n,t(n.late(e)))}),hs=f("brak",function(e){return e.when(Y(!1,!0),t=>tt(t,E)._late(.25))}),je=f("rev",function(e){const t=function(n){const r=n.span,s=r.begin.sam(),o=r.begin.nextSam(),i=function(u){const h=u.withTime(a=>s.add(o.sub(a))),c=h.begin;return h.begin=h.end,h.end=c,h};return e.query(n.setSpan(i(r))).map(u=>u.withSpan(i))};return new p(t).splitQueries()}),ps=f("pressBy",function(e,t){return t.fmap(n=>Q(n).compress(e,1)).squeezeJoin()}),ds=f("press",function(e){return e._pressBy(.5)});p.prototype.hush=function(){return E};const ms=f("palindrome",function(e){return e.lastOf(2,je)}),{juxBy:ws,juxby:ys}=f(["juxBy","juxby"],function(e,t,n){e/=2;const r=function(i,l,u){return l in i?i[l]:u},s=n.withValue(i=>Object.assign({},i,{pan:r(i,"pan",.5)-e})),o=n.withValue(i=>Object.assign({},i,{pan:r(i,"pan",.5)+e}));return j(s,t(o))}),gs=f("jux",function(e,t){return t._juxBy(1,e,t)}),{echoWith:bs,echowith:vs,stutWith:_s,stutwith:qs}=f(["echoWith","echowith","stutWith","stutwith"],function(e,t,n,r){return j(...Ht(0,e-1).map(s=>n(r.late(v(t).mul(s)),s)))}),As=f("echo",function(e,t,n,r){return r._echoWith(e,t,(s,o)=>s.velocity(Math.pow(n,o)))}),ks=f("stut",function(e,t,n,r){return r._echoWith(e,n,(s,o)=>s.velocity(Math.pow(t,o)))}),Ut=function(e,t,n=!1){return e=v(e),Y(...Ht(0,e.sub(1)).map(r=>n?t.late(v(r).div(e)):t.early(v(r).div(e))))},Ns=f("iter",function(e,t){return Ut(e,t,!1)}),{iterBack:Cs,iterback:Ss}=f(["iterBack","iterback"],function(e,t){return Ut(e,t,!0)}),xs=function(e,t){return Y(...Array(e).fill(t))};f("repeatCycles",xs);const Kt=function(e,t,n,r=!1,s=!1){const o=Array(e-1).fill(!1);o.unshift(!0);const i=Ut(e,G(...o),!r);return s||(n=n.repeatCycles(e)),n.when(i,t)};f(["chunk","slowchunk","slowChunk"],function(e,t,n){return Kt(e,t,n,!1,!1)});const{chunkBack:Ms,chunkback:Ts}=f(["chunkBack","chunkback"],function(e,t,n){return Kt(e,t,n,!0)}),{fastchunk:Os,fastChunk:Bs}=f(["fastchunk","fastChunk"],function(e,t,n){return Kt(e,t,n,!1,!0)}),Es=f("bypass",function(e,t){return e=!!parseInt(e),e?E:t}),Ps=f("ribbon",(e,t,n)=>n.early(e).restart(Q(1).slow(t))),zs=f("duration",function(e,t){return t.withHapSpan(n=>new T(n.begin,n.begin.add(e)))}),js=f("hsla",(e,t,n,r,s)=>s.color(`hsla(${e}turn,${t*100}%,${n*100}%,${r})`)),Fs=f("hsl",(e,t,n,r)=>r.color(`hsl(${e}turn,${t*100}%,${n*100}%)`)),{color:$s,colour:Ls}=f(["color","colour"],function(e,t){return t.withContext(n=>({...n,color:e}))}),Hs=f("velocity",function(e,t){return t.withContext(n=>({...n,velocity:(n.velocity||1)*e}))}),Js=f("legato",function(e,t){return e=v(e),t.withHapSpan(n=>new T(n.begin,n.begin.add(n.end.sub(n.begin).mul(e))))}),Is=f("chop",function(e,t){const r=Array.from({length:e},(o,i)=>i).map(o=>({begin:o/e,end:(o+1)/e})),s=function(o){return G(r.map(i=>Object.assign({},o,i)))};return t.squeezeBind(s)}),Ws=f("striate",function(e,t){const r=Array.from({length:e},(o,i)=>i).map(o=>({begin:o/e,end:(o+1)/e})),s=Y(...r);return t.set(s)._fast(e)}),Fe=function(e,t,n=.5){return t.speed(1/e*n).unit("c").slow(e)},$e=f("slice",function(e,t,n){return e.innerBind(r=>t.outerBind(s=>n.outerBind(o=>{o=o instanceof Object?o:{s:o};const i=Array.isArray(r)?r[s]:s/r,l=Array.isArray(r)?r[s+1]:(s+1)/r;return Q({begin:i,end:l,_slices:r,...o})})))},!1),Rs=f("splice",function(e,t,n){const r=$e(e,t,n);return new p(s=>{const o=s.controls._cps||1;return r.query(s).map(l=>l.withValue(u=>({speed:o/u._slices/l.whole.duration*(u.speed||1),unit:"c",...u})))})},!1),{loopAt:Ds,loopat:Vs}=f(["loopAt","loopat"],function(e,t){return new p(n=>Fe(e,t,n.controls._cps).query(n))}),Gs=f("fit",e=>e.withHaps((t,n)=>t.map(r=>r.withValue(s=>({...s,speed:(n.controls._cps||1)/r.whole.duration,unit:"c"}))))),{loopAtCps:Qs,loopatcps:Us}=f(["loopAtCps","loopatcps"],function(e,t,n){return Fe(e,n,t)}),Ks=e=>Q(1).withValue(()=>m(e())).innerJoin();let pe=e=>e<.5?1:1-(e-.5)/.5,Le=(e,t,n)=>{t=m(t),e=m(e),n=m(n);let r=t.fmap(o=>({gain:pe(o)})),s=t.fmap(o=>({gain:pe(1-o)}));return j(e.mul(r),n.mul(s))};p.prototype.xfade=function(e,t){return Le(this,e,t)};const W={},Zs=[[["s","n","gain"],"sound"],["source","src"],["n"],[["note","n"]],["accelerate"],["gain"],["postgain"],["amp"],["attack","att"],[["fmh","fmi"],"fmh"],[["fmi","fmh"],"fm"],["fmenv"],["fmattack"],["fmdecay"],["fmsustain"],["fmrelease"],["fmvelocity"],["bank"],["analyze"],["fft"],["decay","dec"],["sustain","sus"],["release","rel"],["hold"],[["bandf","bandq","bpenv"],"bpf","bp"],["bandq","bpq"],["begin"],["end"],["loop"],["loopBegin","loopb"],["loopEnd","loope"],["crush"],["coarse"],["channels","ch"],["phaserrate","phasr"],[["phaser","phaserdepth","phasercenter","phasersweep"],"ph"],["phasersweep","phs"],["phasercenter","phc"],["phaserdepth","phd","phasdp"],["channel"],["cut"],[["cutoff","resonance","lpenv"],"ctf","lpf","lp"],["lpenv","lpe"],["hpenv","hpe"],["bpenv","bpe"],["lpattack","lpa"],["hpattack","hpa"],["bpattack","bpa"],["lpdecay","lpd"],["hpdecay","hpd"],["bpdecay","bpd"],["lpsustain","lps"],["hpsustain","hps"],["bpsustain","bps"],["lprelease","lpr"],["hprelease","hpr"],["bprelease","bpr"],["ftype"],["fanchor"],[["vib","vibmod"],"vibrato","v"],["noise"],[["vibmod","vib"],"vmod"],[["hcutoff","hresonance","hpenv"],"hpf","hp"],["hresonance","hpq"],["resonance","lpq"],["djf"],[["delay","delaytime","delayfeedback"]],["delayfeedback","delayfb","dfb"],["delaytime","delayt","dt"],["lock"],["detune","det"],["dry"],["fadeTime","fadeOutTime"],["fadeInTime"],["freq"],["pattack","patt"],["pdecay","pdec"],["psustain","psus"],["prelease","prel"],["penv"],["pcurve"],["panchor"],["gate","gat"],["leslie"],["lrate"],["lsize"],["activeLabel"],[["label","activeLabel"]],["degree"],["mtranspose"],["ctranspose"],["harmonic"],["stepsPerOctave"],["octaveR"],["nudge"],["octave"],["orbit"],["overgain"],["overshape"],["pan"],["panspan"],["pansplay"],["panwidth"],["panorient"],["rate"],["slide"],["semitone"],["voice"],["chord"],["dictionary","dict"],["anchor"],["offset"],["octaves"],[["mode","anchor"]],[["room","size"]],["roomlp","rlp"],["roomdim","rdim"],["roomfade","rfade"],[["ir","i"],"iresponse"],["roomsize","size","sz","rsize"],["shape"],[["compressor","compressorRatio","compressorKnee","compressorAttack","compressorRelease"]],["compressorKnee"],["compressorRatio"],["compressorAttack"],["compressorRelease"],["speed"],["unit"],["squiz"],["vowel"],["waveloss"],["density"],["dur"],["expression"],["sustainpedal"],["tremolodepth","tremdp"],["tremolorate","tremr"],["fshift"],["fshiftnote"],["fshiftphase"],["triode"],["krush"],["kcutoff"],["octer"],["octersub"],["octersubsub"],["ring"],["ringf"],["ringdf"],["distort"],["freeze"],["xsdelay"],["tsdelay"],["real"],["imag"],["enhance"],["partials"],["comb"],["smear"],["scram"],["binshift"],["hbrick"],["lbrick"],["midichan"],["control"],["ccn"],["ccv"],["polyTouch"],["midibend"],["miditouch"],["ctlNum"],["frameRate"],["frames"],["hours"],["midicmd"],["minutes"],["progNum"],["seconds"],["songPtr"],["uid"],["val"],["cps"],["clip"],["zrand"],["curve"],["slide"],["deltaSlide"],["pitchJump"],["pitchJumpTime"],["lfo","repeatTime"],["znoise"],["zmod"],["zcrush"],["zdelay"],["tremolo"],["zzfx"]];W.createParam=function(e){const t=Array.isArray(e)?e[0]:e;var n;Array.isArray(e)?n=o=>{if(Array.isArray(o)){const i={};return o.forEach((l,u)=>{u<e.length&&(i[e[u]]=l)}),i}else return{[t]:o}}:n=o=>({[t]:o});const r=(...o)=>G(...o).withValue(n),s=function(...o){return o.length?this.set(r(...o)):this.fmap(n)};return p.prototype[t]=s,r};Zs.forEach(([e,...t])=>{const n=Array.isArray(e)?e[0]:e;W[n]=W.createParam(e),t.forEach(r=>{W[r]=W[n],p.prototype[r]=p.prototype[n]})});W.createParams=(...e)=>e.reduce((t,n)=>Object.assign(t,{[n]:W.createParam(n)}),{});W.adsr=f("adsr",(e,t)=>{e=Array.isArray(e)?e:[e];const[n,r,s,o]=e;return t.set({attack:n,decay:r,sustain:s,release:o})});W.ad=f("ad",(e,t)=>{e=Array.isArray(e)?e:[e];const[n,r=n]=e;return t.attack(n).decay(r)});W.ds=f("ds",(e,t)=>{e=Array.isArray(e)?e:[e];const[n,r=0]=e;return t.set({decay:n,sustain:r})});W.ds=f("ar",(e,t)=>{e=Array.isArray(e)?e:[e];const[n,r=n]=e;return t.set({attack:n,release:r})});const Xs=function(e,t){const[n,r]=e,[s,o]=t,[i,l]=Wt(r,s);return[[r,n-r],[Rt((u,h)=>u.concat(h),i,o),l]]},Ys=function(e,t){const[n,r]=e,[s,o]=t,[i,l]=Wt(n,o);return[[n,r-n],[Rt((h,c)=>h.concat(c),s,i),l]]},He=function(e,t){const[n,r]=e;return Math.min(n,r)<=1?[e,t]:He(...n>r?Xs(e,t):Ys(e,t))},Je=function(e,t){const n=t-e,r=Array(e).fill([1]),s=Array(n).fill([0]),o=He([e,n],[r,s]);return nt(o[1][0]).concat(nt(o[1][1]))},Zt=function(e,t,n){const r=Je(e,t);return n?qe(r,-n):r},to=f("euclid",function(e,t,n){return n.struct(Zt(e,t,0))}),{euclidrot:eo,euclidRot:no}=f(["euclidrot","euclidRot"],function(e,t,n,r){return r.struct(Zt(e,t,n))}),Ie=function(e,t,n,r){if(e<1)return E;const o=Zt(e,t,n).join("").split("1").slice(1).map(i=>[i.length+1,!0]);return r.struct(St(...o))},ro=f(["euclidLegato"],function(e,t,n){return Ie(e,t,0,n)}),so=f(["euclidLegatoRot"],function(e,t,n,r){return Ie(e,t,n,r)});function oo(e){return new p(t=>[new O(void 0,t.span,e)])}const ot=e=>{const t=n=>[new O(void 0,n.span,e(n.span.midpoint()))];return new p(t)},Xt=ot(e=>1-e%1),We=Xt.toBipolar(),xt=ot(e=>e%1),Re=xt.toBipolar(),Yt=ot(e=>Math.sin(Math.PI*2*e)),De=Yt.fromBipolar(),io=De._early(v(1).div(4)),co=Yt._early(v(1).div(4)),Ve=ot(e=>Math.floor(e*2%2)),ao=Ve.toBipolar(),uo=tt(Xt,xt),lo=tt(We,Re),Ge=ot(ut),fo=e=>{const t=e<<13^e,n=t>>17^t;return n<<5^n},ho=e=>e-Math.trunc(e),po=e=>fo(Math.trunc(ho(e/300)*536870912)),mo=e=>e%536870912/536870912,zt=e=>Math.abs(mo(po(e))),wo=e=>xt.range(0,e).floor().segment(e),V=ot(zt),yo=V.toBipolar(),te=e=>V.fmap(t=>t<e),go=e=>m(e).fmap(te).innerJoin(),bo=te(.5),Qe=e=>V.fmap(t=>Math.trunc(t*e)),vo=e=>m(e).fmap(Qe).innerJoin(),Mt=function(e,t,n=!0){const r=Array.isArray(e),s=Object.keys(e).length;return e=Me(e,m),s===0?E:t.fmap(o=>{let i=o;return r&&(i=n?Math.round(i)%s:Ce(Math.round(i),0,e.length-1)),e[i]})},Ue=function(e,t){return Array.isArray(t)&&([t,e]=[e,t]),_o(e,t)},_o=f("pick",function(e,t){return Mt(e,t,!1).innerJoin()}),Ke=f("pickmod",function(e,t){return Mt(e,t,!0).innerJoin()}),qo=f("pickF",function(e,t,n){return n.apply(Ue(e,t))}),Ao=f("pickmodF",function(e,t,n){return n.apply(Ke(e,t))}),ko=f("inhabit",function(e,t){return Mt(e,t,!0).squeezeJoin()}),No=f("inhabit",function(e,t){return Mt(e,t,!1).squeezeJoin()}),Co=(e,t)=>(t=t.map(m),t.length==0?E:e.fmap(n=>{const r=bt(Math.round(n),t.length);return t[r]}).squeezeJoin()),ee=(e,t)=>(t=t.map(m),t.length==0?E:e.range(0,t.length).fmap(n=>{const r=Math.min(Math.max(Math.floor(n),0),t.length-1);return t[r]})),Tt=(e,t)=>ee(e,t).outerJoin(),Ze=(e,t)=>ee(e,t).innerJoin(),So=(...e)=>Tt(V,e);p.prototype.choose=function(...e){return Tt(this,e)};p.prototype.choose2=function(...e){return Tt(this.fromBipolar(),e)};const Xe=(...e)=>Ze(V.segment(1),e),xo=Xe,Ye=function(e,...t){const n=t.map(l=>m(l[0])),r=[];let s=0;for(const l of t)s+=l[1],r.push(s);const o=s,i=function(l){const u=l*o;return n[r.findIndex(h=>h>u,r)]};return e.fmap(i)},Mo=(...e)=>Ye(...e).outerJoin(),To=(...e)=>Mo(V,...e),Oo=(...e)=>Ye(V,...e).innerJoin(),tn=e=>{const t=e.fmap(Math.floor),n=e.fmap(o=>Math.floor(o)+1),r=o=>6*o**5-15*o**4+10*o**3,s=o=>i=>l=>i+r(o)*(l-i);return e.sub(t).fmap(s).appBoth(t.fmap(zt)).appBoth(n.fmap(zt))},Bo=tn(Ge.fmap(e=>Number(e))),Eo=f("degradeByWith",(e,t,n)=>n.fmap(r=>s=>r).appLeft(e.filterValues(r=>r>t))),Po=f("degradeBy",function(e,t){return t._degradeByWith(V,e)}),zo=f("degrade",e=>e._degradeBy(.5)),jo=f("undegradeBy",function(e,t){return t._degradeByWith(V.fmap(n=>1-n),e)}),Fo=f("undegrade",e=>e._undegradeBy(.5)),$o=f("sometimesBy",function(e,t,n){return m(e).fmap(r=>j(n._degradeBy(r),t(n._undegradeBy(1-r)))).innerJoin()}),Lo=f("sometimes",function(e,t){return t._sometimesBy(.5,e)}),Ho=f("someCyclesBy",function(e,t,n){return m(e).fmap(r=>j(n._degradeByWith(V._segment(1),r),t(n._degradeByWith(V.fmap(s=>1-s)._segment(1),1-r)))).innerJoin()}),Jo=f("someCycles",function(e,t){return t._someCyclesBy(.5,e)}),Io=f("often",function(e,t){return t.sometimesBy(.75,e)}),Wo=f("rarely",function(e,t){return t.sometimesBy(.25,e)}),Ro=f("almostNever",function(e,t){return t.sometimesBy(.1,e)}),Do=f("almostAlways",function(e,t){return t.sometimesBy(.9,e)}),Vo=f("never",function(e,t){return t}),Go=f("always",function(e,t){return e(t)});let Nt;try{Nt=window?.speechSynthesis}catch{console.warn("cannot use window: not in browser?")}let de=Nt?.getVoices();function Qo(e,t,n){Nt.cancel();const r=new SpeechSynthesisUtterance(e);r.lang=t,de=Nt.getVoices();const s=de.filter(o=>o.lang.includes(t));typeof n=="number"?r.voice=s[n%s.length]:typeof n=="string"&&(r.voice=s.find(o=>o.name===o)),speechSynthesis.speak(r)}const Uo=f("speak",function(e,t,n){return n.onTrigger((r,s)=>{Qo(s.value,e,t)})}),en=async(...e)=>{const t=await Promise.allSettled(e),n=t.filter(r=>r.status==="fulfilled").map(r=>r.value);t.forEach((r,s)=>{r.status==="rejected"&&console.warn(`evalScope: module with index ${s} could not be loaded:`,r.reason)}),n.forEach(r=>{Object.entries(r).forEach(([s,o])=>{globalThis[s]=o})})};function Ko(e,t={}){const{wrapExpression:n=!0,wrapAsync:r=!0}=t;n&&(e=`{${e}}`),r&&(e=`(async ()=>${e})()`);const s=`"use strict";return (${e})`;return Function(s)()}const nn=async(e,t)=>{let n={};if(t){const o=t(e);e=o.output,n=o}return{mode:"javascript",pattern:await Ko(e,{wrapExpression:!!t}),meta:n}};function Zo(e,t,n=.05,r=.1,s=.1){let o=0,i=0,l=10**4,u=.01;const h=g=>n=g(n);s=s||r/2;const c=()=>{const g=e(),P=g+r+s;for(i===0&&(i=g+u);i<P;)i=Math.round(i*l)/l,i>=g&&t(i,n,o),i<g&&console.log("TOO LATE",i),i+=n,o++};let a;const y=()=>{w(),c(),a=setInterval(c,r*1e3)},w=()=>a!==void 0&&clearInterval(a);return{setDuration:h,start:y,stop:()=>{o=0,i=0,w()},pause:()=>w(),duration:n,interval:r,getPhase:()=>i,minLatency:u}}class rn{constructor({interval:t,onTrigger:n,onToggle:r,onError:s,getTime:o,latency:i=.1}){this.started=!1,this.cps=.5,this.num_ticks_since_cps_change=0,this.lastTick=0,this.lastBegin=0,this.lastEnd=0,this.getTime=o,this.num_cycles_since_last_cps_change=0,this.onToggle=r,this.latency=i,this.clock=Zo(o,(u,h,c)=>{c===0&&(this.origin=u),this.num_ticks_since_cps_change===0&&(this.num_cycles_since_last_cps_change=this.lastEnd),this.num_ticks_since_cps_change++;try{const a=o(),y=this.lastEnd;this.lastBegin=y;const w=h*this.cps,_=this.num_cycles_since_last_cps_change+this.num_ticks_since_cps_change*w;this.lastEnd=_;const b=this.pattern.queryArc(y,_,{_cps:this.cps}),N=u-a;this.lastTick=a+N,b.forEach(g=>{if(g.part.begin.equals(g.whole.begin)){const P=(g.whole.begin-y)/this.cps+N+i,F=g.duration/this.cps;n?.(g,P,F,this.cps)}})}catch(a){I(`[cyclist] error: ${a.message}`),s?.(a)}},t);let l=this;globalThis.__cyclist__=l}now(){const t=this.getTime()-this.lastTick-this.clock.duration;return this.lastBegin+t*this.cps}setStarted(t){this.started=t,this.onToggle?.(t)}start(){if(this.num_ticks_since_cps_change=0,this.num_cycles_since_last_cps_change=0,!this.pattern)throw new Error("Scheduler: no pattern set! call .setPattern first.");I("[cyclist] start"),this.clock.start(),this.setStarted(!0),globalThis.haps_from_outputs=null}pause(){I("[cyclist] pause"),this.clock.pause(),this.setStarted(!1)}stop(){I("[cyclist] stop"),this.clock.stop(),this.lastEnd=0,this.setStarted(!1)}setPattern(t,n=!1){this.pattern=t,n&&!this.started&&this.start()}setCps(t=.5){this.cps!==t&&(this.cps=t,this.num_ticks_since_cps_change=0)}log(t,n,r){const s=r.filter(o=>o.hasOnset());console.log(`${t.toFixed(4)} - ${n.toFixed(4)} ${Array(s.length).fill("I").join("")}`)}}let jt;function ne(){if(!jt)throw new Error("no time set! use setTime to define a time source");return jt()}function sn(e){jt=e}function Xo({interval:e,defaultOutput:t,onSchedulerError:n,onEvalError:r,beforeEval:s,afterEval:o,getTime:i,transpiler:l,onToggle:u,editPattern:h,onUpdateState:c}){const a={schedulerError:void 0,evalError:void 0,code:"// LOADING",activeCode:"// LOADING",pattern:void 0,miniLocations:[],widgets:[],pending:!1,started:!1},y=q=>{Object.assign(a,q),a.isDirty=a.code!==a.activeCode,a.error=a.evalError||a.schedulerError,c?.(a)},w=new rn({interval:e,onTrigger:on({defaultOutput:t,getTime:i}),onError:n,getTime:i,onToggle:q=>{y({started:q}),u?.(q)}});let _={},b;const N=function(){return _={},b=void 0,E},g=(q,C=!0)=>{q=h?.(q)||q,w.setPattern(q,C)};sn(()=>w.now());const P=()=>w.stop(),F=()=>w.start(),K=()=>w.pause(),et=()=>w.toggle(),U=q=>w.setCps(q),rt=q=>w.setCps(q/60),ht=function(q){return b=q,E},pt=()=>{p.prototype.p=function(C){return _[C]=this,this},p.prototype.q=function(C){return E};try{for(let C=1;C<10;++C)Object.defineProperty(p.prototype,`d${C}`,{get(){return this.p(C)},configurable:!0}),Object.defineProperty(p.prototype,`p${C}`,{get(){return this.p(C)},configurable:!0}),p.prototype[`q${C}`]=E}catch(C){console.warn("injectPatternMethods: error:",C)}const q=f("cpm",function(C,Z){return Z._fast(C/60/w.cps)});en({all:ht,hush:N,cpm:q,setCps:U,setcps:U,setCpm:rt,setcpm:rt})};return{scheduler:w,evaluate:async(q,C=!0,Z=!0)=>{if(!q)throw new Error("no code to evaluate");try{y({code:q,pending:!0}),pt(),await s?.({code:q}),Z&&N();let{pattern:B,meta:$}=await nn(q,l);if(Object.keys(_).length&&(B=j(...Object.values(_))),b&&(B=b(B)),!Dt(B)){const it=`got "${typeof evaluated}" instead of pattern`;throw new Error(it+(typeof evaluated=="function"?", did you forget to call a function?":"."))}return I("[eval] code updated"),g(B,C),y({miniLocations:$?.miniLocations||[],widgets:$?.widgets||[],activeCode:q,pattern:B,evalError:void 0,schedulerError:void 0,pending:!1}),o?.({code:q,pattern:B,meta:$}),B}catch(B){I(`[eval] error: ${B.message}`,"error"),y({evalError:B,pending:!1}),r?.(B)}},start:F,stop:P,pause:K,setCps:U,setPattern:g,setCode:q=>y({code:q}),toggle:et,state:a}}const on=({getTime:e,defaultOutput:t})=>async(n,r,s,o)=>{try{(!n.context.onTrigger||!n.context.dominantTrigger)&&await t(n,r,s,o),n.context.onTrigger&&await n.context.onTrigger(e()+r,n,e(),o)}catch(i){I(`[cyclist] error: ${i.message}`,"error")}},Ot=(e="test-canvas")=>{let t=document.querySelector("#"+e);if(!t){t=document.createElement("canvas"),t.id=e,t.width=window.innerWidth*2,t.height=window.innerHeight*2,t.style="pointer-events:none;width:100%;height:100%;position:fixed;top:0;left:0",document.body.prepend(t);let r;window.addEventListener("resize",()=>{r&&clearTimeout(r),r=setTimeout(()=>{t.width=window.innerWidth*2,t.height=window.innerHeight*2},200)})}return t.getContext("2d")};p.prototype.draw=function(e,{from:t,to:n,onQuery:r}={}){if(typeof window>"u")return this;window.strudelAnimation&&cancelAnimationFrame(window.strudelAnimation);const s=Ot();let o,i=[];const l=u=>{const h=ne();if(t!==void 0&&n!==void 0){const c=Math.floor(h);if(o!==c){o=c;const a=c+t,y=c+n;setTimeout(()=>{i=this.query(new st(new T(a,y))).filter(Boolean).filter(w=>w.part.begin.equals(w.whole.begin)),r?.(i)},0)}}e(s,i,h,u),window.strudelAnimation=requestAnimationFrame(l)};return requestAnimationFrame(l),this};const Yo=(e=!0)=>{const t=Ot();e&&t.clearRect(0,0,t.canvas.width,t.canvas.width),window.strudelAnimation&&cancelAnimationFrame(window.strudelAnimation),window.strudelScheduler&&clearInterval(window.strudelScheduler)};p.prototype.onPaint=function(e){return this.context={onPaint:e},this};class cn{constructor(t,n){this.onFrame=t,this.onError=n}start(){const t=this;let n=requestAnimationFrame(function r(s){try{t.onFrame(s)}catch(o){t.onError(o)}n=requestAnimationFrame(r)});t.cancel=()=>{cancelAnimationFrame(n)}}stop(){this.cancel&&this.cancel()}}class ti{constructor(t,n){this.visibleHaps=[],this.lastFrame=null,this.drawTime=n,this.framer=new cn(()=>{if(!this.scheduler){console.warn("Drawer: no scheduler");return}const r=Math.abs(this.drawTime[0]),s=this.drawTime[1],o=this.scheduler.now()+s;if(this.lastFrame===null){this.lastFrame=o;return}const i=this.scheduler.pattern.queryArc(Math.max(this.lastFrame,o-1/10),o);this.lastFrame=o,this.visibleHaps=(this.visibleHaps||[]).filter(u=>u.whole?.end>=o-r-s).concat(i.filter(u=>u.hasOnset()));const l=o-s;t(this.visibleHaps,l,this)},r=>{console.warn("draw error",r)})}setDrawTime(t){this.drawTime=t}invalidate(t=this.scheduler,n){if(!t)return;n=n??t.now(),this.scheduler=t;let[r,s]=this.drawTime;const[o,i]=[Math.max(n,0),n+s+.1];this.visibleHaps=this.visibleHaps.filter(u=>u.whole.begin<n);const l=t.pattern.queryArc(o,i);this.visibleHaps=this.visibleHaps.concat(l)}start(t){this.scheduler=t,this.invalidate(),this.framer.start()}stop(){this.framer&&this.framer.stop()}}const{createParams:ei}=W;let me="#22222210";p.prototype.animate=function({callback:e,sync:t=!1,smear:n=.5}={}){window.frame&&cancelAnimationFrame(window.frame);const r=Ot(),{clientWidth:s,clientHeight:o}=r.canvas;let i=n===0?"99":Number((1-n)*100).toFixed(0);i=i.length===1?`0${i}`:i,me=`#200010${i}`;const l=u=>{let h;u=Math.round(u),h=this.slow(1e3).queryArc(u,u),r.fillStyle=me,r.fillRect(0,0,s,o),h.forEach(c=>{let{x:a,y,w,h:_,s:b,r:N,angle:g=0,fill:P="darkseagreen"}=c.value;if(w*=s,_*=o,N!==void 0&&g!==void 0){const K=g*2*Math.PI,[et,U]=[(s-w)/2,(o-_)/2];a=et+Math.cos(K)*N*et,y=U+Math.sin(K)*N*U}else a*=s-w,y*=o-_;const F={...c.value,x:a,y,w,h:_};r.fillStyle=P,b==="rect"?r.fillRect(a,y,w,_):b==="ellipse"&&(r.beginPath(),r.ellipse(a+w/2,y+_/2,w/2,_/2,0,0,2*Math.PI),r.fill()),e&&e(r,F,c)}),window.frame=requestAnimationFrame(l)};return window.frame=requestAnimationFrame(l),E};const{x:re,y:ni,w:ri,h:si,angle:oi,r:ii,fill:ci,smear:ai}=ei("x","y","w","h","angle","r","fill","smear"),ui=f("rescale",function(e,t){return t.mul(re(e).w(e).y(e).h(e))}),li=f("moveXY",function(e,t,n){return n.add(re(e).y(t))}),fi=f("zoomIn",function(e,t){const n=Q(1).sub(e).div(2);return t.rescale(e).move(n,n)}),gt=(e,t,n)=>e*(n-t)+t,we=e=>{let{value:t}=e;typeof e.value!="object"&&(t={value:t});let{note:n,n:r,freq:s,s:o}=t;return s?Lt(s):(n=n??r,typeof n=="string"?ft(n):typeof n=="number"?n:o?"_"+o:t)};p.prototype.pianoroll=function(e={}){let{cycles:t=4,playhead:n=.5,overscan:r=1,hideNegative:s=!1}=e,o=-t*n,i=t*(1-n);return this.draw((l,u,h)=>{const c=a=>(!s||a.whole.begin>=0)&&a.whole.begin<=h+i&&a.endClipped>=h+o;globalThis.haps_from_outputs||(globalThis.haps_from_outputs=[]),globalThis.haps_from_outputs.length>0&&(u.push(...globalThis.haps_from_outputs),u=globalThis.haps_from_outputs.filter(c),globalThis.haps_from_outputs=u),Bt({...e,time:h,ctx:l,haps:u.filter(c)})},{from:o-r,to:i+r}),this};function Bt({time:e,haps:t,cycles:n=4,playhead:r=.5,flipTime:s=0,flipValues:o=0,hideNegative:i=!1,inactive:l="#7491D2",active:u="#FFCA28",background:h="transparent",smear:c=0,playheadColor:a="white",minMidi:y=10,maxMidi:w=90,autorange:_=0,timeframe:b,fold:N=0,vertical:g=0,labels:P=!1,fill:F=1,fillActive:K=!1,strokeActive:et=!0,stroke:U,hideInactive:rt=0,colorizeInactive:ht=1,fontFamily:pt,ctx:k}={}){const R=k.canvas.width,q=k.canvas.height;let C=-n*r,Z=n*(1-r);b&&(console.warn("timeframe is deprecated! use from/to instead"),C=0,Z=b);const B=g?q:R,$=g?R:q;let it=g?[B,0]:[0,B];const vt=Z-C,oe=g?[0,$]:[$,0];let _t=w-y+1,ct=$/_t,qt=[];s&&it.reverse(),o&&oe.reverse();const{min:un,max:ln,values:fn}=t.reduce(({min:x,max:L,values:dt},mt)=>{const H=we(mt);return{min:H<x?H:x,max:H>L?H:L,values:dt.includes(H)?dt:[...dt,H]}},{min:1/0,max:-1/0,values:[]});_&&(y=un,w=ln,_t=w-y+1),qt=fn.sort((x,L)=>typeof x=="number"&&typeof L=="number"?x-L:typeof x=="number"?1:String(x).localeCompare(String(L))),ct=N?$/qt.length:$/_t,k.fillStyle=h,k.globalAlpha=1,c||(k.clearRect(0,0,R,q),k.fillRect(0,0,R,q)),t.forEach(x=>{const L=x.whole.begin<=e&&x.endClipped>e;let dt=U??(et&&L),mt=!L&&F||L&&K;if(rt&&!L)return;let H=x.value?.color||x.context?.color;u=H||u,l=ht&&H||l,H=L?u:l,k.fillStyle=mt?H:"transparent",k.strokeStyle=H,k.globalAlpha=x.context.velocity??x.value?.gain??1;const hn=(x.whole.begin-(s?Z:C))/vt,ie=gt(hn,...it);let wt=gt(x.duration/vt,0,B);const ce=we(x),pn=N?qt.indexOf(ce)/qt.length:(Number(ce)-y)/_t,ae=gt(pn,...oe);let ue=0;const le=gt(e/vt,...it);let yt;if(g?yt=[ae+1-(o?ct:0),B-le+ie+ue+1-(s?0:wt),ct-2,wt-2]:yt=[ie-le+ue+1-(s?wt:0),ae+1-(o?0:ct),wt-2,ct-2],dt&&k.strokeRect(...yt),mt&&k.fillRect(...yt),P){const dn=x.value.note??x.value.s+(x.value.n?`:${x.value.n}`:""),{label:fe,activeLabel:mn}=x.value,wn=(L&&mn||fe)??dn;let yn=g?wt:ct*.75;k.font=`${yn}px ${pt||"monospace"}`,k.fillStyle=mt?"black":H,k.textBaseline="top",k.fillText(wn,...yt)}}),k.globalAlpha=1;const At=gt(-C/vt,...it);return k.strokeStyle=a,k.beginPath(),g?(k.moveTo(0,At),k.lineTo($,At)):(k.moveTo(At,0),k.lineTo(At,$)),k.stroke(),this}function se(e,t={}){let[n,r]=e;n=Math.abs(n);const s=r+n,o=n/s;return{fold:1,...t,cycles:s,playhead:o}}const an=(e={})=>(t,n,r,s,o={})=>Bt({ctx:t,time:n,haps:r,...se(s,{...o,...e})});p.prototype.punchcard=function(e){return this.onPaint(an(e))};p.prototype.wordfall=function(e){return this.punchcard({vertical:1,labels:1,stroke:0,fillActive:1,active:"white",...e})};function hi(e){const{drawTime:t,...n}=e;Bt({...se(t),...n})}function pi(e,t,n,r){const s=(e-90)*Math.PI/180;return[n+Math.cos(s)*t,r+Math.sin(s)*t]}const ye=(e,t,n,r,s=0)=>pi((e+s)*360,t*e,n,r);function ge(e){let{ctx:t,from:n=0,to:r=3,margin:s=50,cx:o=100,cy:i=100,rotate:l=0,thickness:u=s/2,color:h="#0000ff30",cap:c="round",stretch:a=1,fromOpacity:y=1,toOpacity:w=1}=e;n*=a,r*=a,l*=a,t.lineWidth=u,t.lineCap=c,t.strokeStyle=h,t.globalAlpha=y,t.beginPath();let[_,b]=ye(n,s,o,i,l);t.moveTo(_,b);const N=1/60;let g=n;for(;g<=r;){const[P,F]=ye(g,s,o,i,l);t.globalAlpha=(g-n)/(r-n)*w,t.lineTo(P,F),g+=N}t.stroke()}p.prototype.spiral=function(e={}){const{stretch:t=1,size:n=80,thickness:r=n/2,cap:s="butt",inset:o=3,playheadColor:i="#ffffff90",playheadLength:l=.02,playheadThickness:u=r,padding:h=0,steady:c=1,inactiveColor:a="#ffffff20",colorizeInactive:y=0,fade:w=!0}=e;function _({ctx:b,time:N,haps:g,drawTime:P}){const[F,K]=[b.canvas.width,b.canvas.height];b.clearRect(0,0,F*2,K*2);const[et,U]=[F/2,K/2],rt={margin:n/t,cx:et,cy:U,stretch:t,cap:s,thickness:r},ht={...rt,thickness:u,from:o-l,to:o,color:i},[pt]=P,k=c*N;g.forEach(R=>{const q=R.whole.begin<=N&&R.endClipped>N,C=R.whole.begin-N+o,Z=R.endClipped-N+o-h,{color:B}=R.context,$=w?1-Math.abs((R.whole.begin-N)/pt):1;ge({ctx:b,...rt,from:C,to:Z,rotate:k,color:y||q?B:a,fromOpacity:$,toOpacity:$})}),ge({ctx:b,...ht,rotate:k})}return this.onPaint((b,N,g,P)=>_({ctx:b,time:N,haps:g,drawTime:P}))};function di(e){window.strudelAnimation&&cancelAnimationFrame(window.strudelAnimation);const t=n=>{e(n,ne()),window.strudelAnimation=requestAnimationFrame(t)};requestAnimationFrame(t)}const mi=function(e,t={}){const n=document.getElementById("code"),r="background-image:url("+e+");background-size:contain;";n.style=r;const{className:s}=n,o=(u,h)=>{({style:()=>n.style=r+";"+h,className:()=>n.className=h+" "+s})[u]()},i=Object.entries(t).filter(([u,h])=>typeof h=="function");Object.entries(t).filter(([u,h])=>typeof h=="string").forEach(([u,h])=>o(u,h)),i.length!==0&&di((u,h)=>i.forEach(([c,a])=>{o(c,a(h))}))},wi=()=>{const e=document.getElementById("code");e&&(e.style="")};I("🌀 @strudel/core loaded 🌀");globalThis._strudelLoaded&&console.warn(`@strudel/core was loaded more than once...
This might happen when you have multiple versions of strudel installed. 
Please check with "npm ls @strudel/core".`);globalThis._strudelLoaded=!0;const bi=Object.freeze(Object.defineProperty({__proto__:null,Cyclist:rn,Drawer:ti,Fraction:v,Framer:cn,Hap:O,Pattern:p,State:st,TimeSpan:T,__chooseWith:ee,_brandBy:te,_irand:Qe,_mod:bt,add:rr,almostAlways:Do,almostNever:Ro,always:Go,and:qr,angle:oi,apply:Yr,arrange:Kn,backgroundImage:mi,band:ur,base64ToUnicode:xe,bjork:Je,blshift:hr,bor:lr,brak:hs,brand:bo,brandBy:go,brshift:pr,bxor:fr,bypass:Es,cat:Gt,ceil:Sr,choose:So,chooseCycles:Xe,chooseInWith:Ze,chooseWith:Tt,chop:Is,chunkBack:Ms,chunkback:Ts,clamp:Ce,cleanupDraw:Yo,cleanupUi:wi,code2hash:Wn,color:$s,colour:Ls,compose:En,compress:Pr,compressSpan:zr,compressspan:jr,constant:Pn,controls:W,cosine:io,cosine2:co,cpm:ts,curry:A,degrade:zo,degradeBy:Po,degradeByWith:Eo,density:Rr,div:ir,drawLine:Te,drawPianoroll:hi,duration:zs,early:es,echo:As,echoWith:bs,echowith:vs,eq:gr,eqt:br,euclid:to,euclidLegato:ro,euclidLegatoRot:so,euclidRot:no,euclidrot:eo,evalScope:en,evaluate:nn,every:Xr,fast:Wr,fastChunk:Bs,fastGap:Fr,fastcat:tt,fastchunk:Os,fastgap:$r,fill:ci,firstOf:Zr,fit:Gs,flatten:nt,floor:Cr,focus:Lr,focusSpan:Hr,focusspan:Jr,fractionalArgs:zn,freqToMidi:Lt,fromBipolar:Mr,func:kr,getDrawContext:Ot,getDrawOptions:se,getFreq:ve,getFrequency:Bn,getPlayableNoteValue:On,getPunchcardPainter:an,getSoundIndex:Tn,getTime:ne,getTrigger:on,gt:mr,gte:yr,h:si,hash2code:Rn,hsl:Fs,hsla:js,hurry:Dr,id:ut,inhabit:ko,inhabitmod:No,inside:Qr,inv:us,invert:as,irand:vo,isNote:Ct,isNoteWithOctave:kn,isPattern:Dt,isaw:Xt,isaw2:We,iter:Ns,iterBack:Cs,iterback:Ss,jux:gs,juxBy:ws,juxby:ys,keep:er,keepif:nr,lastOf:Kr,late:ns,legato:Js,linger:is,listRange:Ht,logKey:$t,logger:I,loopAt:Ds,loopAtCps:Qs,loopat:Vs,loopatcps:Us,lt:dr,lte:wr,mapArgs:It,mask:Zn,midi2note:Mn,midiToFreq:lt,mod:cr,moveXY:li,mul:or,nanFallback:_e,ne:vr,net:_r,never:Vo,noteToMidi:ft,numeralArgs:D,objectMap:Me,off:fs,often:Io,or:Ar,outside:Ur,palindrome:ms,parseFractional:Ne,parseNumeral:Jt,perlin:Bo,perlinWith:tn,pianoroll:Bt,pick:Ue,pickF:qo,pickmod:Ke,pickmodF:Ao,pipe:Ae,ply:Ir,pm:Ee,polymeter:Qt,polymeterSteps:ze,polyrhythm:Oe,pow:ar,pr:Be,press:ds,pressBy:ps,pure:Q,r:ii,rand:V,rand2:yo,randcat:xo,range:Tr,range2:Br,rangex:Or,rarely:Wo,ratio:Er,ref:Ks,register:f,reify:m,removeUndefineds:ke,repl:Xo,rescale:ui,rev:je,ribbon:Ps,rotate:qe,round:Nr,run:wo,saw:xt,saw2:Re,segment:cs,seq:Pe,sequence:G,set:tr,setStringParser:Vn,setTime:sn,signal:ot,silence:E,sine:De,sine2:Yt,slice:$e,slow:Vr,slowcat:Y,slowcatPrime:Vt,smear:ai,sol2note:In,someCycles:Jo,someCyclesBy:Ho,sometimes:Lo,sometimesBy:$o,sparsity:Gr,speak:Uo,splice:Rs,splitAt:Wt,square:Ve,square2:ao,squeeze:Co,stack:j,steady:oo,striate:Ws,struct:Xn,stut:ks,stutWith:_s,stutwith:qs,sub:sr,superimpose:Yn,time:Ge,timeCat:St,toBipolar:xr,tokenizeNote:be,tri:uo,tri2:lo,undegrade:Fo,undegradeBy:jo,unicodeToBase64:Se,valueToMidi:Sn,velocity:Hs,w:ri,wchoose:To,wchooseCycles:Oo,when:ls,x:re,xfade:Le,y:ni,zipWith:Rt,zoom:rs,zoomArc:ss,zoomIn:fi,zoomarc:os},Symbol.toStringTag,{value:"Module"}));let z=[],yi=(e,t)=>{let n=[],r={get(){return r.lc||r.listen(()=>{})(),r.value},l:t||0,lc:0,listen(s,o){return r.lc=n.push(s,o||r.l)/2,()=>{let i=n.indexOf(s);~i&&(n.splice(i,2),--r.lc||r.off())}},notify(s){let o=!z.length;for(let i=0;i<n.length;i+=2)z.push(n[i],n[i+1],r.value,s);if(o){for(let i=0;i<z.length;i+=4){let l;for(let u=i+1;!l&&(u+=4)<z.length;)z[u]<z[i+1]&&(l=z.push(z[i],z[i+1],z[i+2],z[i+3]));l||z[i](z[i+2],z[i+3])}z.length=0}},off(){},set(s){r.value!==s&&(r.value=s,r.notify())},subscribe(s,o){let i=r.listen(s,o);return s(r.value),i},value:e};return r},vi=(e={})=>{let t=yi(e);return t.setKey=function(n,r){typeof r>"u"?n in t.value&&(t.value={...t.value},delete t.value[n],t.notify(n)):t.value[n]!==r&&(t.value={...t.value,[n]:r},t.notify(n))},t};export{Ze as A,V as B,rn as C,ti as D,tt as E,St as F,G,m as H,Vn as I,nt as J,Sn as K,en as L,W as M,Rn as N,p as P,bt as _,f as a,Bn as b,Tn as c,On as d,vi as e,Lt as f,Ot as g,on as h,Dt as i,Ce as j,Ct as k,I as l,Mn as m,ft as n,Q as o,Jt as p,E as q,Ks as r,bi as s,j as t,yi as u,Xo as v,Yo as w,an as x,Wn as y,v as z};
