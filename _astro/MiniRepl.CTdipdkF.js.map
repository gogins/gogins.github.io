{"version":3,"file":"MiniRepl.CTdipdkF.js","sources":["../../src/docs/Icon.jsx","../../src/useClient.mjs","../../src/docs/MiniRepl.jsx"],"sourcesContent":["export function Icon({ type }) {\n  if (type === 'skip') {\n    // !Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.\n    return (\n      <svg\n        fillRule=\"evenodd\"\n        fill=\"currentColor\"\n        xmlns=\"http://www.w3.org/2000/svg\"\n        height=\"16\"\n        width=\"10\"\n        viewBox=\"0 0 320 512\"\n      >\n        <path d=\"M52.5 440.6c-9.5 7.9-22.8 9.7-34.1 4.4S0 428.4 0 416V96C0 83.6 7.2 72.3 18.4 67s24.5-3.6 34.1 4.4l192 160L256 241V96c0-17.7 14.3-32 32-32s32 14.3 32 32V416c0 17.7-14.3 32-32 32s-32-14.3-32-32V271l-11.5 9.6-192 160z\" />\n      </svg>\n    );\n  }\n  return (\n    <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n      {\n        {\n          refresh: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          play: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          pause: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          stop: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M2 10a8 8 0 1116 0 8 8 0 01-16 0zm5-2.25A.75.75 0 017.75 7h4.5a.75.75 0 01.75.75v4.5a.75.75 0 01-.75.75h-4.5a.75.75 0 01-.75-.75v-4.5z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          skip: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M52.5 440.6c-9.5 7.9-22.8 9.7-34.1 4.4S0 428.4 0 416V96C0 83.6 7.2 72.3 18.4 67s24.5-3.6 34.1 4.4l192 160L256 241V96c0-17.7 14.3-32 32-32s32 14.3 32 32V416c0 17.7-14.3 32-32 32s-32-14.3-32-32V271l-11.5 9.6-192 160z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n        }[type]\n      }\n    </svg>\n  );\n}\n","import { useEffect, useState } from 'react';\n\nexport default function useClient() {\n  const [client, setClient] = useState(false);\n  useEffect(() => {\n    setClient(true);\n  }, []);\n  return client;\n}\n","import { useState, useRef, useCallback, useMemo, useEffect } from 'react';\nimport { Icon } from './Icon';\nimport { silence, noteToMidi, _mod } from '@strudel/core';\nimport { getDrawContext, getPunchcardPainter } from '@strudel/draw';\nimport { transpiler } from '@strudel/transpiler';\nimport { getAudioContext, webaudioOutput, initAudioOnFirstClick } from '@strudel/webaudio';\nimport { StrudelMirror } from '@strudel/codemirror';\nimport { prebake } from '../repl/prebake.mjs';\nimport { loadModules, setVersionDefaultsFrom } from '../repl/util.mjs';\nimport Claviature from '@components/Claviature';\nimport useClient from '@src/useClient.mjs';\n\nlet prebaked, modulesLoading, audioReady;\nif (typeof window !== 'undefined') {\n  prebaked = prebake();\n  modulesLoading = loadModules();\n  audioReady = initAudioOnFirstClick();\n}\n\nexport function MiniRepl({\n  tune,\n  tunes,\n  hideHeader = false,\n  canvasHeight = 100,\n  onTrigger,\n  punchcard,\n  punchcardLabels = true,\n  claviature,\n  claviatureLabels,\n  maxHeight,\n  autodraw,\n  drawTime,\n}) {\n  const code = tunes ? tunes[0] : tune;\n  const id = useMemo(() => s4(), []);\n  const shouldShowCanvas = !!punchcard;\n  const canvasId = shouldShowCanvas ? useMemo(() => `canvas-${id}`, [id]) : null;\n  autodraw = !!punchcard || !!claviature || !!autodraw;\n  drawTime = (drawTime ?? punchcard) ? [0, 4] : [-2, 2];\n  if (claviature) {\n    drawTime = [0, 0];\n  }\n  const [activeNotes, setActiveNotes] = useState([]);\n\n  const init = useCallback(({ code, autodraw }) => {\n    const drawContext = canvasId ? document.querySelector('#' + canvasId)?.getContext('2d') : getDrawContext();\n\n    const editor = new StrudelMirror({\n      id,\n      defaultOutput: webaudioOutput,\n      getTime: () => getAudioContext().currentTime,\n      transpiler,\n      autodraw,\n      root: containerRef.current,\n      initialCode: '// LOADING',\n      pattern: silence,\n      drawTime,\n      drawContext,\n      editPattern: (pat, id) => {\n        if (onTrigger) {\n          pat = pat.onTrigger(onTrigger, false);\n        }\n        if (claviature) {\n          pat = pat.onPaint((ctx, time, haps, drawTime) => {\n            const active = haps\n              .map((hap) => hap.value.note)\n              .filter(Boolean)\n              .map((n) => (typeof n === 'string' ? noteToMidi(n) : n));\n            setActiveNotes(active);\n          });\n        }\n        if (punchcard) {\n          pat = pat.punchcard({ labels: !!punchcardLabels });\n        }\n        return pat;\n      },\n      prebake: async () => Promise.all([modulesLoading, prebaked]),\n      onUpdateState: (state) => {\n        setReplState({ ...state });\n      },\n      onToggle: (playing) => {\n        if (!playing) {\n          // clearHydra(); // TBD: doesn't work with multiple MiniRepl's on a page\n        }\n      },\n      beforeStart: () => audioReady,\n      afterEval: ({ code }) => setVersionDefaultsFrom(code),\n    });\n    // init settings\n    editor.setCode(code);\n    editorRef.current = editor;\n  }, []);\n\n  const [replState, setReplState] = useState({});\n  const { started, isDirty, error } = replState;\n  const editorRef = useRef();\n  const containerRef = useRef();\n  const client = useClient();\n\n  const [tuneIndex, setTuneIndex] = useState(0);\n  const changeTune = (index) => {\n    index = _mod(index, tunes.length);\n    setTuneIndex(index);\n    editorRef.current?.setCode(tunes[index]);\n    editorRef.current?.evaluate();\n  };\n\n  if (!client) {\n    return <pre>{code}</pre>;\n  }\n\n  return (\n    <div className=\"overflow-hidden rounded-t-md bg-background border border-lineHighlight\">\n      {!hideHeader && (\n        <div className=\"flex justify-between bg-lineHighlight\">\n          <div className=\"flex\">\n            <button\n              className={cx(\n                'cursor-pointer w-16 flex items-center justify-center p-1 border-r border-lineHighlight text-foreground bg-lineHighlight hover:bg-background',\n                started ? 'animate-pulse' : '',\n              )}\n              aria-label={started ? 'stop' : 'play'}\n              onClick={() => editorRef.current?.toggle()}\n            >\n              <Icon type={started ? 'stop' : 'play'} />\n            </button>\n            <button\n              className={cx(\n                'w-16 flex items-center justify-center p-1 text-foreground border-lineHighlight bg-lineHighlight',\n                isDirty ? 'text-foreground hover:bg-background cursor-pointer' : 'opacity-50 cursor-not-allowed',\n              )}\n              aria-label=\"update\"\n              onClick={() => editorRef.current?.evaluate()}\n            >\n              <Icon type=\"refresh\" />\n            </button>\n          </div>\n          {tunes && (\n            <div className=\"flex\">\n              <button\n                className={\n                  'cursor-pointer w-16 flex items-center justify-center p-1 border-r border-lineHighlight text-foreground bg-lineHighlight hover:bg-background'\n                }\n                aria-label=\"previous example\"\n                onClick={() => changeTune(tuneIndex - 1)}\n              >\n                <div className=\"rotate-180\">\n                  <Icon type=\"skip\" />\n                </div>\n              </button>\n              <button\n                className={\n                  'cursor-pointer w-16 flex items-center justify-center p-1 border-r border-lineHighlight text-foreground bg-lineHighlight hover:bg-background'\n                }\n                aria-label=\"next example\"\n                onClick={() => changeTune(tuneIndex + 1)}\n              >\n                <Icon type=\"skip\" />\n              </button>\n            </div>\n          )}\n        </div>\n      )}\n      <div className=\"overflow-auto relative p-1\" style={maxHeight ? { maxHeight: `${maxHeight}px` } : {}}>\n        <div\n          ref={(el) => {\n            if (!editorRef.current) {\n              containerRef.current = el;\n              init({ code, autodraw });\n            }\n          }}\n        ></div>\n        {error && <div className=\"text-right p-1 text-md text-red-200\">{error.message}</div>}\n      </div>\n      {shouldShowCanvas && (\n        <canvas\n          id={canvasId}\n          className=\"w-full pointer-events-none border-t border-lineHighlight\"\n          height={canvasHeight}\n          ref={(el) => {\n            if (el && el.width !== el.clientWidth) {\n              el.width = el.clientWidth;\n            }\n          }}\n        ></canvas>\n      )}\n      {/* !!log.length && (\n      <div className=\"bg-gray-800 rounded-md p-2\">\n        {log.map(({ message }, i) => (\n          <div key={i}>{message}</div>\n        ))}\n      </div>\n    ) */}\n      {claviature && (\n        <Claviature\n          options={{\n            range: ['C2', 'C6'],\n            scaleY: 0.75,\n            colorize: [{ keys: activeNotes, color: 'steelblue' }],\n            labels: claviatureLabels || {},\n          }}\n        />\n      )}\n    </div>\n  );\n}\n\nfunction cx(...classes) {\n  // : Array<string | undefined>\n  return classes.filter(Boolean).join(' ');\n}\n\nfunction s4() {\n  return Math.floor((1 + Math.random()) * 0x10000)\n    .toString(16)\n    .substring(1);\n}\n"],"names":["Icon","type","jsx","useClient","client","setClient","useState","useEffect","prebaked","modulesLoading","audioReady","prebake","loadModules","initAudioOnFirstClick","MiniRepl","tune","tunes","hideHeader","canvasHeight","onTrigger","punchcard","punchcardLabels","claviature","claviatureLabels","maxHeight","autodraw","drawTime","code","id","useMemo","s4","shouldShowCanvas","canvasId","activeNotes","setActiveNotes","init","useCallback","drawContext","getDrawContext","editor","StrudelMirror","webaudioOutput","getAudioContext","transpiler","containerRef","silence","pat","ctx","time","haps","active","hap","n","noteToMidi","state","setReplState","playing","setVersionDefaultsFrom","editorRef","replState","started","isDirty","error","useRef","tuneIndex","setTuneIndex","changeTune","index","_mod","jsxs","cx","el","Claviature","classes"],"mappings":"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"}