{"version":3,"file":"PitchSlider.616431e3.js","sources":["../../src/components/PitchSlider.jsx"],"sourcesContent":["import useEvent from '@strudel.cycles/react/src/hooks/useEvent.mjs';\nimport useFrame from '@strudel.cycles/react/src/hooks/useFrame.mjs';\nimport { getAudioContext } from '@strudel.cycles/webaudio';\nimport { midi2note } from '@strudel.cycles/core';\nimport { useState, useRef, useEffect } from 'react';\nimport Claviature from '@components/Claviature';\n\nlet Button = (props) => <button {...props} className=\"bg-lineHighlight p-2 rounded-md color-foreground\" />;\n\nfunction plotValues(ctx, values, min, max, color) {\n  let { width, height } = ctx.canvas;\n  ctx.strokeStyle = color;\n  const thickness = 8;\n  ctx.lineWidth = thickness;\n  ctx.beginPath();\n\n  let x = (f) => ((f - min) / (max - min)) * width;\n  let y = (i) => (1 - i / values.length) * height;\n  values.forEach((f, i, a) => {\n    ctx.lineTo(x(f), y(i));\n  });\n  ctx.stroke();\n}\n\nfunction getColor(cssVariable) {\n  if (typeof document === 'undefined') {\n    return 'white';\n  }\n  const dummyElement = document.createElement('div');\n  dummyElement.style.color = cssVariable;\n  // Append the dummy element to the document body\n  document.body.appendChild(dummyElement);\n  // Get the computed style of the dummy element\n  const styles = getComputedStyle(dummyElement);\n  // Get the value of the CSS variable\n  const color = styles.getPropertyValue(cssVariable);\n  document.body.removeChild(dummyElement);\n  return color;\n}\n\nlet pitchColor = '#eab308';\nlet frequencyColor = '#3b82f6';\n\nexport function PitchSlider({\n  buttons = [],\n  animatable = false,\n  plot = false,\n  showPitchSlider = false,\n  showFrequencySlider = false,\n  pitchStep = '0.001',\n  min = 55,\n  max = 7040,\n  initial = 220,\n  baseFrequency = min,\n  zeroOffset = 0,\n  claviature,\n}) {\n  const oscRef = useRef();\n  const activeRef = useRef();\n  const freqRef = useRef(initial);\n  const historyRef = useRef([freqRef.current]);\n  const frameRef = useRef();\n  const canvasRef = useRef();\n  const [hz, setHz] = useState(freqRef.current);\n\n  useEffect(() => {\n    freqRef.current = hz;\n  }, [hz]);\n\n  useEvent('mouseup', () => {\n    oscRef.current?.stop();\n    activeRef.current = false;\n  });\n\n  let freqSlider2freq = (progress) => min + progress * (max - min);\n  let pitchSlider2freq = (progress) => min * 2 ** (progress * Math.log2(max / min));\n  let freq2freqSlider = (freq) => (freq - min) / (max - min);\n  let freq2pitchSlider = (freq) => {\n    const [minOct, maxOct] = [Math.log2(min), Math.log2(max)];\n    return (Math.log2(freq) - minOct) / (maxOct - minOct);\n  };\n\n  const freqSlider = freq2freqSlider(hz);\n  const pitchSlider = freq2pitchSlider(hz);\n\n  let startOsc = (hz) => {\n    if (oscRef.current) {\n      oscRef.current.stop();\n    }\n    oscRef.current = getAudioContext().createOscillator();\n    oscRef.current.frequency.value = hz;\n    oscRef.current.connect(getAudioContext().destination);\n    oscRef.current.start();\n    activeRef.current = true;\n    setHz(hz);\n  };\n\n  let startSweep = (exp = false) => {\n    let f = min;\n    startOsc(f);\n    const frame = () => {\n      if (f < max) {\n        if (!exp) {\n          f += 10;\n        } else {\n          f *= 1.01;\n        }\n        oscRef.current.frequency.value = f;\n        frameRef.current = requestAnimationFrame(frame);\n      } else {\n        oscRef.current.stop();\n        cancelAnimationFrame(frameRef.current);\n      }\n      setHz(f);\n    };\n    requestAnimationFrame(frame);\n  };\n\n  useFrame(() => {\n    historyRef.current.push(freqRef.current);\n    historyRef.current = historyRef.current.slice(-1000);\n    if (canvasRef.current) {\n      let ctx = canvasRef.current.getContext('2d');\n      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);\n      if (showFrequencySlider) {\n        plotValues(ctx, historyRef.current, min, max, frequencyColor);\n      }\n      if (showPitchSlider) {\n        const [minOct, maxOct] = [Math.log2(min), Math.log2(max)];\n        let perceptual = historyRef.current.map((v) => Math.log2(v));\n        plotValues(ctx, perceptual, minOct, maxOct, pitchColor);\n      }\n    }\n  }, plot);\n\n  let handleChangeFrequency = (f) => {\n    setHz(f);\n    if (oscRef.current) {\n      oscRef.current.frequency.value = f;\n    }\n  };\n  let handleMouseDown = () => {\n    cancelAnimationFrame(frameRef.current);\n    startOsc(hz);\n  };\n\n  let exponent, activeNote, activeNoteLabel;\n  if (showPitchSlider) {\n    const expOffset = baseFrequency ? Math.log2(baseFrequency / min) : 0;\n    exponent = freq2pitchSlider(hz) * Math.log2(max / min) - expOffset;\n    let semitones = parseFloat((exponent * 12).toFixed(2));\n    if (zeroOffset) {\n      semitones = semitones + zeroOffset;\n      const isWhole = Math.round(semitones) === semitones;\n      activeNote = midi2note(Math.round(semitones));\n      activeNoteLabel = (!isWhole ? '~' : '') + activeNote;\n      semitones = !isWhole ? semitones.toFixed(2) : semitones;\n      exponent = (\n        <>\n          (<span className=\"text-yellow-500\">{semitones}</span> - {zeroOffset})/12\n        </>\n      );\n    } else if (semitones % 12 === 0) {\n      exponent = <span className=\"text-yellow-500\">{semitones / 12}</span>;\n    } else if (semitones % 1 === 0) {\n      exponent = (\n        <>\n          <span className=\"text-yellow-500\">{semitones}</span>/12\n        </>\n      );\n    } else {\n      exponent = <span className=\"text-yellow-500\">{exponent.toFixed(2)}</span>;\n    }\n  }\n  return (\n    <>\n      <span className=\"font-mono\">\n        {showFrequencySlider && <span className=\"text-blue-500\">{hz.toFixed(0)}Hz</span>}\n        {showFrequencySlider && showPitchSlider && <> = </>}\n        {showPitchSlider && (\n          <>\n            {baseFrequency || min}Hz * 2<sup>{exponent}</sup>\n          </>\n        )}\n      </span>\n      {claviature && (\n        <>\n          {' '}\n          = <span className=\"text-yellow-500\">{activeNoteLabel}</span>\n        </>\n      )}\n      <div>\n        {showFrequencySlider && (\n          <div className=\"flex space-x-1 items-center\">\n            <input\n              type=\"range\"\n              value={freqSlider}\n              min={0}\n              max={1}\n              step={0.001}\n              onMouseDown={handleMouseDown}\n              className={`block w-full max-w-[600px] accent-blue-500 `}\n              onChange={(e) => {\n                const f = freqSlider2freq(parseFloat(e.target.value));\n                handleChangeFrequency(f);\n              }}\n            />\n          </div>\n        )}\n        {showPitchSlider && (\n          <div>\n            <input\n              type=\"range\"\n              value={pitchSlider}\n              min={0}\n              max={1}\n              //step=\".001\"\n              step={pitchStep}\n              onMouseDown={handleMouseDown}\n              className={`block w-full max-w-[600px] accent-yellow-500`}\n              onChange={(e) => {\n                const f = pitchSlider2freq(parseFloat(e.target.value));\n                handleChangeFrequency(f);\n              }}\n            />\n          </div>\n        )}\n      </div>\n      <div className=\"px-2\">\n        {plot && <canvas ref={canvasRef} className=\"w-full max-w-[584px] h-[300px]\" height=\"600\" width={800} />}\n      </div>\n      <div className=\"space-x-2\">\n        {animatable && (\n          <Button onClick={() => startSweep()}>\n            <span style={{ color: '#3b82f6' }}>Frequency Sweep</span>\n          </Button>\n        )}\n        {animatable && (\n          <Button onClick={() => startSweep(true)}>\n            <span style={{ color: '#eab308' }}>Pitch Sweep</span>\n          </Button>\n        )}\n        {buttons.map((f, i) => (\n          <Button key={(f, i)} onMouseDown={() => startOsc(f)}>\n            {f}Hz\n          </Button>\n        ))}\n      </div>\n      {claviature && (\n        <Claviature\n          onMouseDown={(note) => {\n            const f = 440 * 2 ** ((note - 69) / 12);\n            handleChangeFrequency(f);\n            cancelAnimationFrame(frameRef.current);\n            startOsc(f);\n          }}\n          options={{\n            range: ['A1', 'A5'],\n            scaleY: 0.75,\n            scaleX: 0.86,\n            colorize: activeNote ? [{ keys: [activeNote], color: '#eab308' }] : [],\n            labels: activeNote ? { [activeNote]: activeNote } : {},\n          }}\n        />\n      )}\n    </>\n  );\n}\n"],"names":["Button","props","_jsx","plotValues","ctx","values","min","max","color","width","height","canvas","strokeStyle","thickness","lineWidth","beginPath","x","f","y","i","length","forEach","a","lineTo","stroke","pitchColor","frequencyColor","PitchSlider","buttons","animatable","plot","showPitchSlider","showFrequencySlider","pitchStep","initial","baseFrequency","zeroOffset","claviature","oscRef","useRef","activeRef","freqRef","historyRef","current","frameRef","canvasRef","hz","setHz","useState","useEffect","useEvent","stop","freqSlider2freq","progress","pitchSlider2freq","Math","log2","freq2freqSlider","freq","freq2pitchSlider","minOct","maxOct","freqSlider","pitchSlider","startOsc","hz2","getAudioContext","createOscillator","frequency","value","connect","destination","start","startSweep","exp","frame","requestAnimationFrame","cancelAnimationFrame","useFrame","push","slice","getContext","clearRect","perceptual","map","v","handleChangeFrequency","handleMouseDown","exponent","activeNote","activeNoteLabel","expOffset","semitones","parseFloat","toFixed","isWhole","round","midi2note","_Fragment","_jsxs","e","target","Claviature","note","range","scaleY","scaleX","colorize","keys","labels"],"mappings":"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"}