{"version":3,"file":"midibridge.MGISQ0vS.js","sources":["../../../packages/desktopbridge/midibridge.mjs"],"sourcesContent":["import { Invoke } from './utils.mjs';\nimport { Pattern, getEventOffsetMs, noteToMidi } from '@strudel/core';\n\nconst ON_MESSAGE = 0x90;\nconst OFF_MESSAGE = 0x80;\nconst CC_MESSAGE = 0xb0;\n\nPattern.prototype.midi = function (output) {\n  return this.onTrigger((time_deprecate, hap, currentTime, cps, targetTime) => {\n    let { note, nrpnn, nrpv, ccn, ccv, velocity = 0.9, gain = 1 } = hap.value;\n    //magic number to get audio engine to line up, can probably be calculated somehow\n    const latencyMs = 34;\n    const offset = getEventOffsetMs(targetTime, currentTime) + latencyMs;\n    velocity = Math.floor(gain * velocity * 100);\n    const duration = Math.floor((hap.duration.valueOf() / cps) * 1000 - 10);\n    const roundedOffset = Math.round(offset);\n    const midichan = (hap.value.midichan ?? 1) - 1;\n    const requestedport = output ?? 'IAC';\n    const messagesfromjs = [];\n    if (note != null) {\n      const midiNumber = typeof note === 'number' ? note : noteToMidi(note);\n      messagesfromjs.push({\n        requestedport,\n        message: [ON_MESSAGE + midichan, midiNumber, velocity],\n        offset: roundedOffset,\n      });\n      messagesfromjs.push({\n        requestedport,\n        message: [OFF_MESSAGE + midichan, midiNumber, velocity],\n        offset: roundedOffset + duration,\n      });\n    }\n    if (ccv && ccn) {\n      if (typeof ccv !== 'number' || ccv < 0 || ccv > 1) {\n        throw new Error('expected ccv to be a number between 0 and 1');\n      }\n      if (!['string', 'number'].includes(typeof ccn)) {\n        throw new Error('expected ccn to be a number or a string');\n      }\n      const scaled = Math.round(ccv * 127);\n      messagesfromjs.push({\n        requestedport,\n        message: [CC_MESSAGE + midichan, ccn, scaled],\n        offset: roundedOffset,\n      });\n    }\n    // invoke is temporarily blocking, run in an async process\n    if (messagesfromjs.length) {\n      setTimeout(() => {\n        Invoke('sendmidi', { messagesfromjs });\n      });\n    }\n  });\n};\n"],"names":["ON_MESSAGE","OFF_MESSAGE","CC_MESSAGE","Pattern","output","time_deprecate","hap","currentTime","cps","targetTime","note","nrpnn","nrpv","ccn","ccv","velocity","gain","offset","getEventOffsetMs","duration","roundedOffset","midichan","requestedport","messagesfromjs","midiNumber","noteToMidi","scaled","Invoke"],"mappings":"sSAGA,MAAMA,EAAa,IACbC,EAAc,IACdC,EAAa,IAEnBC,EAAQ,UAAU,KAAO,SAAUC,EAAQ,CACzC,OAAO,KAAK,UAAU,CAACC,EAAgBC,EAAKC,EAAaC,EAAKC,IAAe,CAC3E,GAAI,CAAE,KAAAC,EAAM,MAAAC,EAAO,KAAAC,EAAM,IAAAC,EAAK,IAAAC,EAAK,SAAAC,EAAW,GAAK,KAAAC,EAAO,GAAMV,EAAI,MAGpE,MAAMW,EAASC,EAAiBT,EAAYF,CAAW,EADrC,GAElBQ,EAAW,KAAK,MAAMC,EAAOD,EAAW,GAAG,EAC3C,MAAMI,EAAW,KAAK,MAAOb,EAAI,SAAS,UAAYE,EAAO,IAAO,EAAE,EAChEY,EAAgB,KAAK,MAAMH,CAAM,EACjCI,GAAYf,EAAI,MAAM,UAAY,GAAK,EACvCgB,EAAgBlB,GAAU,MAC1BmB,EAAiB,CAAA,EACvB,GAAIb,GAAQ,KAAM,CAChB,MAAMc,EAAa,OAAOd,GAAS,SAAWA,EAAOe,EAAWf,CAAI,EACpEa,EAAe,KAAK,CAClB,cAAAD,EACA,QAAS,CAACtB,EAAaqB,EAAUG,EAAYT,CAAQ,EACrD,OAAQK,CAChB,CAAO,EACDG,EAAe,KAAK,CAClB,cAAAD,EACA,QAAS,CAACrB,EAAcoB,EAAUG,EAAYT,CAAQ,EACtD,OAAQK,EAAgBD,CAChC,CAAO,CACF,CACD,GAAIL,GAAOD,EAAK,CACd,GAAI,OAAOC,GAAQ,UAAYA,EAAM,GAAKA,EAAM,EAC9C,MAAM,IAAI,MAAM,6CAA6C,EAE/D,GAAI,CAAC,CAAC,SAAU,QAAQ,EAAE,SAAS,OAAOD,CAAG,EAC3C,MAAM,IAAI,MAAM,yCAAyC,EAE3D,MAAMa,EAAS,KAAK,MAAMZ,EAAM,GAAG,EACnCS,EAAe,KAAK,CAClB,cAAAD,EACA,QAAS,CAACpB,EAAamB,EAAUR,EAAKa,CAAM,EAC5C,OAAQN,CAChB,CAAO,CACF,CAEGG,EAAe,QACjB,WAAW,IAAM,CACfI,EAAO,WAAY,CAAE,eAAAJ,CAAc,CAAE,CAC7C,CAAO,CAEP,CAAG,CACH"}