import{g as getDefaultExportFromCjs}from"./index.3d4af9ee.js";var fraction$1={exports:{}};/**
 * @license Fraction.js v4.2.0 05/03/2022
 * https://www.xarg.org/2014/03/rational-numbers-in-javascript/
 *
 * Copyright (c) 2021, Robert Eisele (robert@xarg.org)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 **/(function(t,e){(function(n){var s=2e3,o={s:1,n:0,d:1};function i(c,u){if(isNaN(c=parseInt(c,10)))throw b.InvalidParameter;return c*u}function a(c,u){if(u===0)throw b.DivisionByZero;var f=Object.create(b.prototype);f.s=c<0?-1:1,c=c<0?-c:c;var d=A(c,u);return f.n=c/d,f.d=u/d,f}function l(c){for(var u={},f=c,d=2,q=4;q<=f;){for(;f%d===0;)f/=d,u[d]=(u[d]||0)+1;q+=1+2*d++}return f!==c?f>1&&(u[f]=(u[f]||0)+1):u[c]=(u[c]||0)+1,u}var p=function(c,u){var f=0,d=1,q=1,S=0,_=0,M=0,C=1,O=1,P=0,k=1,T=1,N=1,E=1e7,H;if(c!=null)if(u!==void 0){if(f=c,d=u,q=f*d,f%1!==0||d%1!==0)throw b.NonIntegerParameter}else switch(typeof c){case"object":{if("d"in c&&"n"in c)f=c.n,d=c.d,"s"in c&&(f*=c.s);else if(0 in c)f=c[0],1 in c&&(d=c[1]);else throw b.InvalidParameter;q=f*d;break}case"number":{if(c<0&&(q=c,c=-c),c%1===0)f=c;else if(c>0){for(c>=1&&(O=Math.pow(10,Math.floor(1+Math.log(c)/Math.LN10)),c/=O);k<=E&&N<=E;)if(H=(P+T)/(k+N),c===H){k+N<=E?(f=P+T,d=k+N):N>k?(f=T,d=N):(f=P,d=k);break}else c>H?(P+=T,k+=N):(T+=P,N+=k),k>E?(f=T,d=N):(f=P,d=k);f*=O}else(isNaN(c)||isNaN(u))&&(d=f=NaN);break}case"string":{if(k=c.match(/\d+|./g),k===null)throw b.InvalidParameter;if(k[P]==="-"?(q=-1,P++):k[P]==="+"&&P++,k.length===P+1?_=i(k[P++],q):k[P+1]==="."||k[P]==="."?(k[P]!=="."&&(S=i(k[P++],q)),P++,(P+1===k.length||k[P+1]==="("&&k[P+3]===")"||k[P+1]==="'"&&k[P+3]==="'")&&(_=i(k[P],q),C=Math.pow(10,k[P].length),P++),(k[P]==="("&&k[P+2]===")"||k[P]==="'"&&k[P+2]==="'")&&(M=i(k[P+1],q),O=Math.pow(10,k[P+1].length)-1,P+=3)):k[P+1]==="/"||k[P+1]===":"?(_=i(k[P],q),C=i(k[P+2],1),P+=3):k[P+3]==="/"&&k[P+1]===" "&&(S=i(k[P],q),_=i(k[P+2],q),C=i(k[P+4],1),P+=5),k.length<=P){d=C*O,q=f=M+d*S+O*_;break}}default:throw b.InvalidParameter}if(d===0)throw b.DivisionByZero;o.s=q<0?-1:1,o.n=Math.abs(f),o.d=Math.abs(d)};function m(c,u,f){for(var d=1;u>0;c=c*c%f,u>>=1)u&1&&(d=d*c%f);return d}function g(c,u){for(;u%2===0;u/=2);for(;u%5===0;u/=5);if(u===1)return 0;for(var f=10%u,d=1;f!==1;d++)if(f=f*10%u,d>s)return 0;return d}function v(c,u,f){for(var d=1,q=m(10,f,u),S=0;S<300;S++){if(d===q)return S;d=d*10%u,q=q*10%u}return 0}function A(c,u){if(!c)return u;if(!u)return c;for(;;){if(c%=u,!c)return u;if(u%=c,!u)return c}}function b(c,u){if(p(c,u),this instanceof b)c=A(o.d,o.n),this.s=o.s,this.n=o.n/c,this.d=o.d/c;else return a(o.s*o.n,o.d)}b.DivisionByZero=new Error("Division by Zero"),b.InvalidParameter=new Error("Invalid argument"),b.NonIntegerParameter=new Error("Parameters must be integer"),b.prototype={s:1,n:0,d:1,abs:function(){return a(this.n,this.d)},neg:function(){return a(-this.s*this.n,this.d)},add:function(c,u){return p(c,u),a(this.s*this.n*o.d+o.s*this.d*o.n,this.d*o.d)},sub:function(c,u){return p(c,u),a(this.s*this.n*o.d-o.s*this.d*o.n,this.d*o.d)},mul:function(c,u){return p(c,u),a(this.s*o.s*this.n*o.n,this.d*o.d)},div:function(c,u){return p(c,u),a(this.s*o.s*this.n*o.d,this.d*o.n)},clone:function(){return a(this.s*this.n,this.d)},mod:function(c,u){if(isNaN(this.n)||isNaN(this.d))return new b(NaN);if(c===void 0)return a(this.s*this.n%this.d,1);if(p(c,u),o.n===0&&this.d===0)throw b.DivisionByZero;return a(this.s*(o.d*this.n)%(o.n*this.d),o.d*this.d)},gcd:function(c,u){return p(c,u),a(A(o.n,this.n)*A(o.d,this.d),o.d*this.d)},lcm:function(c,u){return p(c,u),o.n===0&&this.n===0?a(0,1):a(o.n*this.n,A(o.n,this.n)*A(o.d,this.d))},ceil:function(c){return c=Math.pow(10,c||0),isNaN(this.n)||isNaN(this.d)?new b(NaN):a(Math.ceil(c*this.s*this.n/this.d),c)},floor:function(c){return c=Math.pow(10,c||0),isNaN(this.n)||isNaN(this.d)?new b(NaN):a(Math.floor(c*this.s*this.n/this.d),c)},round:function(c){return c=Math.pow(10,c||0),isNaN(this.n)||isNaN(this.d)?new b(NaN):a(Math.round(c*this.s*this.n/this.d),c)},inverse:function(){return a(this.s*this.d,this.n)},pow:function(c,u){if(p(c,u),o.d===1)return o.s<0?a(Math.pow(this.s*this.d,o.n),Math.pow(this.n,o.n)):a(Math.pow(this.s*this.n,o.n),Math.pow(this.d,o.n));if(this.s<0)return null;var f=l(this.n),d=l(this.d),q=1,S=1;for(var _ in f)if(_!=="1"){if(_==="0"){q=0;break}if(f[_]*=o.n,f[_]%o.d===0)f[_]/=o.d;else return null;q*=Math.pow(_,f[_])}for(var _ in d)if(_!=="1"){if(d[_]*=o.n,d[_]%o.d===0)d[_]/=o.d;else return null;S*=Math.pow(_,d[_])}return o.s<0?a(S,q):a(q,S)},equals:function(c,u){return p(c,u),this.s*this.n*o.d===o.s*o.n*this.d},compare:function(c,u){p(c,u);var f=this.s*this.n*o.d-o.s*o.n*this.d;return(0<f)-(f<0)},simplify:function(c){if(isNaN(this.n)||isNaN(this.d))return this;c=c||.001;for(var u=this.abs(),f=u.toContinued(),d=1;d<f.length;d++){for(var q=a(f[d-1],1),S=d-2;S>=0;S--)q=q.inverse().add(f[S]);if(q.sub(u).abs().valueOf()<c)return q.mul(this.s)}return this},divisible:function(c,u){return p(c,u),!(!(o.n*this.d)||this.n*o.d%(o.n*this.d))},valueOf:function(){return this.s*this.n/this.d},toFraction:function(c){var u,f="",d=this.n,q=this.d;return this.s<0&&(f+="-"),q===1?f+=d:(c&&(u=Math.floor(d/q))>0&&(f+=u,f+=" ",d%=q),f+=d,f+="/",f+=q),f},toLatex:function(c){var u,f="",d=this.n,q=this.d;return this.s<0&&(f+="-"),q===1?f+=d:(c&&(u=Math.floor(d/q))>0&&(f+=u,d%=q),f+="\\frac{",f+=d,f+="}{",f+=q,f+="}"),f},toContinued:function(){var c,u=this.n,f=this.d,d=[];if(isNaN(u)||isNaN(f))return d;do d.push(Math.floor(u/f)),c=u%f,u=f,f=c;while(u!==1);return d},toString:function(c){var u=this.n,f=this.d;if(isNaN(u)||isNaN(f))return"NaN";c=c||15;var d=g(u,f),q=v(u,f,d),S=this.s<0?"-":"";if(S+=u/f|0,u%=f,u*=10,u&&(S+="."),d){for(var _=q;_--;)S+=u/f|0,u%=f,u*=10;S+="(";for(var _=d;_--;)S+=u/f|0,u%=f,u*=10;S+=")"}else for(var _=c;u&&_--;)S+=u/f|0,u%=f,u*=10;return S}},Object.defineProperty(b,"__esModule",{value:!0}),b.default=b,b.Fraction=b,t.exports=b})()})(fraction$1);var fractionExports=fraction$1.exports;const Fraction=getDefaultExportFromCjs(fractionExports);Fraction.prototype.sam=function(){return this.floor()};Fraction.prototype.nextSam=function(){return this.sam().add(1)};Fraction.prototype.wholeCycle=function(){return new TimeSpan(this.sam(),this.nextSam())};Fraction.prototype.cyclePos=function(){return this.sub(this.sam())};Fraction.prototype.lt=function(t){return this.compare(t)<0};Fraction.prototype.gt=function(t){return this.compare(t)>0};Fraction.prototype.lte=function(t){return this.compare(t)<=0};Fraction.prototype.gte=function(t){return this.compare(t)>=0};Fraction.prototype.eq=function(t){return this.compare(t)==0};Fraction.prototype.max=function(t){return this.gt(t)?this:t};Fraction.prototype.min=function(t){return this.lt(t)?this:t};Fraction.prototype.show=function(){return this.s*this.n+"/"+this.d};Fraction.prototype.or=function(t){return this.eq(0)?t:this};const fraction=t=>Fraction(t),gcd=(...t)=>t.reduce((e,n)=>e.gcd(n),fraction(1));fraction._original=Fraction;class TimeSpan{constructor(e,n){this.begin=fraction(e),this.end=fraction(n)}get spanCycles(){const e=[];var n=this.begin;const s=this.end,o=s.sam();if(n.equals(s))return[new TimeSpan(n,s)];for(;s.gt(n);){if(n.sam().equals(o)){e.push(new TimeSpan(n,this.end));break}const i=n.nextSam();e.push(new TimeSpan(n,i)),n=i}return e}get duration(){return this.end.sub(this.begin)}cycleArc(){const e=this.begin.cyclePos(),n=e.add(this.duration);return new TimeSpan(e,n)}withTime(e){return new TimeSpan(e(this.begin),e(this.end))}withEnd(e){return new TimeSpan(this.begin,e(this.end))}withCycle(e){const n=this.begin.sam(),s=n.add(e(this.begin.sub(n))),o=n.add(e(this.end.sub(n)));return new TimeSpan(s,o)}intersection(e){const n=this.begin.max(e.begin),s=this.end.min(e.end);if(!n.gt(s)&&!(n.equals(s)&&(n.equals(this.end)&&this.begin.lt(this.end)||n.equals(e.end)&&e.begin.lt(e.end))))return new TimeSpan(n,s)}intersection_e(e){const n=this.intersection(e);if(n==null)throw"TimeSpans do not intersect";return n}midpoint(){return this.begin.add(this.duration.div(fraction(2)))}equals(e){return this.begin.equals(e.begin)&&this.end.equals(e.end)}show(){return this.begin.show()+" → "+this.end.show()}}class Hap{constructor(e,n,s,o={},i=!1){this.whole=e,this.part=n,this.value=s,this.context=o,this.stateful=i,i&&console.assert(typeof this.value=="function","Stateful values must be functions")}get duration(){return this.whole.end.sub(this.whole.begin).mul(typeof this.value?.clip=="number"?this.value?.clip:1)}get endClipped(){return this.whole.begin.add(this.duration)}wholeOrPart(){return this.whole?this.whole:this.part}withSpan(e){const n=this.whole?e(this.whole):void 0;return new Hap(n,e(this.part),this.value,this.context)}withValue(e){return new Hap(this.whole,this.part,e(this.value),this.context)}hasOnset(){return this.whole!=null&&this.whole.begin.equals(this.part.begin)}resolveState(e){if(this.stateful&&this.hasOnset()){console.log("stateful");const n=this.value,[s,o]=n(e);return[s,new Hap(this.whole,this.part,o,this.context,!1)]}return[e,this]}spanEquals(e){return this.whole==null&&e.whole==null||this.whole.equals(e.whole)}equals(e){return this.spanEquals(e)&&this.part.equals(e.part)&&this.value===e.value}show(e=!1){const n=typeof this.value=="object"?e?JSON.stringify(this.value).slice(1,-1).replaceAll('"',"").replaceAll(","," "):JSON.stringify(this.value):this.value;var s="";if(this.whole==null)s="~"+this.part.show;else{var o=this.whole.begin.equals(this.part.begin)&&this.whole.end.equals(this.part.end);this.whole.begin.equals(this.part.begin)||(s=this.whole.begin.show()+" ⇜ "),o||(s+="("),s+=this.part.show(),o||(s+=")"),this.whole.end.equals(this.part.end)||(s+=" ⇝ "+this.whole.end.show())}return"[ "+s+" | "+n+" ]"}showWhole(e=!1){return`${this.whole==null?"~":this.whole.show()}: ${typeof this.value=="object"?e?JSON.stringify(this.value).slice(1,-1).replaceAll('"',"").replaceAll(","," "):JSON.stringify(this.value):this.value}`}combineContext(e){const n=this;return{...n.context,...e.context,locations:(n.context.locations||[]).concat(e.context.locations||[])}}setContext(e){return new Hap(this.whole,this.part,this.value,e)}ensureObjectValue(){if(typeof this.value!="object")throw new Error(`expected hap.value to be an object, but got "${this.value}". Hint: append .note() or .s() to the end`,"error")}}class State{constructor(e,n={}){this.span=e,this.controls=n}setSpan(e){return new State(e,this.controls)}withSpan(e){return this.setSpan(e(this.span))}setControls(e){return new State(this.span,e)}}const isNoteWithOctave=t=>/^[a-gA-G][#bs]*[0-9]$/.test(t),isNote=t=>/^[a-gA-G][#bsf]*[0-9]?$/.test(t),tokenizeNote=t=>{if(typeof t!="string")return[];const[e,n="",s]=t.match(/^([a-gA-G])([#bsf]*)([0-9]*)$/)?.slice(1)||[];return e?[e,n,s?Number(s):void 0]:[]},chromas={c:0,d:2,e:4,f:5,g:7,a:9,b:11},accs={"#":1,b:-1,s:1,f:-1},noteToMidi=(t,e=3)=>{const[n,s,o=e]=tokenizeNote(t);if(!n)throw new Error('not a note: "'+t+'"');const i=chromas[n.toLowerCase()],a=s?.split("").reduce((l,p)=>l+accs[p],0)||0;return(Number(o)+1)*12+i+a},midiToFreq=t=>Math.pow(2,(t-69)/12)*440,freqToMidi=t=>12*Math.log(t/440)/Math.LN2+69,valueToMidi=(t,e)=>{if(typeof t!="object")throw new Error("valueToMidi: expected object value");let{freq:n,note:s}=t;if(typeof n=="number")return freqToMidi(n);if(typeof s=="string")return noteToMidi(s);if(typeof s=="number")return s;if(!e)throw new Error("valueToMidi: expected freq or note to be set");return e},getFreq=t=>midiToFreq(typeof t=="number"?t:noteToMidi(t)),pcs=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],midi2note=t=>{const e=Math.floor(t/12)-1;return pcs[t%12]+e},_mod=(t,e)=>(t%e+e)%e,getPlayableNoteValue=t=>{let{value:e,context:n}=t,s=e;if(typeof s=="object"&&!Array.isArray(s)&&(s=s.note||s.n||s.value,s===void 0))throw new Error(`cannot find a playable note for ${JSON.stringify(e)}`);if(typeof s=="number"&&n.type!=="frequency")s=midiToFreq(t.value);else if(typeof s=="number"&&n.type==="frequency")s=t.value;else if(typeof s!="string"||!isNote(s))throw new Error("not a note: "+JSON.stringify(s));return s},getFrequency=t=>{let{value:e,context:n}=t;if(typeof e=="object")return e.freq?e.freq:getFreq(e.note||e.n||e.value);if(typeof e=="number"&&n.type!=="frequency")e=midiToFreq(t.value);else if(typeof e=="string"&&isNote(e))e=midiToFreq(noteToMidi(t.value));else if(typeof e!="number")throw new Error("not a note or frequency: "+e);return e},rotate=(t,e)=>t.slice(e).concat(t.slice(0,e)),pipe=(...t)=>t.reduce((e,n)=>(...s)=>e(n(...s)),e=>e),compose=(...t)=>pipe(...t.reverse()),removeUndefineds=t=>t.filter(e=>e!=null),flatten=t=>[].concat(...t),id=t=>t,constant=(t,e)=>t,listRange=(t,e)=>Array.from({length:e-t+1},(n,s)=>s+t);function curry(t,e,n=t.length){const s=function o(...i){if(i.length>=n)return t.apply(this,i);{const a=function(...l){return o.apply(this,i.concat(l))};return e&&e(a,i),a}};return e&&e(s,[]),s}function parseNumeral(t){const e=Number(t);if(!isNaN(e))return e;if(isNote(t))return noteToMidi(t);throw new Error(`cannot parse as numeral: "${t}"`)}function mapArgs(t,e){return(...n)=>t(...n.map(e))}function numeralArgs(t){return mapArgs(t,parseNumeral)}function parseFractional(t){const e=Number(t);if(!isNaN(e))return e;const n={pi:Math.PI,w:1,h:.5,q:.25,e:.125,s:.0625,t:1/3,f:.2,x:1/6}[t];if(typeof n<"u")return n;throw new Error(`cannot parse as fractional: "${t}"`)}const fractionalArgs=t=>mapArgs(t,parseFractional),splitAt=function(t,e){return[e.slice(0,t),e.slice(t)]},zipWith=(t,e,n)=>e.map((s,o)=>t(s,n[o])),clamp=(t,e,n)=>Math.min(Math.max(t,e),n),solfeggio=["Do","Reb","Re","Mib","Mi","Fa","Solb","Sol","Lab","La","Sib","Si"],indian=["Sa","Re","Ga","Ma","Pa","Dha","Ni"],german=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Hb","H"],byzantine=["Ni","Pab","Pa","Voub","Vou","Ga","Dib","Di","Keb","Ke","Zob","Zo"],japanese=["I","Ro","Ha","Ni","Ho","He","To"],english=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],sol2note=(t,e="letters")=>{const s=(e==="solfeggio"?solfeggio:e==="indian"?indian:e==="german"?german:e==="byzantine"?byzantine:e==="japanese"?japanese:english)[t%12],o=Math.floor(t/12)-1;return s+o};function unionWithObj(t,e,n){if(typeof e?.value=="number"){const o=Object.keys(t).filter(a=>typeof t[a]=="number"),i=Object.fromEntries(o.map(a=>[a,e.value]));e=Object.assign(e,i),delete e.value}const s=Object.keys(t).filter(o=>Object.keys(e).includes(o));return Object.assign({},t,e,Object.fromEntries(s.map(o=>[o,n(t[o],e[o])])))}curry((t,e)=>t*e);curry((t,e)=>e.map(t));function drawLine(t,e=60){let n=0,s=fraction(0),o=[""],i="";for(;o[0].length<e;){const a=t.queryArc(n,n+1),l=a.filter(g=>g.hasOnset()).map(g=>g.duration),p=gcd(...l),m=p.inverse();o=o.map(g=>g+"|"),i+="|";for(let g=0;g<m;g++){const[v,A]=[s,s.add(p)],b=a.filter(u=>u.whole.begin.lte(v)&&u.whole.end.gte(A)),c=b.length-o.length;c>0&&(o=o.concat(Array(c).fill(i))),o=o.map((u,f)=>{const d=b[f];if(d){const S=d.whole.begin.eq(v)?""+d.value:"-";return u+S}return u+"."}),i+=".",s=s.add(p)}n++}return o.join(`
`)}const logKey="strudel.log";function logger(t,e,n={}){console.log(`%c${t}`,"background-color: black;color:white;border-radius:15px"),typeof document<"u"&&typeof CustomEvent<"u"&&document.dispatchEvent(new CustomEvent(logKey,{detail:{message:t,type:e,data:n}}))}logger.key=logKey;let stringParser;const setStringParser=t=>stringParser=t;class Pattern{constructor(e){this.query=e,this._Pattern=!0}withValue(e){return new Pattern(n=>this.query(n).map(s=>s.withValue(e)))}fmap(e){return this.withValue(e)}appWhole(e,n){const s=this,o=function(i){const a=s.query(i),l=n.query(i),p=function(m,g){const v=m.part.intersection(g.part);if(v!=null)return new Hap(e(m.whole,g.whole),v,m.value(g.value),g.combineContext(m))};return flatten(a.map(m=>removeUndefineds(l.map(g=>p(m,g)))))};return new Pattern(o)}appBoth(e){const n=function(s,o){if(!(s==null||o==null))return s.intersection_e(o)};return this.appWhole(n,e)}appLeft(e){const n=this,s=function(o){const i=[];for(const a of n.query(o)){const l=e.query(o.setSpan(a.wholeOrPart()));for(const p of l){const m=a.whole,g=a.part.intersection(p.part);if(g){const v=a.value(p.value),A=p.combineContext(a),b=new Hap(m,g,v,A);i.push(b)}}}return i};return new Pattern(s)}appRight(e){const n=this,s=function(o){const i=[];for(const a of e.query(o)){const l=n.query(o.setSpan(a.wholeOrPart()));for(const p of l){const m=a.whole,g=p.part.intersection(a.part);if(g){const v=p.value(a.value),A=a.combineContext(p),b=new Hap(m,g,v,A);i.push(b)}}}return i};return new Pattern(s)}bindWhole(e,n){const s=this,o=function(i){const a=function(p,m){return new Hap(e(p.whole,m.whole),m.part,m.value,Object.assign({},p.context,m.context,{locations:(p.context.locations||[]).concat(m.context.locations||[])}))},l=function(p){return n(p.value).query(i.setSpan(p.part)).map(m=>a(p,m))};return flatten(s.query(i).map(p=>l(p)))};return new Pattern(o)}bind(e){const n=function(s,o){if(!(s==null||o==null))return s.intersection_e(o)};return this.bindWhole(n,e)}join(){return this.bind(id)}outerBind(e){return this.bindWhole(n=>n,e)}outerJoin(){return this.outerBind(id)}innerBind(e){return this.bindWhole((n,s)=>s,e)}innerJoin(){return this.innerBind(id)}trigJoin(e=!1){const n=this;return new Pattern(s=>n.discreteOnly().query(s).map(o=>o.value.late(e?o.whole.begin:o.whole.begin.cyclePos()).query(s).map(i=>new Hap(i.whole?i.whole.intersection(o.whole):void 0,i.part.intersection(o.part),i.value).setContext(o.combineContext(i))).filter(i=>i.part)).flat())}trigzeroJoin(){return this.trigJoin(!0)}squeezeJoin(){const e=this;function n(s){const o=e.discreteOnly().query(s);function i(l){const m=l.value._focusSpan(l.wholeOrPart()).query(s.setSpan(l.part));function g(v,A){let b;if(A.whole&&v.whole&&(b=A.whole.intersection(v.whole),!b))return;const c=A.part.intersection(v.part);if(!c)return;const u=A.combineContext(v);return new Hap(b,c,A.value,u)}return m.map(v=>g(l,v))}return flatten(o.map(i)).filter(l=>l)}return new Pattern(n)}squeezeBind(e){return this.fmap(e).squeezeJoin()}queryArc(e,n){try{return this.query(new State(new TimeSpan(e,n)))}catch(s){return logger(`[query]: ${s.message}`,"error"),[]}}splitQueries(){const e=this,n=s=>flatten(s.span.spanCycles.map(o=>e.query(s.setSpan(o))));return new Pattern(n)}withQuerySpan(e){return new Pattern(n=>this.query(n.withSpan(e)))}withQuerySpanMaybe(e){const n=this;return new Pattern(s=>{const o=s.withSpan(e);return o.span?n.query(o):[]})}withQueryTime(e){return new Pattern(n=>this.query(n.withSpan(s=>s.withTime(e))))}withHapSpan(e){return new Pattern(n=>this.query(n).map(s=>s.withSpan(e)))}withHapTime(e){return this.withHapSpan(n=>n.withTime(e))}withHaps(e){return new Pattern(n=>e(this.query(n)))}withHap(e){return this.withHaps(n=>n.map(e))}setContext(e){return this.withHap(n=>n.setContext(e))}withContext(e){return this.withHap(n=>n.setContext(e(n.context)))}stripContext(){return this.withHap(e=>e.setContext({}))}withLoc(e,n){const s={start:e,end:n};return this.withContext(o=>{const i=(o.locations||[]).concat([s]);return{...o,locations:i}})}filterHaps(e){return new Pattern(n=>this.query(n).filter(e))}filterValues(e){return new Pattern(n=>this.query(n).filter(s=>e(s.value)))}removeUndefineds(){return this.filterValues(e=>e!=null)}onsetsOnly(){return this.filterHaps(e=>e.hasOnset())}discreteOnly(){return this.filterHaps(e=>e.whole)}defragmentHaps(){return this.discreteOnly().withHaps(n=>{const s=[];for(var o=0;o<n.length;++o){for(var i=!0,a=n[o];i;){const m=JSON.stringify(n[o].value);for(var l=!1,p=o+1;p<n.length;p++){const g=n[p];if(a.whole.equals(g.whole)){if(a.part.begin.eq(g.part.end)){if(m===JSON.stringify(g.value)){a=new Hap(a.whole,new TimeSpan(g.part.begin,a.part.end),a.value),n.splice(p,1),l=!0;break}}else if(g.part.begin.eq(a.part.end)&&m==JSON.stringify(g.value)){a=new Hap(a.whole,new TimeSpan(a.part.begin,g.part.end),a.value),n.splice(p,1),l=!0;break}}}i=l}s.push(a)}return s})}firstCycle(e=!1){var n=this;return e||(n=n.stripContext()),n.query(new State(new TimeSpan(fraction(0),fraction(1))))}get firstCycleValues(){return this.firstCycle().map(e=>e.value)}get showFirstCycle(){return this.firstCycle().map(e=>`${e.value}: ${e.whole.begin.toFraction()} - ${e.whole.end.toFraction()}`)}sortHapsByPart(){return this.withHaps(e=>e.sort((n,s)=>n.part.begin.sub(s.part.begin).or(n.part.end.sub(s.part.end)).or(n.whole.begin.sub(s.whole.begin).or(n.whole.end.sub(s.whole.end)))))}asNumber(){return this.fmap(parseNumeral)}_opIn(e,n){return this.fmap(n).appLeft(reify(e))}_opOut(e,n){return this.fmap(n).appRight(reify(e))}_opMix(e,n){return this.fmap(n).appBoth(reify(e))}_opSqueeze(e,n){const s=reify(e);return this.fmap(o=>s.fmap(i=>n(o)(i))).squeezeJoin()}_opSqueezeOut(e,n){const s=this;return reify(e).fmap(i=>s.fmap(a=>n(a)(i))).squeezeJoin()}_opTrig(e,n){return reify(e).fmap(o=>this.fmap(i=>n(i)(o))).trigJoin()}_opTrigzero(e,n){return reify(e).fmap(o=>this.fmap(i=>n(i)(o))).trigzeroJoin()}layer(...e){return stack(...e.map(n=>n(this)))}superimpose(...e){return this.stack(...e.map(n=>n(this)))}stack(...e){return stack(this,...e)}sequence(...e){return sequence(this,...e)}seq(...e){return sequence(this,...e)}cat(...e){return cat(this,...e)}fastcat(...e){return fastcat(this,...e)}slowcat(...e){return slowcat(this,...e)}onTrigger(e,n=!0){return this.withHap(s=>s.setContext({...s.context,onTrigger:(...o)=>{s.context.onTrigger?.(...o),e(...o)},dominantTrigger:s.context.dominantTrigger||n}))}log(e=(s,o)=>`[hap] ${o.showWhole(!0)}`,n=(s,o)=>({hap:o})){return this.onTrigger((...s)=>{logger(e(...s),void 0,n(...s))},!1)}logValues(e=id){return this.log((n,s)=>e(s.value))}drawLine(){return console.log(drawLine(this)),this}}function groupHapsBy(t,e){let n=[];return e.forEach(s=>{const o=n.findIndex(([i])=>t(s,i));o===-1?n.push([s]):n[o].push(s)}),n}const congruent=(t,e)=>t.spanEquals(e);Pattern.prototype.collect=function(){return this.withHaps(t=>groupHapsBy(congruent,t).map(e=>new Hap(e[0].whole,e[0].part,e,{})))};Pattern.prototype.arpWith=function(t){return this.collect().fmap(e=>reify(t(e))).innerJoin().withHap(e=>new Hap(e.whole,e.part,e.value.value,e.combineContext(e.value)))};Pattern.prototype.arp=function(t){return this.arpWith(e=>t.fmap(n=>e[n%e.length]))};function _composeOp(t,e,n){function s(o){return o instanceof Object&&!(o instanceof Function)}return s(t)||s(e)?(s(t)||(t={value:t}),s(e)||(e={value:e}),unionWithObj(t,e,n)):n(t,e)}(function(){const t={set:[(n,s)=>s],keep:[n=>n],keepif:[(n,s)=>s?n:void 0],add:[numeralArgs((n,s)=>n+s)],sub:[numeralArgs((n,s)=>n-s)],mul:[numeralArgs((n,s)=>n*s)],div:[numeralArgs((n,s)=>n/s)],mod:[numeralArgs(_mod)],pow:[numeralArgs(Math.pow)],band:[numeralArgs((n,s)=>n&s)],bor:[numeralArgs((n,s)=>n|s)],bxor:[numeralArgs((n,s)=>n^s)],blshift:[numeralArgs((n,s)=>n<<s)],brshift:[numeralArgs((n,s)=>n>>s)],lt:[(n,s)=>n<s],gt:[(n,s)=>n>s],lte:[(n,s)=>n<=s],gte:[(n,s)=>n>=s],eq:[(n,s)=>n==s],eqt:[(n,s)=>n===s],ne:[(n,s)=>n!=s],net:[(n,s)=>n!==s],and:[(n,s)=>n&&s],or:[(n,s)=>n||s],func:[(n,s)=>s(n)]},e=["In","Out","Mix","Squeeze","SqueezeOut","Trig","Trigzero"];for(const[n,[s,o]]of Object.entries(t)){Pattern.prototype["_"+n]=function(i){return this.fmap(a=>s(a,i))},Object.defineProperty(Pattern.prototype,n,{get:function(){const i=this,a=(...l)=>i[n].in(...l);for(const l of e)a[l.toLowerCase()]=function(...p){var m=i;p=sequence(p),o&&(m=o(m),p=o(p));var g;return n==="keepif"?(g=m["_op"+l](p,v=>A=>s(v,A)),g=g.removeUndefineds()):g=m["_op"+l](p,v=>A=>_composeOp(v,A,s)),g};return a.squeezein=a.squeeze,a}});for(const i of e)Pattern.prototype[i.toLowerCase()]=function(...a){return this.set[i.toLowerCase()](a)}}Pattern.prototype.struct=function(...n){return this.keepif.out(...n)},Pattern.prototype.structAll=function(...n){return this.keep.out(...n)},Pattern.prototype.mask=function(...n){return this.keepif.in(...n)},Pattern.prototype.maskAll=function(...n){return this.keep.in(...n)},Pattern.prototype.reset=function(...n){return this.keepif.trig(...n)},Pattern.prototype.resetAll=function(...n){return this.keep.trig(...n)},Pattern.prototype.restart=function(...n){return this.keepif.trigzero(...n)},Pattern.prototype.restartAll=function(...n){return this.keep.trigzero(...n)}})();const polyrhythm=stack,pr=stack,pm=polymeter;Pattern.prototype.factories={pure,stack,slowcat,fastcat,cat,timeCat,sequence,seq,polymeter,pm,polyrhythm,pr};const silence=new Pattern(()=>[]);function pure(t){function e(n){return n.span.spanCycles.map(s=>new Hap(fraction(s.begin).wholeCycle(),s,t))}return new Pattern(e)}function isPattern(t){return t instanceof Pattern||t?._Pattern}function reify(t){return isPattern(t)?t:stringParser&&typeof t=="string"?stringParser(t):pure(t)}function stack(...t){t=t.map(n=>Array.isArray(n)?sequence(...n):reify(n));const e=n=>flatten(t.map(s=>s.query(n)));return new Pattern(e)}function slowcat(...t){t=t.map(n=>Array.isArray(n)?sequence(...n):reify(n));const e=function(n){const s=n.span,o=_mod(s.begin.sam(),t.length),i=t[o];if(!i)return[];const a=s.begin.floor().sub(s.begin.div(t.length).floor());return i.withHapTime(l=>l.add(a)).query(n.setSpan(s.withTime(l=>l.sub(a))))};return new Pattern(e).splitQueries()}function slowcatPrime(...t){t=t.map(reify);const e=function(n){const s=Math.floor(n.span.begin)%t.length;return t[s]?.query(n)||[]};return new Pattern(e).splitQueries()}function cat(...t){return slowcat(...t)}function timeCat(...t){const e=t.map(o=>o[0]).reduce((o,i)=>o.add(i),fraction(0));let n=fraction(0);const s=[];for(const[o,i]of t){const a=n.add(o);s.push(reify(i)._compress(n.div(e),a.div(e))),n=a}return stack(...s)}function arrange(...t){const e=t.reduce((n,[s])=>n+s,0);return t=t.map(([n,s])=>[n,s.fast(n)]),timeCat(...t).slow(e)}function fastcat(...t){return slowcat(...t)._fast(t.length)}function sequence(...t){return fastcat(...t)}function seq(...t){return fastcat(...t)}function _sequenceCount(t){return Array.isArray(t)?t.length==0?[silence,0]:t.length==1?_sequenceCount(t[0]):[fastcat(...t.map(e=>_sequenceCount(e)[0])),t.length]:[reify(t),1]}function polymeterSteps(t,...e){const n=e.map(o=>_sequenceCount(o));if(n.length==0)return silence;t==0&&(t=n[0][1]);const s=[];for(const o of n)o[1]!=0&&(t==o[1]?s.push(o[0]):s.push(o[0]._fast(fraction(t).div(fraction(o[1])))));return stack(...s)}function polymeter(...t){return polymeterSteps(0,...t)}const mask=curry((t,e)=>reify(e).mask(t)),struct=curry((t,e)=>reify(e).struct(t)),superimpose=curry((t,e)=>reify(e).superimpose(...t)),set=curry((t,e)=>reify(e).set(t)),keep=curry((t,e)=>reify(e).keep(t)),keepif=curry((t,e)=>reify(e).keepif(t)),add=curry((t,e)=>reify(e).add(t)),sub=curry((t,e)=>reify(e).sub(t)),mul=curry((t,e)=>reify(e).mul(t)),div=curry((t,e)=>reify(e).div(t)),mod=curry((t,e)=>reify(e).mod(t)),pow=curry((t,e)=>reify(e).pow(t)),band=curry((t,e)=>reify(e).band(t)),bor=curry((t,e)=>reify(e).bor(t)),bxor=curry((t,e)=>reify(e).bxor(t)),blshift=curry((t,e)=>reify(e).blshift(t)),brshift=curry((t,e)=>reify(e).brshift(t)),lt=curry((t,e)=>reify(e).lt(t)),gt=curry((t,e)=>reify(e).gt(t)),lte=curry((t,e)=>reify(e).lte(t)),gte=curry((t,e)=>reify(e).gte(t)),eq=curry((t,e)=>reify(e).eq(t)),eqt=curry((t,e)=>reify(e).eqt(t)),ne=curry((t,e)=>reify(e).ne(t)),net=curry((t,e)=>reify(e).net(t)),and=curry((t,e)=>reify(e).and(t)),or=curry((t,e)=>reify(e).or(t)),func=curry((t,e)=>reify(e).func(t));function register(t,e,n=!0){if(Array.isArray(t)){const i={};for(const a of t)i[a]=register(a,e,n);return i}const s=e.length;var o;return n?o=function(...i){i=i.map(reify);const a=i[i.length-1];if(s===1)return e(a);const[l,...p]=i.slice(0,-1);let m=(...g)=>(Array(s-1).fill().map((v,A)=>g[A]??void 0),e(...g,a));return m=curry(m,null,s-1),p.reduce((g,v)=>g.appLeft(v),l.fmap(m)).innerJoin()}:o=function(...i){return i=i.map(reify),e(...i)},Pattern.prototype[t]=function(...i){if(s===2&&i.length!==1)i=[sequence(...i)];else if(s!==i.length+1)throw new Error(`.${t}() expects ${s-1} inputs but got ${i.length}.`);return i=i.map(reify),o(...i,this)},s>1&&(Pattern.prototype["_"+t]=function(...i){return e(...i,this)}),curry(o,null,s)}const round=register("round",function(t){return t.asNumber().fmap(e=>Math.round(e))}),floor=register("floor",function(t){return t.asNumber().fmap(e=>Math.floor(e))}),ceil=register("ceil",function(t){return t.asNumber().fmap(e=>Math.ceil(e))}),toBipolar=register("toBipolar",function(t){return t.fmap(e=>e*2-1)}),fromBipolar=register("fromBipolar",function(t){return t.fmap(e=>(e+1)/2)}),range=register("range",function(t,e,n){return n.mul(e-t).add(t)}),rangex=register("rangex",function(t,e,n){return n._range(Math.log(t),Math.log(e)).fmap(Math.exp)}),range2=register("range2",function(t,e,n){return n.fromBipolar()._range(t,e)}),ratio=register("ratio",t=>t.fmap(e=>Array.isArray(e)?e.slice(1).reduce((n,s)=>n/s,e[0]):e)),compress=register("compress",function(t,e,n){return t=fraction(t),e=fraction(e),t.gt(e)||t.gt(1)||e.gt(1)||t.lt(0)||e.lt(0)?silence:n._fastGap(fraction(1).div(e.sub(t)))._late(t)}),{compressSpan,compressspan}=register(["compressSpan","compressspan"],function(t,e){return e._compress(t.begin,t.end)}),{fastGap,fastgap}=register(["fastGap","fastgap"],function(t,e){const n=function(o){const i=o.begin.sam(),a=o.begin.sub(i).mul(t).min(1),l=o.end.sub(i).mul(t).min(1);if(!(a>=1))return new TimeSpan(i.add(a),i.add(l))},s=function(o){const i=o.part.begin,a=o.part.end,l=i.sam(),p=i.sub(l).div(t).min(1),m=a.sub(l).div(t).min(1),g=new TimeSpan(l.add(p),l.add(m)),v=o.whole?new TimeSpan(g.begin.sub(i.sub(o.whole.begin).div(t)),g.end.add(o.whole.end.sub(a).div(t))):void 0;return new Hap(v,g,o.value,o.context)};return e.withQuerySpanMaybe(n).withHap(s).splitQueries()}),focus=register("focus",function(t,e,n){return t=fraction(t),e=fraction(e),n._fast(fraction(1).div(e.sub(t))).late(t.cyclePos())}),{focusSpan,focusspan}=register(["focusSpan","focusspan"],function(t,e){return e._focus(t.begin,t.end)}),ply=register("ply",function(t,e){return e.fmap(n=>pure(n)._fast(t)).squeezeJoin()}),{fast,density}=register(["fast","density"],function(t,e){return t===0?silence:(t=fraction(t),e.withQueryTime(s=>s.mul(t)).withHapTime(s=>s.div(t)))}),hurry=register("hurry",function(t,e){return e._fast(t).mul(pure({speed:t}))}),{slow,sparsity}=register(["slow","sparsity"],function(t,e){return t===0?silence:e._fast(fraction(1).div(t))}),inside=register("inside",function(t,e,n){return e(n._slow(t))._fast(t)}),outside=register("outside",function(t,e,n){return e(n._fast(t))._slow(t)}),lastOf=register("lastOf",function(t,e,n){const s=Array(t-1).fill(n);return s.push(e(n)),slowcatPrime(...s)}),{firstOf,every}=register(["firstOf","every"],function(t,e,n){const s=Array(t-1).fill(n);return s.unshift(e(n)),slowcatPrime(...s)}),apply=register("apply",function(t,e){return t(e)}),cpm=register("cpm",function(t,e){return e._fast(t/60)}),early=register("early",function(t,e){return t=fraction(t),e.withQueryTime(n=>n.add(t)).withHapTime(n=>n.sub(t))}),late=register("late",function(t,e){return t=fraction(t),e._early(fraction(0).sub(t))}),zoom=register("zoom",function(t,e,n){e=fraction(e),t=fraction(t);const s=e.sub(t);return n.withQuerySpan(o=>o.withCycle(i=>i.mul(s).add(t))).withHapSpan(o=>o.withCycle(i=>i.sub(t).div(s))).splitQueries()}),{zoomArc,zoomarc}=register(["zoomArc","zoomarc"],function(t,e){return e.zoom(t.begin,t.end)}),linger=register("linger",function(t,e){return t==0?silence:t<0?e._zoom(t.add(1),1)._slow(t):e._zoom(0,t)._slow(t)}),segment=register("segment",function(t,e){return e.struct(pure(!0)._fast(t))}),{invert,inv}=register(["invert","inv"],function(t){return t.fmap(e=>!e)}),when=register("when",function(t,e,n){return t?e(n):n}),off=register("off",function(t,e,n){return stack(n,e(n.late(t)))}),brak=register("brak",function(t){return t.when(slowcat(!1,!0),e=>fastcat(e,silence)._late(.25))}),rev=register("rev",function(t){const e=function(n){const s=n.span,o=s.begin.sam(),i=s.begin.nextSam(),a=function(p){const m=p.withTime(v=>o.add(i.sub(v))),g=m.begin;return m.begin=m.end,m.end=g,m};return t.query(n.setSpan(a(s))).map(p=>p.withSpan(a))};return new Pattern(e).splitQueries()}),pressBy=register("pressBy",function(t,e){return e.fmap(n=>pure(n).compress(t,1)).squeezeJoin()}),press=register("press",function(t){return t._pressBy(.5)}),hush=register("hush",function(t){return silence}),palindrome=register("palindrome",function(t){return t.every(2,rev)}),{juxBy,juxby}=register(["juxBy","juxby"],function(t,e,n){t/=2;const s=function(a,l,p){return l in a?a[l]:p},o=n.withValue(a=>Object.assign({},a,{pan:s(a,"pan",.5)-t})),i=n.withValue(a=>Object.assign({},a,{pan:s(a,"pan",.5)+t}));return stack(o,e(i))}),jux=register("jux",function(t,e){return e._juxBy(1,t,e)}),{echoWith,echowith,stutWith,stutwith}=register(["echoWith","echowith","stutWith","stutwith"],function(t,e,n,s){return stack(...listRange(0,t-1).map(o=>n(s.late(fraction(e).mul(o)),o)))}),echo=register("echo",function(t,e,n,s){return s._echoWith(t,e,(o,i)=>o.velocity(Math.pow(n,i)))}),stut=register("stut",function(t,e,n,s){return s._echoWith(t,n,(o,i)=>o.velocity(Math.pow(e,i)))}),_iter=function(t,e,n=!1){return t=fraction(t),slowcat(...listRange(0,t.sub(1)).map(s=>n?e.late(fraction(s).div(t)):e.early(fraction(s).div(t))))},iter=register("iter",function(t,e){return _iter(t,e,!1)}),{iterBack,iterback}=register(["iterBack","iterback"],function(t,e){return _iter(t,e,!0)}),_chunk=function(t,e,n,s=!1){const o=Array(t-1).fill(!1);o.unshift(!0);const i=_iter(t,sequence(...o),s);return n.when(i,e)},chunk=register("chunk",function(t,e,n){return _chunk(t,e,n,!1)}),{chunkBack,chunkback}=register(["chunkBack","chunkback"],function(t,e,n){return _chunk(t,e,n,!0)}),bypass=register("bypass",function(t,e){return t=!!parseInt(t),t?silence:e}),ribbon=register("ribbon",(t,e,n)=>n.early(t).restart(pure(1).slow(e))),duration=register("duration",function(t,e){return e.withHapSpan(n=>new TimeSpan(n.begin,n.begin.add(t)))}),{color,colour}=register(["color","colour"],function(t,e){return e.withContext(n=>({...n,color:t}))}),velocity=register("velocity",function(t,e){return e.withContext(n=>({...n,velocity:(n.velocity||1)*t}))}),legato=register("legato",function(t,e){return t=fraction(t),e.withHapSpan(n=>new TimeSpan(n.begin,n.begin.add(n.end.sub(n.begin).mul(t))))}),chop=register("chop",function(t,e){const s=Array.from({length:t},(i,a)=>a).map(i=>({begin:i/t,end:(i+1)/t})),o=function(i){return sequence(s.map(a=>Object.assign({},i,a)))};return e.squeezeBind(o)}),striate=register("striate",function(t,e){const s=Array.from({length:t},(i,a)=>a).map(i=>({begin:i/t,end:(i+1)/t})),o=slowcat(...s);return e.set(o)._fast(t)}),_loopAt=function(t,e,n=1){return e.speed(1/t*n).unit("c").slow(t)},slice=register("slice",function(t,e,n){return t.innerBind(s=>e.outerBind(o=>n.outerBind(i=>{i=i instanceof Object?i:{s:i};const a=Array.isArray(s)?s[o]:o/s,l=Array.isArray(s)?s[o+1]:(o+1)/s;return pure({begin:a,end:l,_slices:s,...i})})))},!1),splice=register("splice",function(t,e,n){return slice(t,e,n).withHap(function(o){return o.withValue(i=>({speed:1/i._slices/o.whole.duration*(i.speed||1),unit:"c",...i}))})},!1),{loopAt,loopat}=register(["loopAt","loopat"],function(t,e){return _loopAt(t,e,1)}),fit=register("fit",t=>t.withHap(e=>e.withValue(n=>({...n,speed:1/e.whole.duration,unit:"c"})))),{loopAtCps,loopatcps}=register(["loopAtCps","loopatcps"],function(t,e,n){return _loopAt(t,n,e)}),ref=t=>pure(1).withValue(()=>reify(t())).innerJoin(),controls={},generic_params=[[["s","n","gain"],"sound"],["source","src"],["n"],[["note","n"]],["accelerate"],["gain"],["postgain"],["amp"],["attack","att"],[["fmh","fmi"],"fmh"],[["fmi","fmh"],"fm"],["fmenv"],["fmattack"],["fmdecay"],["fmsustain"],["fmrelease"],["fmvelocity"],["bank"],["analyze"],["fft"],["decay"],["sustain","sus"],["release","rel"],["hold"],[["bandf","bandq"],"bpf","bp"],["bandq","bpq"],["begin"],["end"],["loop"],["loopBegin","loopb"],["loopEnd","loope"],["crush"],["coarse"],["channel"],["cut"],[["cutoff","resonance"],"ctf","lpf","lp"],["lpenv","lpe"],["hpenv","hpe"],["bpenv","bpe"],["lpattack","lpa"],["hpattack","hpa"],["bpattack","bpa"],["lpdecay","lpd"],["hpdecay","hpd"],["bpdecay","bpd"],["lpsustain","lps"],["hpsustain","hps"],["bpsustain","bps"],["lprelease","lpr"],["hprelease","hpr"],["bprelease","bpr"],["ftype"],["fanchor"],[["vib","vibmod"],"vibrato","v"],["noise"],[["vibmod","vib"],"vmod"],[["hcutoff","hresonance"],"hpf","hp"],["hresonance","hpq"],["resonance","lpq"],["djf"],[["delay","delaytime","delayfeedback"]],["delayfeedback","delayfb","dfb"],["delaytime","delayt","dt"],["lock"],["detune","det"],["dry"],["fadeTime","fadeOutTime"],["fadeInTime"],["freq"],["gate","gat"],["leslie"],["lrate"],["lsize"],["activeLabel"],[["label","activeLabel"]],["degree"],["mtranspose"],["ctranspose"],["harmonic"],["stepsPerOctave"],["octaveR"],["nudge"],["octave"],["orbit"],["overgain"],["overshape"],["pan"],["panspan"],["pansplay"],["panwidth"],["panorient"],["rate"],["slide"],["semitone"],["voice"],["chord"],["dictionary","dict"],["anchor"],["offset"],["octaves"],[["mode","anchor"]],[["room","size"]],["roomlp","rlp"],["roomdim","rdim"],["roomfade","rfade"],[["ir","i"],"iresponse"],["roomsize","size","sz","rsize"],["shape"],[["compressor","compressorRatio","compressorKnee","compressorAttack","compressorRelease"]],["compressorKnee"],["compressorRatio"],["compressorAttack"],["compressorRelease"],["speed"],["unit"],["squiz"],["vowel"],["waveloss"],["dur"],["expression"],["sustainpedal"],["tremolodepth","tremdp"],["tremolorate","tremr"],["phaserdepth","phasdp"],["phaserrate","phasr"],["fshift"],["fshiftnote"],["fshiftphase"],["triode"],["krush"],["kcutoff"],["octer"],["octersub"],["octersubsub"],["ring"],["ringf"],["ringdf"],["distort"],["freeze"],["xsdelay"],["tsdelay"],["real"],["imag"],["enhance"],["partials"],["comb"],["smear"],["scram"],["binshift"],["hbrick"],["lbrick"],["midichan"],["control"],["ccn"],["ccv"],["polyTouch"],["midibend"],["miditouch"],["ctlNum"],["frameRate"],["frames"],["hours"],["midicmd"],["minutes"],["progNum"],["seconds"],["songPtr"],["uid"],["val"],["cps"],["clip"],["zrand"],["curve"],["slide"],["deltaSlide"],["pitchJump"],["pitchJumpTime"],["lfo","repeatTime"],["znoise"],["zmod"],["zcrush"],["zdelay"],["tremolo"],["zzfx"]];controls.createParam=function(t){const e=Array.isArray(t)?t[0]:t;var n;Array.isArray(t)?n=i=>{if(Array.isArray(i)){const a={};return i.forEach((l,p)=>{p<t.length&&(a[t[p]]=l)}),a}else return{[e]:i}}:n=i=>({[e]:i});const s=(...i)=>sequence(...i).withValue(n),o=function(...i){return i.length?this.set(s(...i)):this.fmap(n)};return Pattern.prototype[e]=o,s};generic_params.forEach(([t,...e])=>{const n=Array.isArray(t)?t[0]:t;controls[n]=controls.createParam(t),e.forEach(s=>{controls[s]=controls[n],Pattern.prototype[s]=Pattern.prototype[n]})});controls.createParams=(...t)=>t.reduce((e,n)=>Object.assign(e,{[n]:controls.createParam(n)}),{});controls.adsr=register("adsr",(t,e)=>{t=Array.isArray(t)?t:[t];const[n,s,o,i]=t;return e.set({attack:n,decay:s,sustain:o,release:i})});controls.ds=register("ds",(t,e)=>{t=Array.isArray(t)?t:[t];const[n,s]=t;return e.set({decay:n,sustain:s})});const left=function(t,e){const[n,s]=t,[o,i]=e,[a,l]=splitAt(s,o);return[[s,n-s],[zipWith((p,m)=>p.concat(m),a,i),l]]},right=function(t,e){const[n,s]=t,[o,i]=e,[a,l]=splitAt(n,i);return[[n,s-n],[zipWith((m,g)=>m.concat(g),o,a),l]]},_bjork=function(t,e){const[n,s]=t;return Math.min(n,s)<=1?[t,e]:_bjork(...n>s?left(t,e):right(t,e))},bjork=function(t,e){const n=e-t,s=Array(t).fill([1]),o=Array(n).fill([0]),i=_bjork([t,n],[s,o]);return flatten(i[1][0]).concat(flatten(i[1][1]))},_euclidRot=function(t,e,n){const s=bjork(t,e);return n?rotate(s,-n):s},euclid=register("euclid",function(t,e,n){return n.struct(_euclidRot(t,e,0))}),{euclidrot,euclidRot}=register(["euclidrot","euclidRot"],function(t,e,n,s){return s.struct(_euclidRot(t,e,n))}),_euclidLegato=function(t,e,n,s){if(t<1)return silence;const i=_euclidRot(t,e,n).join("").split("1").slice(1).map(a=>[a.length+1,!0]);return s.struct(timeCat(...i))},euclidLegato=register(["euclidLegato"],function(t,e,n){return _euclidLegato(t,e,0,n)}),euclidLegatoRot=register(["euclidLegatoRot"],function(t,e,n,s){return _euclidLegato(t,e,n,s)});function steady(t){return new Pattern(e=>[new Hap(void 0,e.span,t)])}const signal=t=>{const e=n=>[new Hap(void 0,n.span,t(n.span.midpoint()))];return new Pattern(e)},isaw=signal(t=>1-t%1),isaw2=isaw.toBipolar(),saw=signal(t=>t%1),saw2=saw.toBipolar(),sine2=signal(t=>Math.sin(Math.PI*2*t)),sine=sine2.fromBipolar(),cosine=sine._early(fraction(1).div(4)),cosine2=sine2._early(fraction(1).div(4)),square=signal(t=>Math.floor(t*2%2)),square2=square.toBipolar(),tri=fastcat(isaw,saw),tri2=fastcat(isaw2,saw2),time$1=signal(id),xorwise=t=>{const e=t<<13^t,n=e>>17^e;return n<<5^n},_frac=t=>t-Math.trunc(t),timeToIntSeed=t=>xorwise(Math.trunc(_frac(t/300)*536870912)),intSeedToRand=t=>t%536870912/536870912,timeToRand=t=>Math.abs(intSeedToRand(timeToIntSeed(t))),run=t=>saw.range(0,t).floor().segment(t),rand=signal(timeToRand),rand2=rand.toBipolar(),_brandBy=t=>rand.fmap(e=>e<t),brandBy=t=>reify(t).fmap(_brandBy).innerJoin(),brand=_brandBy(.5),_irand=t=>rand.fmap(e=>Math.trunc(e*t)),irand=t=>reify(t).fmap(_irand).innerJoin(),__chooseWith=(t,e)=>(e=e.map(reify),e.length==0?silence:t.range(0,e.length).fmap(n=>e[Math.floor(n)])),chooseWith=(t,e)=>__chooseWith(t,e).outerJoin(),chooseInWith=(t,e)=>__chooseWith(t,e).innerJoin(),choose=(...t)=>chooseWith(rand,t);Pattern.prototype.choose=function(...t){return chooseWith(this,t)};Pattern.prototype.choose2=function(...t){return chooseWith(this.fromBipolar(),t)};const chooseCycles=(...t)=>chooseInWith(rand.segment(1),t),randcat=chooseCycles,_wchooseWith=function(t,...e){const n=e.map(l=>reify(l[0])),s=[];let o=0;for(const l of e)o+=l[1],s.push(o);const i=o,a=function(l){const p=l*i;return n[s.findIndex(m=>m>p,s)]};return t.fmap(a)},wchooseWith=(...t)=>_wchooseWith(...t).outerJoin(),wchoose=(...t)=>wchooseWith(rand,...t),wchooseCycles=(...t)=>_wchooseWith(rand,...t).innerJoin(),perlinWith=t=>{const e=t.fmap(Math.floor),n=t.fmap(i=>Math.floor(i)+1),s=i=>6*i**5-15*i**4+10*i**3,o=i=>a=>l=>a+s(i)*(l-a);return t.sub(e).fmap(o).appBoth(e.fmap(timeToRand)).appBoth(n.fmap(timeToRand))},perlin=perlinWith(time$1.fmap(t=>Number(t))),degradeByWith=register("degradeByWith",(t,e,n)=>n.fmap(s=>o=>s).appLeft(t.filterValues(s=>s>e))),degradeBy=register("degradeBy",function(t,e){return e._degradeByWith(rand,t)}),degrade=register("degrade",t=>t._degradeBy(.5)),undegradeBy=register("undegradeBy",function(t,e){return e._degradeByWith(rand.fmap(n=>1-n),t)}),undegrade=register("undegrade",t=>t._undegradeBy(.5)),sometimesBy=register("sometimesBy",function(t,e,n){return reify(t).fmap(s=>stack(n._degradeBy(s),e(n._undegradeBy(1-s)))).innerJoin()}),sometimes=register("sometimes",function(t,e){return e._sometimesBy(.5,t)}),someCyclesBy=register("someCyclesBy",function(t,e,n){return reify(t).fmap(s=>stack(n._degradeByWith(rand._segment(1),s),e(n._degradeByWith(rand.fmap(o=>1-o)._segment(1),1-s)))).innerJoin()}),someCycles=register("someCycles",function(t,e){return e._someCyclesBy(.5,t)}),often=register("often",function(t,e){return e.sometimesBy(.75,t)}),rarely=register("rarely",function(t,e){return e.sometimesBy(.25,t)}),almostNever=register("almostNever",function(t,e){return e.sometimesBy(.1,t)}),almostAlways=register("almostAlways",function(t,e){return e.sometimesBy(.9,t)}),never=register("never",function(t,e){return e}),always=register("always",function(t,e){return t(e)});let synth;try{synth=window?.speechSynthesis}catch{console.warn("cannot use window: not in browser?")}let allVoices=synth?.getVoices();function triggerSpeech(t,e,n){synth.cancel();const s=new SpeechSynthesisUtterance(t);s.lang=e,allVoices=synth.getVoices();const o=allVoices.filter(i=>i.lang.includes(e));typeof n=="number"?s.voice=o[n%o.length]:typeof n=="string"&&(s.voice=o.find(i=>i.name===i)),speechSynthesis.speak(s)}const speak=register("speak",function(t,e,n){return n.onTrigger((s,o)=>{triggerSpeech(o.value,t,e)})}),evalScope=async(...t)=>{const e=await Promise.allSettled(t),n=e.filter(s=>s.status==="fulfilled").map(s=>s.value);e.forEach((s,o)=>{s.status==="rejected"&&console.warn(`evalScope: module with index ${o} could not be loaded:`,s.reason)}),n.forEach(s=>{Object.entries(s).forEach(([o,i])=>{globalThis[o]=i})})};function safeEval(t,e={}){const{wrapExpression:n=!0,wrapAsync:s=!0}=e;n&&(t=`{${t}}`),s&&(t=`(async ()=>${t})()`);const o=`"use strict";return (${t})`;return Function(o)()}const evaluate=async(t,e)=>{let n={};if(e){const i=e(t);t=i.output,n=i}let o=await safeEval(t,{wrapExpression:!!e});if(!isPattern(o)){console.log("evaluated",o);const i=`got "${typeof o}" instead of pattern`;throw new Error(i+(typeof o=="function"?", did you forget to call a function?":"."))}return{mode:"javascript",pattern:o,meta:n}};function createClock(t,e,n=.05,s=.1,o=.1){let i=0,a=0,l=10**4,p=.01;const m=d=>n=d(n);o=o||s/2;const g=()=>{const d=t(),q=d+s+o;for(a===0&&(a=d+p);a<q;)a=Math.round(a*l)/l,a>=d&&e(a,n,i),a<d&&console.log("TOO LATE",a),a+=n,i++};let v;const A=()=>{b(),g(),v=setInterval(g,s*1e3)},b=()=>v!==void 0&&clearInterval(v);return{setDuration:m,start:A,stop:()=>{i=0,a=0,b()},pause:()=>b(),duration:n,interval:s,getPhase:()=>a,minLatency:p}}class Cyclist{constructor({interval:e,onTrigger:n,onToggle:s,onError:o,getTime:i,latency:a=.1}){this.started=!1,this.cps=1,this.lastTick=0,this.lastBegin=0,this.lastEnd=0,this.getTime=i,this.onToggle=s,this.latency=a;const l=m=>Math.round(m*1e3)/1e3;this.clock=createClock(i,(m,g,v)=>{v===0&&(this.origin=m);try{const A=i(),b=this.lastEnd;this.lastBegin=b;const c=l(b+g*this.cps);this.lastEnd=c;const u=this.pattern.queryArc(b,c),f=m-A;this.lastTick=A+f,u.forEach(d=>{if(d.part.begin.equals(d.whole.begin)){const q=(d.whole.begin-b)/this.cps+f+a,S=d.duration/this.cps;n?.(d,q,S,this.cps)}})}catch(A){logger(`[cyclist] error: ${A.message}`),o?.(A)}},e);let p=this;globalThis.__cyclist__=p}now(){const e=this.getTime()-this.lastTick-this.clock.duration;return this.lastBegin+e*this.cps}setStarted(e){this.started=e,this.onToggle?.(e)}start(){if(!this.pattern)throw new Error("Scheduler: no pattern set! call .setPattern first.");logger("[cyclist] start"),this.clock.start(),this.setStarted(!0)}pause(){logger("[cyclist] pause"),this.clock.pause(),this.setStarted(!1)}stop(){logger("[cyclist] stop"),this.clock.stop(),this.lastEnd=0,this.setStarted(!1)}setPattern(e,n=!1){this.pattern=e,n&&!this.started&&this.start()}setCps(e=1){this.cps=e}log(e,n,s){const o=s.filter(i=>i.hasOnset());console.log(`${e.toFixed(4)} - ${n.toFixed(4)} ${Array(o.length).fill("I").join("")}`)}}let time;function getTime(){if(!time)throw new Error("no time set! use setTime to define a time source");return time()}function setTime(t){time=t}function repl({interval:t,defaultOutput:e,onSchedulerError:n,onEvalError:s,beforeEval:o,afterEval:i,getTime:a,transpiler:l,onToggle:p,editPattern:m}){const g=new Cyclist({interval:t,onTrigger:getTrigger({defaultOutput:e,getTime:a}),onError:n,getTime:a,onToggle:p}),v=(_,M=!0)=>{_=m?.(_)||_,g.setPattern(_,M)};setTime(()=>g.now());const A=async(_,M=!0)=>{if(!_)throw new Error("no code to evaluate");try{await o?.({code:_});let{pattern:C,meta:O}=await evaluate(_,l);return logger("[eval] code updated"),v(C,M),i?.({code:_,pattern:C,meta:O}),C}catch(C){logger(`[eval] error: ${C.message}`,"error"),s?.(C)}},b=()=>g.stop(),c=()=>g.start(),u=()=>g.pause(),f=_=>g.setCps(_),d=_=>g.setCps(_/60),q=register("loopAt",(_,M)=>M.loopAtCps(_,g.cps)),S=register("fit",_=>_.withHap(M=>M.withValue(C=>({...C,speed:g.cps/M.whole.duration,unit:"c"}))));return evalScope({loopAt:q,fit:S,setCps:f,setcps:f,setCpm:d,setcpm:d}),{scheduler:g,evaluate:A,start:c,stop:b,pause:u,setCps:f,setPattern:v}}const getTrigger=({getTime:t,defaultOutput:e})=>async(n,s,o,i)=>{try{(!n.context.onTrigger||!n.context.dominantTrigger)&&await e(n,s,o,i),n.context.onTrigger&&await n.context.onTrigger(t()+s,n,t(),i)}catch(a){logger(`[cyclist] error: ${a.message}`,"error")}},getDrawContext=(t="test-canvas")=>{let e=document.querySelector("#"+t);if(!e){e=document.createElement("canvas"),e.id=t,e.width=window.innerWidth*2,e.height=window.innerHeight*2,e.style="pointer-events:none;width:100%;height:100%;position:fixed;top:0;left:0",document.body.prepend(e);let s;window.addEventListener("resize",()=>{s&&clearTimeout(s),s=setTimeout(()=>{e.width=window.innerWidth*2,e.height=window.innerHeight*2},200)})}return e.getContext("2d")};Pattern.prototype.draw=function(t,{from:e,to:n,onQuery:s}={}){if(typeof window>"u")return this;window.strudelAnimation&&cancelAnimationFrame(window.strudelAnimation);const o=getDrawContext();let i,a=[];const l=p=>{const m=getTime();if(e!==void 0&&n!==void 0){const g=Math.floor(m);if(i!==g){i=g;const v=g+e,A=g+n;setTimeout(()=>{a=this.query(new State(new TimeSpan(v,A))).filter(Boolean).filter(b=>b.part.begin.equals(b.whole.begin)),s?.(a)},0)}}t(o,a,m,p),window.strudelAnimation=requestAnimationFrame(l)};return requestAnimationFrame(l),this};const cleanupDraw=(t=!0)=>{const e=getDrawContext();t&&e.clearRect(0,0,e.canvas.width,e.canvas.width),window.strudelAnimation&&cancelAnimationFrame(window.strudelAnimation),window.strudelScheduler&&clearInterval(window.strudelScheduler)};Pattern.prototype.onPaint=function(t){return this.context={onPaint:t},this};class Framer{constructor(e,n){this.onFrame=e,this.onError=n}start(){const e=this;let n=requestAnimationFrame(function s(o){try{e.onFrame(o)}catch(i){e.onError(i)}n=requestAnimationFrame(s)});e.cancel=()=>{cancelAnimationFrame(n)}}stop(){this.cancel&&this.cancel()}}class Drawer{constructor(e,n){let[s,o]=n;s=Math.abs(s),this.visibleHaps=[],this.lastFrame=null,this.drawTime=n,this.framer=new Framer(()=>{if(!this.scheduler){console.warn("Drawer: no scheduler");return}const i=this.scheduler.now()+o;if(this.lastFrame===null){this.lastFrame=i;return}const a=this.scheduler.pattern.queryArc(Math.max(this.lastFrame,i-1/10),i);this.lastFrame=i,this.visibleHaps=(this.visibleHaps||[]).filter(p=>p.whole.end>=i-s-o).concat(a.filter(p=>p.hasOnset()));const l=i-o;e(this.visibleHaps,l,this)},i=>{console.warn("draw error",i)})}invalidate(e=this.scheduler){if(!e)return;this.scheduler=e;const n=e.now();let[s,o]=this.drawTime;const[i,a]=[Math.max(n,0),n+o+.1];this.visibleHaps=this.visibleHaps.filter(p=>p.whole.begin<n);const l=e.pattern.queryArc(i,a);this.visibleHaps=this.visibleHaps.concat(l)}start(e){this.scheduler=e,this.invalidate(),this.framer.start()}stop(){this.framer&&this.framer.stop()}}const{createParams}=controls;let clearColor="#22222210";Pattern.prototype.animate=function({callback:t,sync:e=!1,smear:n=.5}={}){window.frame&&cancelAnimationFrame(window.frame);const s=getDrawContext(),{clientWidth:o,clientHeight:i}=s.canvas;let a=n===0?"99":Number((1-n)*100).toFixed(0);a=a.length===1?`0${a}`:a,clearColor=`#200010${a}`;const l=p=>{let m;p=Math.round(p),m=this.slow(1e3).queryArc(p,p),s.fillStyle=clearColor,s.fillRect(0,0,o,i),m.forEach(g=>{let{x:v,y:A,w:b,h:c,s:u,r:f,angle:d=0,fill:q="darkseagreen"}=g.value;if(b*=o,c*=i,f!==void 0&&d!==void 0){const _=d*2*Math.PI,[M,C]=[(o-b)/2,(i-c)/2];v=M+Math.cos(_)*f*M,A=C+Math.sin(_)*f*C}else v*=o-b,A*=i-c;const S={...g.value,x:v,y:A,w:b,h:c};s.fillStyle=q,u==="rect"?s.fillRect(v,A,b,c):u==="ellipse"&&(s.beginPath(),s.ellipse(v+b/2,A+c/2,b/2,c/2,0,0,2*Math.PI),s.fill()),t&&t(s,S,g)}),window.frame=requestAnimationFrame(l)};return window.frame=requestAnimationFrame(l),silence};const{x,y,w,h,angle,r,fill,smear}=createParams("x","y","w","h","angle","r","fill","smear"),rescale=register("rescale",function(t,e){return e.mul(x(t).w(t).y(t).h(t))}),moveXY=register("moveXY",function(t,e,n){return n.add(x(t).y(e))}),zoomIn=register("zoomIn",function(t,e){const n=pure(1).sub(t).div(2);return e.rescale(t).move(n,n)}),scale=(t,e,n)=>t*(n-e)+e,getValue=t=>{let{value:e}=t;typeof t.value!="object"&&(e={value:e});let{note:n,n:s,freq:o,s:i}=e;return o?freqToMidi(o):(n=n??s,typeof n=="string"?noteToMidi(n):typeof n=="number"?n:i?"_"+i:e)};globalThis.haps_from_outputs=[];Pattern.prototype.pianoroll=function(t={}){let{cycles:e=4,playhead:n=.5,overscan:s=1,hideNegative:o=!1}=t,i=-e*n,a=e*(1-n);return this.draw((l,p,m)=>{const g=v=>(!o||v.whole.begin>=0)&&v.whole.begin<=m+a&&v.endClipped>=m+i;globalThis.haps_from_outputs.length>0?(p.push(...globalThis.haps_from_outputs),p=haps_from_outputs.filter(g),globalThis.haps_from_outputs=p):p=p.filter(g),pianoroll({...t,time:m,ctx:l,haps:p})},{from:i-s,to:a+s}),this};function pianoroll({time:t,haps:e,cycles:n=4,playhead:s=.5,flipTime:o=0,flipValues:i=0,hideNegative:a=!1,inactive:l="#7491D2",active:p="#FFCA28",background:m="transparent",smear:g=0,playheadColor:v="white",minMidi:A=10,maxMidi:b=90,autorange:c=0,timeframe:u,fold:f=0,vertical:d=0,labels:q=!1,fill:S=1,fillActive:_=!1,strokeActive:M=!0,stroke:C,hideInactive:O=0,colorizeInactive:P=1,fontFamily:k,ctx:T}={}){const N=T.canvas.width,E=T.canvas.height;let H=-n*s,I=n*(1-s);u&&(console.warn("timeframe is deprecated! use from/to instead"),H=0,I=u);const W=d?E:N,j=d?N:E;let Q=d?[W,0]:[0,W];const V=I-H,Z=d?[0,j]:[j,0];let G=b-A+1,L=j/G,K=[];o&&Q.reverse(),i&&Z.reverse();const{min:oe,max:ie,values:ae}=e.reduce(({min:B,max:z,values:$},D)=>{const F=getValue(D);return{min:F<B?F:B,max:F>z?F:z,values:$.includes(F)?$:[...$,F]}},{min:1/0,max:-1/0,values:[]});c&&(A=oe,b=ie,G=b-A+1),K=ae.sort((B,z)=>String(B).localeCompare(String(z))),L=f?j/K.length:j/G,T.fillStyle=m,T.globalAlpha=1,g||(T.clearRect(0,0,N,E),T.fillRect(0,0,N,E)),e.forEach(B=>{const z=B.whole.begin<=t&&B.endClipped>t;let $=C??(M&&z),D=!z&&S||z&&_;if(O&&!z)return;let F=B.value?.color||B.context?.color;p=F||p,l=P&&F||l,F=z?p:l,T.fillStyle=D?F:"transparent",T.strokeStyle=F,T.globalAlpha=B.context.velocity??B.value?.gain??1;const ce=(B.whole.begin-(o?I:H))/V,X=scale(ce,...Q);let R=scale(B.duration/V,0,W);const Y=getValue(B),ue=f?K.indexOf(Y)/K.length:(Number(Y)-A)/G,ee=scale(ue,...Z);let te=0;const re=scale(t/V,...Q);let J;if(d?J=[ee+1-(i?L:0),W-re+X+te+1-(o?0:R),L-2,R-2]:J=[X-re+te+1-(o?R:0),ee+1-(i?0:L),R-2,L-2],$&&T.strokeRect(...J),D&&T.fillRect(...J),q){const le=B.value.note??B.value.s+(B.value.n?`:${B.value.n}`:""),{label:se,activeLabel:fe}=B.value,he=(z&&fe||se)??le;let pe=d?R:L*.75;T.font=`${pe}px ${k||"monospace"}`,T.fillStyle=D?"black":F,T.textBaseline="top",T.fillText(he,...J)}}),T.globalAlpha=1;const U=scale(-H/V,...Q);return T.strokeStyle=v,T.beginPath(),d?(T.moveTo(0,U),T.lineTo(j,U)):(T.moveTo(U,0),T.lineTo(U,j)),T.stroke(),this}function getDrawOptions(t,e={}){let[n,s]=t;n=Math.abs(n);const o=s+n,i=n/o;return{fold:1,...e,cycles:o,playhead:i}}Pattern.prototype.punchcard=function(t){return this.onPaint((e,n,s,o,i={})=>pianoroll({ctx:e,time:n,haps:s,...getDrawOptions(o,{...i,...t})}))};Pattern.prototype.wordfall=function(t){return this.punchcard({vertical:1,labels:1,stroke:0,fillActive:1,active:"white",...t})};function drawPianoroll(t){const{drawTime:e,...n}=t;pianoroll({...getDrawOptions(e),...n})}function fromPolar(t,e,n,s){const o=(t-90)*Math.PI/180;return[n+Math.cos(o)*e,s+Math.sin(o)*e]}const xyOnSpiral=(t,e,n,s,o=0)=>fromPolar((t+o)*360,e*t,n,s);function spiralSegment(t){let{ctx:e,from:n=0,to:s=3,margin:o=50,cx:i=100,cy:a=100,rotate:l=0,thickness:p=o/2,color:m="#0000ff30",cap:g="round",stretch:v=1,fromOpacity:A=1,toOpacity:b=1}=t;n*=v,s*=v,l*=v,e.lineWidth=p,e.lineCap=g,e.strokeStyle=m,e.globalAlpha=A,e.beginPath();let[c,u]=xyOnSpiral(n,o,i,a,l);e.moveTo(c,u);const f=1/60;let d=n;for(;d<=s;){const[q,S]=xyOnSpiral(d,o,i,a,l);e.globalAlpha=(d-n)/(s-n)*b,e.lineTo(q,S),d+=f}e.stroke()}Pattern.prototype.spiral=function(t={}){const{stretch:e=1,size:n=80,thickness:s=n/2,cap:o="butt",inset:i=3,playheadColor:a="#ffffff90",playheadLength:l=.02,playheadThickness:p=s,padding:m=0,steady:g=1,inactiveColor:v="#ffffff20",colorizeInactive:A=0,fade:b=!0}=t;function c({ctx:u,time:f,haps:d,drawTime:q}){const[S,_]=[u.canvas.width,u.canvas.height];u.clearRect(0,0,S*2,_*2);const[M,C]=[S/2,_/2],O={margin:n/e,cx:M,cy:C,stretch:e,cap:o,thickness:s},P={...O,thickness:p,from:i-l,to:i,color:a},[k]=q,T=g*f;d.forEach(N=>{const E=N.whole.begin<=f&&N.endClipped>f,H=N.whole.begin-f+i,I=N.endClipped-f+i-m,{color:W}=N.context,j=b?1-Math.abs((N.whole.begin-f)/k):1;spiralSegment({ctx:u,...O,from:H,to:I,rotate:T,color:A||E?W:v,fromOpacity:j,toOpacity:j})}),spiralSegment({ctx:u,...P,rotate:T})}return this.onPaint((u,f,d,q)=>c({ctx:u,time:f,haps:d,drawTime:q}))};function frame(t){window.strudelAnimation&&cancelAnimationFrame(window.strudelAnimation);const e=n=>{t(n,getTime()),window.strudelAnimation=requestAnimationFrame(e)};requestAnimationFrame(e)}const backgroundImage=function(t,e={}){const n=document.getElementById("code"),s="background-image:url("+t+");background-size:contain;";n.style=s;const{className:o}=n,i=(p,m)=>{({style:()=>n.style=s+";"+m,className:()=>n.className=m+" "+o})[p]()},a=Object.entries(e).filter(([p,m])=>typeof m=="function");Object.entries(e).filter(([p,m])=>typeof m=="string").forEach(([p,m])=>i(p,m)),a.length!==0&&frame((p,m)=>a.forEach(([g,v])=>{i(g,v(m))}))},cleanupUi=()=>{const t=document.getElementById("code");t&&(t.style="",t.className="grow flex text-gray-100 relative overflow-auto cursor-text pb-0")},gist=(route,cache=!0)=>fetch(`https://gist.githubusercontent.com/${route}?cachebust=${cache?"":Date.now()}`).then(t=>t.text()).then(code=>eval(code));logger("🌀 @strudel.cycles/core loaded 🌀");globalThis._strudelLoaded&&console.warn(`@strudel.cycles/core was loaded more than once...
This might happen when you have multiple versions of strudel installed. 
Please check with "npm ls @strudel.cycles/core".`);globalThis._strudelLoaded=!0;const strudel=Object.freeze(Object.defineProperty({__proto__:null,Cyclist,Drawer,Fraction:fraction,Framer,Hap,Pattern,State,TimeSpan,__chooseWith,_brandBy,_irand,_mod,add,almostAlways,almostNever,always,and,angle,apply,arrange,backgroundImage,band,bjork,blshift,bor,brak,brand,brandBy,brshift,bxor,bypass,cat,ceil,choose,chooseCycles,chooseInWith,chooseWith,chop,chunk,chunkBack,chunkback,clamp,cleanupDraw,cleanupUi,color,colour,compose,compress,compressSpan,compressspan,constant,controls,cosine,cosine2,cpm,curry,degrade,degradeBy,degradeByWith,density,div,drawLine,drawPianoroll,duration,early,echo,echoWith,echowith,eq,eqt,euclid,euclidLegato,euclidLegatoRot,euclidRot,euclidrot,evalScope,evaluate,every,fast,fastGap,fastcat,fastgap,fill,firstOf,fit,flatten,floor,focus,focusSpan,focusspan,fractionalArgs,freqToMidi,fromBipolar,func,getDrawContext,getDrawOptions,getFreq,getFrequency,getPlayableNoteValue,getTime,getTrigger,gist,gt,gte,h,hurry,hush,id,inside,inv,invert,irand,isNote,isNoteWithOctave,isPattern,isaw,isaw2,iter,iterBack,iterback,jux,juxBy,juxby,keep,keepif,lastOf,late,legato,linger,listRange,logKey,logger,loopAt,loopAtCps,loopat,loopatcps,lt,lte,mapArgs,mask,midi2note,midiToFreq,mod,moveXY,mul,ne,net,never,noteToMidi,numeralArgs,off,often,or,outside,palindrome,parseFractional,parseNumeral,perlin,perlinWith,pianoroll,pipe,ply,pm,polymeter,polymeterSteps,polyrhythm,pow,pr,press,pressBy,pure,r,rand,rand2,randcat,range,range2,rangex,rarely,ratio,ref,register,reify,removeUndefineds,repl,rescale,rev,ribbon,rotate,round,run,saw,saw2,segment,seq,sequence,set,setStringParser,setTime,signal,silence,sine,sine2,slice,slow,slowcat,slowcatPrime,smear,sol2note,someCycles,someCyclesBy,sometimes,sometimesBy,sparsity,speak,splice,splitAt,square,square2,stack,steady,striate,struct,stut,stutWith,stutwith,sub,superimpose,time:time$1,timeCat,toBipolar,tokenizeNote,tri,tri2,undegrade,undegradeBy,valueToMidi,velocity,w,wchoose,wchooseCycles,when,x,y,zipWith,zoom,zoomArc,zoomIn,zoomarc},Symbol.toStringTag,{value:"Module"}));let listenerQueue=[],atom=(t,e)=>{let n,s=[],o={lc:0,l:e||0,value:t,set(i){o.value=i,o.notify()},get(){return o.lc||o.listen(()=>{})(),o.value},notify(i){n=s;let a=!listenerQueue.length;for(let l=0;l<n.length;l+=2)listenerQueue.push(n[l],o.value,i,n[l+1]);if(a){for(let l=0;l<listenerQueue.length;l+=4){let p=!1;for(let m=l+7;m<listenerQueue.length;m+=4)if(listenerQueue[m]<listenerQueue[l+3]){p=!0;break}p?listenerQueue.push(listenerQueue[l],listenerQueue[l+1],listenerQueue[l+2],listenerQueue[l+3]):listenerQueue[l](listenerQueue[l+1],listenerQueue[l+2])}listenerQueue.length=0}},listen(i,a){return s===n&&(s=s.slice()),o.lc=s.push(i,a||o.l)/2,()=>{s===n&&(s=s.slice());let l=s.indexOf(i);~l&&(s.splice(l,2),o.lc--,o.lc||o.off())}},subscribe(i,a){let l=o.listen(i,a);return i(o.value),l},off(){}};return o},map=(t={})=>{let e=atom(t);return e.setKey=function(n,s){typeof s>"u"?n in e.value&&(e.value={...e.value},delete e.value[n],e.notify(n)):e.value[n]!==s&&(e.value={...e.value,[n]:s},e.notify(n))},e};export{strudel as A,getTrigger as B,Cyclist as C,Drawer as D,getDrawContext as E,clamp as F,isNoteWithOctave as G,isNote as H,evalScope as I,controls as J,cleanupUi as K,cleanupDraw as L,Pattern as P,_mod as _,ref as a,pure as b,stack as c,chooseInWith as d,rand as e,fraction as f,slowcat as g,sequence as h,isPattern as i,reify as j,flatten as k,logger as l,midi2note as m,noteToMidi as n,setStringParser as o,parseNumeral as p,fastcat as q,repl as r,silence as s,timeCat as t,register as u,getFrequency as v,valueToMidi as w,freqToMidi as x,getPlayableNoteValue as y,map as z};
//# sourceMappingURL=index.a2044bc2.js.map
