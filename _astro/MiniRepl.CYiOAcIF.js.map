{"version":3,"file":"MiniRepl.CYiOAcIF.js","sources":["../../src/docs/Icon.jsx","../../src/docs/MiniRepl.jsx"],"sourcesContent":["export function Icon({ type }) {\n  if (type === 'skip') {\n    // !Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.\n    return (\n      <svg\n        fillRule=\"evenodd\"\n        fill=\"currentColor\"\n        xmlns=\"http://www.w3.org/2000/svg\"\n        height=\"16\"\n        width=\"10\"\n        viewBox=\"0 0 320 512\"\n      >\n        <path d=\"M52.5 440.6c-9.5 7.9-22.8 9.7-34.1 4.4S0 428.4 0 416V96C0 83.6 7.2 72.3 18.4 67s24.5-3.6 34.1 4.4l192 160L256 241V96c0-17.7 14.3-32 32-32s32 14.3 32 32V416c0 17.7-14.3 32-32 32s-32-14.3-32-32V271l-11.5 9.6-192 160z\" />\n      </svg>\n    );\n  }\n  return (\n    <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n      {\n        {\n          refresh: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          play: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          pause: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          stop: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M2 10a8 8 0 1116 0 8 8 0 01-16 0zm5-2.25A.75.75 0 017.75 7h4.5a.75.75 0 01.75.75v4.5a.75.75 0 01-.75.75h-4.5a.75.75 0 01-.75-.75v-4.5z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          skip: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M52.5 440.6c-9.5 7.9-22.8 9.7-34.1 4.4S0 428.4 0 416V96C0 83.6 7.2 72.3 18.4 67s24.5-3.6 34.1 4.4l192 160L256 241V96c0-17.7 14.3-32 32-32s32 14.3 32 32V416c0 17.7-14.3 32-32 32s-32-14.3-32-32V271l-11.5 9.6-192 160z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n        }[type]\n      }\n    </svg>\n  );\n}\n","import { useState, useRef, useCallback, useMemo, useEffect } from 'react';\nimport { Icon } from './Icon';\nimport { silence, noteToMidi, _mod } from '@strudel/core';\nimport { getPunchcardPainter } from '@strudel/draw';\nimport { transpiler } from '@strudel/transpiler';\nimport { getAudioContext, webaudioOutput, initAudioOnFirstClick } from '@strudel/webaudio';\nimport { StrudelMirror } from '@strudel/codemirror';\nimport { prebake } from '../repl/prebake.mjs';\nimport { loadModules } from '../repl/util.mjs';\nimport Claviature from '@components/Claviature';\nimport useClient from '@src/useClient.mjs';\n\nlet prebaked, modulesLoading, audioLoading;\nif (typeof window !== 'undefined') {\n  prebaked = prebake();\n  modulesLoading = loadModules();\n  audioLoading = initAudioOnFirstClick();\n}\n\nexport function MiniRepl({\n  tune,\n  tunes,\n  hideHeader = false,\n  canvasHeight = 100,\n  onTrigger,\n  punchcard,\n  punchcardLabels = true,\n  claviature,\n  claviatureLabels,\n  maxHeight,\n}) {\n  const code = tunes ? tunes[0] : tune;\n  const id = useMemo(() => s4(), []);\n  const canvasId = useMemo(() => `canvas-${id}`, [id]);\n  const shouldDraw = !!punchcard || !!claviature;\n  const shouldShowCanvas = !!punchcard;\n  const drawTime = punchcard ? [0, 4] : [0, 0];\n  const [activeNotes, setActiveNotes] = useState([]);\n\n  const init = useCallback(({ code, shouldDraw }) => {\n    const drawContext = shouldDraw ? document.querySelector('#' + canvasId)?.getContext('2d') : null;\n\n    const editor = new StrudelMirror({\n      id,\n      defaultOutput: webaudioOutput,\n      getTime: () => getAudioContext().currentTime,\n      transpiler,\n      autodraw: !!shouldDraw,\n      root: containerRef.current,\n      initialCode: '// LOADING',\n      pattern: silence,\n      drawTime,\n      drawContext,\n      editPattern: (pat, id) => {\n        if (onTrigger) {\n          pat = pat.onTrigger(onTrigger, false);\n        }\n        if (claviature) {\n          editor?.painters.push((ctx, time, haps, drawTime) => {\n            const active = haps\n              .map((hap) => hap.value.note)\n              .filter(Boolean)\n              .map((n) => (typeof n === 'string' ? noteToMidi(n) : n));\n            setActiveNotes(active);\n          });\n        }\n        if (punchcard) {\n          editor?.painters.push(getPunchcardPainter({ labels: !!punchcardLabels }));\n        }\n        return pat;\n      },\n      prebake: async () => Promise.all([modulesLoading, prebaked, audioLoading]),\n      onUpdateState: (state) => {\n        setReplState({ ...state });\n      },\n    });\n    // init settings\n    editor.setCode(code);\n    editorRef.current = editor;\n  }, []);\n\n  const [replState, setReplState] = useState({});\n  const { started, isDirty, error } = replState;\n  const editorRef = useRef();\n  const containerRef = useRef();\n  const client = useClient();\n\n  const [tuneIndex, setTuneIndex] = useState(0);\n  const changeTune = (index) => {\n    index = _mod(index, tunes.length);\n    setTuneIndex(index);\n    editorRef.current?.setCode(tunes[index]);\n    editorRef.current?.evaluate();\n  };\n\n  if (!client) {\n    return <pre>{code}</pre>;\n  }\n\n  return (\n    <div className=\"overflow-hidden rounded-t-md bg-background border border-lineHighlight\">\n      {!hideHeader && (\n        <div className=\"flex justify-between bg-lineHighlight\">\n          <div className=\"flex\">\n            <button\n              className={cx(\n                'cursor-pointer w-16 flex items-center justify-center p-1 border-r border-lineHighlight text-foreground bg-lineHighlight hover:bg-background',\n                started ? 'animate-pulse' : '',\n              )}\n              onClick={() => editorRef.current?.toggle()}\n            >\n              <Icon type={started ? 'stop' : 'play'} />\n            </button>\n            <button\n              className={cx(\n                'w-16 flex items-center justify-center p-1 text-foreground border-lineHighlight bg-lineHighlight',\n                isDirty ? 'text-foreground hover:bg-background cursor-pointer' : 'opacity-50 cursor-not-allowed',\n              )}\n              onClick={() => editorRef.current?.evaluate()}\n            >\n              <Icon type=\"refresh\" />\n            </button>\n          </div>\n          {tunes && (\n            <div className=\"flex\">\n              <button\n                className={\n                  'cursor-pointer w-16 flex items-center justify-center p-1 border-r border-lineHighlight text-foreground bg-lineHighlight hover:bg-background'\n                }\n                onClick={() => changeTune(tuneIndex - 1)}\n              >\n                <div className=\"rotate-180\">\n                  <Icon type=\"skip\" />\n                </div>\n              </button>\n              <button\n                className={\n                  'cursor-pointer w-16 flex items-center justify-center p-1 border-r border-lineHighlight text-foreground bg-lineHighlight hover:bg-background'\n                }\n                onClick={() => changeTune(tuneIndex + 1)}\n              >\n                <Icon type=\"skip\" />\n              </button>\n            </div>\n          )}\n        </div>\n      )}\n      <div className=\"overflow-auto relative p-1\" style={maxHeight ? { maxHeight: `${maxHeight}px` } : {}}>\n        <div\n          ref={(el) => {\n            if (!editorRef.current) {\n              containerRef.current = el;\n              init({ code, shouldDraw });\n            }\n          }}\n        ></div>\n        {error && <div className=\"text-right p-1 text-md text-red-200\">{error.message}</div>}\n      </div>\n      {shouldShowCanvas && (\n        <canvas\n          id={canvasId}\n          className=\"w-full pointer-events-none border-t border-lineHighlight\"\n          height={canvasHeight}\n          ref={(el) => {\n            if (el && el.width !== el.clientWidth) {\n              el.width = el.clientWidth;\n            }\n          }}\n        ></canvas>\n      )}\n      {/* !!log.length && (\n      <div className=\"bg-gray-800 rounded-md p-2\">\n        {log.map(({ message }, i) => (\n          <div key={i}>{message}</div>\n        ))}\n      </div>\n    ) */}\n      {claviature && (\n        <Claviature\n          options={{\n            range: ['C2', 'C6'],\n            scaleY: 0.75,\n            colorize: [{ keys: activeNotes, color: 'steelblue' }],\n            labels: claviatureLabels || {},\n          }}\n        />\n      )}\n    </div>\n  );\n}\n\nfunction cx(...classes) {\n  // : Array<string | undefined>\n  return classes.filter(Boolean).join(' ');\n}\n\nfunction s4() {\n  return Math.floor((1 + Math.random()) * 0x10000)\n    .toString(16)\n    .substring(1);\n}\n"],"names":["Icon","type","jsx","prebaked","modulesLoading","audioLoading","prebake","loadModules","initAudioOnFirstClick","MiniRepl","tune","tunes","hideHeader","canvasHeight","onTrigger","punchcard","punchcardLabels","claviature","claviatureLabels","maxHeight","code","id","useMemo","s4","canvasId","shouldDraw","shouldShowCanvas","drawTime","activeNotes","setActiveNotes","useState","init","useCallback","drawContext","editor","StrudelMirror","webaudioOutput","getAudioContext","transpiler","containerRef","silence","pat","ctx","time","haps","active","hap","n","noteToMidi","getPunchcardPainter","state","setReplState","editorRef","replState","started","isDirty","error","useRef","client","useClient","tuneIndex","setTuneIndex","changeTune","index","_mod","jsxs","cx","el","Claviature","classes"],"mappings":"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"}