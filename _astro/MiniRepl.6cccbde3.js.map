{"version":3,"file":"MiniRepl.6cccbde3.js","sources":["../../src/docs/Icon.jsx","../../src/docs/MiniRepl.jsx"],"sourcesContent":["export function Icon({ type }) {\n  return (\n    <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n      {\n        {\n          refresh: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          play: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          pause: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          stop: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M2 10a8 8 0 1116 0 8 8 0 01-16 0zm5-2.25A.75.75 0 017.75 7h4.5a.75.75 0 01.75.75v4.5a.75.75 0 01-.75.75h-4.5a.75.75 0 01-.75-.75v-4.5z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n        }[type]\n      }\n    </svg>\n  );\n}\n","import { useState, useRef, useCallback, useMemo, useEffect } from 'react';\nimport { Icon } from './Icon';\nimport { silence, getPunchcardPainter, noteToMidi } from '@strudel.cycles/core';\nimport { transpiler } from '@strudel.cycles/transpiler';\nimport { getAudioContext, webaudioOutput } from '@strudel.cycles/webaudio';\nimport { StrudelMirror } from '@strudel/codemirror';\n// import { prebake } from '@strudel/repl';\nimport { prebake } from '../repl/prebake.mjs';\nimport { loadModules } from '../repl/util.mjs';\nimport Claviature from '@components/Claviature';\nimport useClient from '@src/useClient.mjs';\n\nlet prebaked, modulesLoading;\nif (typeof window !== 'undefined') {\n  prebaked = prebake();\n  modulesLoading = loadModules();\n}\n\nexport function MiniRepl({\n  tune: code,\n  hideHeader = false,\n  canvasHeight = 100,\n  onTrigger,\n  punchcard,\n  punchcardLabels = true,\n  claviature,\n  claviatureLabels,\n}) {\n  const id = useMemo(() => s4(), []);\n  const canvasId = useMemo(() => `canvas-${id}`, [id]);\n  const shouldDraw = !!punchcard || !!claviature;\n  const shouldShowCanvas = !!punchcard;\n  const drawTime = punchcard ? [0, 4] : [0, 0];\n  const [activeNotes, setActiveNotes] = useState([]);\n\n  const init = useCallback(({ code, shouldDraw }) => {\n    const drawContext = shouldDraw ? document.querySelector('#' + canvasId)?.getContext('2d') : null;\n    let onDraw;\n    if (shouldDraw) {\n      onDraw = (haps, time, frame, painters) => {\n        painters.length && drawContext?.clearRect(0, 0, drawContext.canvas.width * 2, drawContext.canvas.height * 2);\n        painters?.forEach((painter) => {\n          // ctx time haps drawTime paintOptions\n          painter(drawContext, time, haps, drawTime, { clear: false });\n        });\n      };\n    }\n\n    const editor = new StrudelMirror({\n      id,\n      defaultOutput: webaudioOutput,\n      getTime: () => getAudioContext().currentTime,\n      transpiler,\n      autodraw: !!shouldDraw,\n      root: containerRef.current,\n      initialCode: '// LOADING',\n      pattern: silence,\n      drawTime,\n      onDraw,\n      editPattern: (pat, id) => {\n        if (onTrigger) {\n          pat = pat.onTrigger(onTrigger, false);\n        }\n        if (claviature) {\n          editor?.painters.push((ctx, time, haps, drawTime) => {\n            const active = haps\n              .map((hap) => hap.value.note)\n              .filter(Boolean)\n              .map((n) => (typeof n === 'string' ? noteToMidi(n) : n));\n            setActiveNotes(active);\n          });\n        }\n        if (punchcard) {\n          editor?.painters.push(getPunchcardPainter({ labels: !!punchcardLabels }));\n        }\n        return pat;\n      },\n      prebake: async () => Promise.all([modulesLoading, prebaked]),\n      onUpdateState: (state) => {\n        setReplState({ ...state });\n      },\n    });\n    // init settings\n    editor.setCode(code);\n    editorRef.current = editor;\n  }, []);\n\n  const [replState, setReplState] = useState({});\n  const { started, isDirty, error } = replState;\n  const editorRef = useRef();\n  const containerRef = useRef();\n  const client = useClient();\n\n  if (!client) {\n    return <pre>{code}</pre>;\n  }\n\n  return (\n    <div className=\"overflow-hidden rounded-t-md bg-background border border-lineHighlight\">\n      {!hideHeader && (\n        <div className=\"flex justify-between bg-lineHighlight\">\n          <div className=\"flex\">\n            <button\n              className={cx(\n                'cursor-pointer w-16 flex items-center justify-center p-1 border-r border-lineHighlight text-foreground bg-lineHighlight hover:bg-background',\n                started ? 'animate-pulse' : '',\n              )}\n              onClick={() => editorRef.current?.toggle()}\n            >\n              <Icon type={started ? 'stop' : 'play'} />\n            </button>\n            <button\n              className={cx(\n                'w-16 flex items-center justify-center p-1 text-foreground border-lineHighlight bg-lineHighlight',\n                isDirty ? 'text-foreground hover:bg-background cursor-pointer' : 'opacity-50 cursor-not-allowed',\n              )}\n              onClick={() => editorRef.current?.evaluate()}\n            >\n              <Icon type=\"refresh\" />\n            </button>\n          </div>\n        </div>\n      )}\n      <div className=\"overflow-auto relative p-1\">\n        <div\n          ref={(el) => {\n            if (!editorRef.current) {\n              containerRef.current = el;\n              init({ code, shouldDraw });\n            }\n          }}\n        ></div>\n        {error && <div className=\"text-right p-1 text-md text-red-200\">{error.message}</div>}\n      </div>\n      {shouldShowCanvas && (\n        <canvas\n          id={canvasId}\n          className=\"w-full pointer-events-none border-t border-lineHighlight\"\n          height={canvasHeight}\n          ref={(el) => {\n            if (el && el.width !== el.clientWidth) {\n              el.width = el.clientWidth;\n            }\n          }}\n        ></canvas>\n      )}\n      {/* !!log.length && (\n      <div className=\"bg-gray-800 rounded-md p-2\">\n        {log.map(({ message }, i) => (\n          <div key={i}>{message}</div>\n        ))}\n      </div>\n    ) */}\n      {claviature && (\n        <Claviature\n          options={{\n            range: ['C2', 'C6'],\n            scaleY: 0.75,\n            colorize: [{ keys: activeNotes, color: 'steelblue' }],\n            labels: claviatureLabels || {},\n          }}\n        />\n      )}\n    </div>\n  );\n}\n\nfunction cx(...classes) {\n  // : Array<string | undefined>\n  return classes.filter(Boolean).join(' ');\n}\n\nfunction s4() {\n  return Math.floor((1 + Math.random()) * 0x10000)\n    .toString(16)\n    .substring(1);\n}\n"],"names":["Icon","type","jsx","prebaked","modulesLoading","prebake","loadModules","MiniRepl","code","hideHeader","canvasHeight","onTrigger","punchcard","punchcardLabels","claviature","claviatureLabels","id","useMemo","s4","canvasId","shouldDraw","shouldShowCanvas","drawTime","activeNotes","setActiveNotes","useState","init","useCallback","drawContext","onDraw","haps","time","frame","painters","painter","editor","StrudelMirror","webaudioOutput","getAudioContext","transpiler","containerRef","silence","pat","ctx","active","hap","noteToMidi","getPunchcardPainter","state","setReplState","editorRef","replState","started","isDirty","error","useRef","useClient","jsxs","cx","el","Claviature","classes"],"mappings":"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"}