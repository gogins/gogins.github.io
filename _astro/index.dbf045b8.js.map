{"version":3,"file":"index.dbf045b8.js","sources":["../../../node_modules/.pnpm/react-hook-inview@4.5.0_react-dom@18.2.0_react@18.2.0/node_modules/react-hook-inview/dist/esm/useObserver.js","../../../node_modules/.pnpm/react-hook-inview@4.5.0_react-dom@18.2.0_react@18.2.0/node_modules/react-hook-inview/dist/esm/useInView.js","../../../packages/react/src/components/Icon.tsx","../../../packages/react/src/components/MiniRepl.jsx"],"sourcesContent":["import { useRef, useCallback, } from \"react\";\n/**\n * useObserver\n * @param callback IntersectionObserverCallback\n * @param options IntersectionObserverInit\n * @param externalState React.ComponentState[]\n */\nconst useObserver = (callback, { root, rootMargin, threshold } = {}, externalState = []) => {\n    const target = useRef(null);\n    const observer = useRef(null);\n    const setTarget = useCallback((node) => {\n        if (target.current && observer.current) {\n            observer.current.unobserve(target.current);\n            observer.current.disconnect();\n            observer.current = null;\n        }\n        if (node) {\n            observer.current = new IntersectionObserver(callback, { root, rootMargin, threshold });\n            observer.current.observe(node);\n            target.current = node;\n        }\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [target, root, rootMargin, JSON.stringify(threshold), ...externalState]);\n    return setTarget;\n};\nexport default useObserver;\n","import { useEffect, useState, useCallback, } from \"react\";\nimport useObserver from \"./useObserver\";\n/**\n * useInView\n * @param options IntersectionObserverInit\n * @param externalState React.ComponentState[]\n */\nconst useInView = ({ root, rootMargin, threshold, unobserveOnEnter, target, onEnter, onLeave, defaultInView } = {}, externalState = []) => {\n    const [state, setState] = useState({\n        inView: defaultInView || false,\n        entry: null,\n        observer: null,\n    });\n    const callback = useCallback(([entry], observer) => {\n        const inThreshold = observer.thresholds.some((t) => entry.intersectionRatio >= t);\n        const inView = inThreshold && entry.isIntersecting;\n        setState({\n            inView,\n            entry,\n            observer,\n        });\n        // unobserveOnEnter\n        if (inView && unobserveOnEnter) {\n            observer.unobserve(entry.target);\n            observer.disconnect();\n        }\n        // Legacy callbacks\n        if (inView) {\n            onEnter === null || onEnter === void 0 ? void 0 : onEnter(entry, observer);\n        }\n        else {\n            onLeave === null || onLeave === void 0 ? void 0 : onLeave(entry, observer);\n        }\n    }, [onEnter, onLeave, unobserveOnEnter]);\n    const setTarget = useObserver(callback, { root, rootMargin, threshold }, [unobserveOnEnter, ...externalState]);\n    // Legacy 'target' option\n    useEffect(() => {\n        if (target === null || target === void 0 ? void 0 : target.current)\n            setTarget(target.current);\n    }, [target, setTarget]);\n    return [setTarget, state.inView, state.entry, state.observer];\n};\nexport default useInView;\n","import React from 'react';\n\nexport function Icon({ type }) {\n  return (\n    <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n      {\n        {\n          refresh: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          play: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          pause: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n          stop: (\n            <path\n              fillRule=\"evenodd\"\n              d=\"M2 10a8 8 0 1116 0 8 8 0 01-16 0zm5-2.25A.75.75 0 017.75 7h4.5a.75.75 0 01.75.75v4.5a.75.75 0 01-.75.75h-4.5a.75.75 0 01-.75-.75v-4.5z\"\n              clipRule=\"evenodd\"\n            />\n          ),\n        }[type]\n      }\n    </svg>\n  );\n}\n","import { getAudioContext, webaudioOutput } from '@strudel.cycles/webaudio';\nimport React, { useLayoutEffect, useMemo, useRef, useState, useCallback, useEffect } from 'react';\nimport { useInView } from 'react-hook-inview';\nimport 'tailwindcss/tailwind.css';\nimport cx from '../cx';\nimport useHighlighting from '../hooks/useHighlighting.mjs';\nimport useStrudel from '../hooks/useStrudel.mjs';\nimport CodeMirror6, { flash } from './CodeMirror6';\nimport { Icon } from './Icon';\nimport './style.css';\nimport { logger } from '@strudel.cycles/core';\nimport useEvent from '../hooks/useEvent.mjs';\nimport useKeydown from '../hooks/useKeydown.mjs';\n\nconst getTime = () => getAudioContext().currentTime;\n\nexport function MiniRepl({\n  tune,\n  hideOutsideView = false,\n  enableKeyboard,\n  onTrigger,\n  drawTime,\n  punchcard,\n  punchcardLabels,\n  onPaint,\n  canvasHeight = 200,\n  fontSize = 18,\n  fontFamily,\n  hideHeader = false,\n  theme,\n  keybindings,\n  isLineNumbersDisplayed,\n}) {\n  drawTime = drawTime || (punchcard ? [0, 4] : undefined);\n  const evalOnMount = !!drawTime;\n  const drawContext = useCallback(\n    punchcard ? (canvasId) => document.querySelector('#' + canvasId)?.getContext('2d') : null,\n    [punchcard],\n  );\n  const {\n    code,\n    setCode,\n    evaluate,\n    activateCode,\n    error,\n    isDirty,\n    activeCode,\n    pattern,\n    started,\n    scheduler,\n    togglePlay,\n    stop,\n    canvasId,\n    id: replId,\n  } = useStrudel({\n    initialCode: tune,\n    defaultOutput: webaudioOutput,\n    editPattern: (pat, id) => {\n      //pat = pat.withContext((ctx) => ({ ...ctx, id }));\n      if (onTrigger) {\n        pat = pat.onTrigger(onTrigger, false);\n      }\n      if (onPaint) {\n        pat = pat.onPaint(onPaint);\n      } else if (punchcard) {\n        pat = pat.punchcard({ labels: punchcardLabels });\n      }\n      return pat;\n    },\n    getTime,\n    evalOnMount,\n    drawContext,\n    drawTime,\n    afterEval: ({ meta }) => setMiniLocations(meta.miniLocations),\n  });\n\n  const [view, setView] = useState();\n  const [ref, isVisible] = useInView({\n    threshold: 0.01,\n  });\n  const wasVisible = useRef();\n  const show = useMemo(() => {\n    if (isVisible || !hideOutsideView) {\n      wasVisible.current = true;\n    }\n    return isVisible || wasVisible.current;\n  }, [isVisible, hideOutsideView]);\n  const { setMiniLocations } = useHighlighting({\n    view,\n    pattern,\n    active: started && !activeCode?.includes('strudel disable-highlighting'),\n    getTime: () => scheduler.now(),\n  });\n\n  // keyboard shortcuts\n  useKeydown(\n    useCallback(\n      async (e) => {\n        if (view?.hasFocus) {\n          if (e.ctrlKey || e.altKey) {\n            if (e.code === 'Enter') {\n              e.preventDefault();\n              flash(view);\n              await activateCode();\n            } else if (e.key === '.' || e.code === 'Period') {\n              stop();\n              e.preventDefault();\n            }\n          }\n        }\n      },\n      [activateCode, stop, view],\n    ),\n  );\n\n  const [log, setLog] = useState([]);\n  useLogger(\n    useCallback((e) => {\n      const { data } = e.detail;\n      const logId = data?.hap?.context?.id;\n      // const logId = data?.pattern?.meta?.id;\n      if (logId === replId) {\n        setLog((l) => {\n          return l.concat([e.detail]).slice(-8);\n        });\n      }\n    }, []),\n  );\n\n  return (\n    <div className=\"overflow-hidden rounded-t-md bg-background border border-lineHighlight\" ref={ref}>\n      {!hideHeader && (\n        <div className=\"flex justify-between bg-lineHighlight\">\n          <div className=\"flex\">\n            <button\n              className={cx(\n                'cursor-pointer w-16 flex items-center justify-center p-1 border-r border-lineHighlight text-foreground bg-lineHighlight hover:bg-background',\n                started ? 'animate-pulse' : '',\n              )}\n              onClick={() => togglePlay()}\n            >\n              <Icon type={started ? 'stop' : 'play'} />\n            </button>\n            <button\n              className={cx(\n                'w-16 flex items-center justify-center p-1 text-foreground border-lineHighlight bg-lineHighlight',\n                isDirty ? 'text-foreground hover:bg-background cursor-pointer' : 'opacity-50 cursor-not-allowed',\n              )}\n              onClick={() => activateCode()}\n            >\n              <Icon type=\"refresh\" />\n            </button>\n          </div>\n        </div>\n      )}\n      <div className=\"overflow-auto relative\">\n        {show && (\n          <CodeMirror6\n            value={code}\n            onChange={setCode}\n            onViewChanged={setView}\n            theme={theme}\n            fontFamily={fontFamily}\n            fontSize={fontSize}\n            keybindings={keybindings}\n            isLineNumbersDisplayed={isLineNumbersDisplayed}\n          />\n        )}\n        {error && <div className=\"text-right p-1 text-md text-red-200\">{error.message}</div>}\n      </div>\n      {punchcard && (\n        <canvas\n          id={canvasId}\n          className=\"w-full pointer-events-none\"\n          height={canvasHeight}\n          ref={(el) => {\n            if (el && el.width !== el.clientWidth) {\n              el.width = el.clientWidth;\n            }\n          }}\n        ></canvas>\n      )}\n      {!!log.length && (\n        <div className=\"bg-gray-800 rounded-md p-2\">\n          {log.map(({ message }, i) => (\n            <div key={i}>{message}</div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n\n// TODO: dedupe\nfunction useLogger(onTrigger) {\n  useEvent(logger.key, onTrigger);\n}\n"],"names":["useObserver","callback","root","rootMargin","threshold","externalState","target","useRef","observer","useCallback","node","useInView","unobserveOnEnter","onEnter","onLeave","defaultInView","state","setState","useState","entry","inView","t","setTarget","useEffect","Icon","type","refresh","play","pause","stop","getTime","getAudioContext","currentTime","MiniRepl","tune","hideOutsideView","enableKeyboard","onTrigger","drawTime","punchcard","punchcardLabels","onPaint","canvasHeight","fontSize","fontFamily","hideHeader","theme","keybindings","isLineNumbersDisplayed","evalOnMount","drawContext","canvasId","document","querySelector","getContext","code","setCode","evaluate","activateCode","error","isDirty","activeCode","pattern","started","scheduler","togglePlay","id","replId","useStrudel","initialCode","defaultOutput","webaudioOutput","editPattern","pat","labels","afterEval","meta","setMiniLocations","miniLocations","view","setView","ref","isVisible","wasVisible","show","useMemo","current","useHighlighting","active","includes","now","e","hasFocus","ctrlKey","altKey","preventDefault","flash","key","log","setLog","useLogger","data","detail","hap","context","l","concat","slice","_jsx","cx","_jsxs","CodeMirror6","message","el","width","clientWidth","length","map","i","logger"],"mappings":"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","x_google_ignoreList":[0,1]}