<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>cloud-music</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">cloud-music</h1>
</header>
<style>
body {
    margin: 2em;
    padding-right: 1em;
    padding-left: 1em;
    max-width: 7in; 
    color: black;
    font-family: Verdana, Geneva, sans-serif;
    font-size: 100%;
    line-height: 140%;
    background: whitesmoke; 
}
p, ul, li {
    font-family: Georgia, Garamond, serif;
}
</style>
<h1 id="cloud-music">cloud-music</h1>
<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" 
style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
</a><br />This work is licensed under a
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International
License</a>.</p>
<p>Music in the cloud by Michael Gogins.</p>
<p>This is real music. Each piece will play indefinitely in any standard
Web browser. There may or may not be animated visuals along with the
music. The listener may or may not be able to customize the piece &#x2013;
perhaps quite a bit, amounting to a new piece, co-composed with me.</p>
<p>All source code for these pieces is available in the GitHub
repository.</p>
<p>The underlying technology is my
<a href="https://github.com/gogins/csound-wasm">WebAssembly builds of
Csound and CsoundAC</a>. Some pieces may use third party libraries.</p>
<h1 id="installation">Installation</h1>
<p>This repository is a bit of a hack, but I have tried to make it as
maintainable as possible.</p>
<p>The basic idea is to extend Strudel not only with Csound, but also
with CsoundAC, and then to make Strudel into an embeddable component
that I can use in my pieces. This is possible because the Strudel Web
site serves a REPL page that will run Strudel code from users via an
HTTP request, which I can hijack for my own purposes.</p>
<p>To this end, Strudel is included in this repository as a Git
submodule. But, before actually building Strudel, this repository makes
the following patches to Strudel head:</p>
<ol type="1">
<li>Make some minor patches to the Strudel source code. There is a
Python script that npm will use to make these patches. If this quits
working, change the <code>patch-strudel.py</code> script as
required.</li>
<li>Patch the generated <code>strudel/website/dist/index.html</code>
file to use relative rather than absolute pathnames for imported assets.
This is needed in order to run the Strudel REPL from GitHub pages, which
are not necessarily at the root of their Web server. There is a Python
script that npm will use to make this patch. If this quits working,
change the <code>patch-dist.py</code> script as required.</li>
</ol>
<p>I have done my best to keep these patches as few and simple as
possible.</p>
<h2 id="building">Building</h2>
<p>Install <a href="https://www.npmjs.com/package/pnpm">pnpm</a>, which
cloud-music and Strudel use rather than npm. On macOS (I don&#x2019;t know
about other platforms), you may need to specifically install
node@18.</p>
<p>To initialize the local repository, obtain dependencies, build a
static Web site, and run it locally, execute the following commands:</p>
<pre><code>pnpm install
pnpm run setup
pnpm run build
pnpm run debug</code></pre>
<p>These commands will patch Strudel with my addons; build everything;
make a distributable copy of the cloud-music Web site in the
<code>dist</code> directory, with all resources statically available;
and run a local Web site, which is source level debuggable, in that
directory. Examine <code>package.json</code> for details.</p>
<p>This may fail due to failure to build <code>canvas.node</code> (not
actually used here). If that happens, execute
<code>ccd loud-music/strudel/packages/canvas</code> and
<code>node-gyp rebuild</code>, and try again from
<code>pnpm run build</code>.</p>
<p>Before updating strudel from GitHub, make a branch to contain the
updates if they break cloud-music.</p>
<p>If you see warnings or errors, don&#x2019;t panic unless browsing localhost
does not open a working Web site with playable pieces!</p>
<p>It may be necessary to clear the browser cache and application site
data to see updated pieces.</p>
<h2 id="debugging-hints">Debugging Hints</h2>
<p>The JavaScript <code>debugging;</code> command will break in the
debugger at that line.</p>
<p>Be sure to enable JavaScript source maps in the debugger settings.
That won&#x2019;t necessarily work for Strudel sources; load their source maps
manually e.g.&#xA0;by opening a deployed (usually minified) source file in
the debugger, then right- clicking on the code, and selecting &#x201C;Add
source map&#x2026;&#x201D; from the context menu. Oops, that should work, but I don&#x2019;t
actually <em>find</em> the source maps&#x2026;.</p>
<h2 id="deployment">Deployment</h2>
<p>Build this project, then copy the entire contents of the
<code>dist</code> directory to your own Web site&#x2019;s public HTML
directory.</p>
<h2 id="maintenance-notes">Maintenance Notes!</h2>
<p><em>If at all possible</em>, never edit <em>existing</em> Strudel
files, always add <em>new</em> Strudel files. This is to keep conflicts
between Strudel and cloud-music to an absolute minimum.</p>
<p>Track the version of [Csound for WebAssembly]
(https://github.com/gogins/csound-wasm) and update the files if a new
version becomes available.</p>
<h2 id="extending-strudel">Extending Strudel</h2>
<p>For cloud-music pieces that use Strudel&#x2019;s REPL, it is possible to add
new user-defined Patterns and perhaps other functions to Strudel
<em>without rebuilding Strudel</em>.</p>
<ol type="1">
<li>Write a static <code>MyModule.mjs</code> module in the Web root (the
<code>docs</code> directory).</li>
<li>Do <em>not</em> import anything that will already have been imported
by the Strudel REPL itself &#x2013; which is essentially all of Strudel.</li>
<li>Call Strudel&#x2019;s <code>register</code> function to integrate any new
Patterns into Strudel.</li>
<li>Don&#x2019;t forget, any Strudel piece that uses MyModule has to
<code>import('/MyModule.mjs');</code> first thing!</li>
</ol>
<p>The <code>csoundac.mjs</code> module is an example of such a
plugin.</p>
</body>
</html>
