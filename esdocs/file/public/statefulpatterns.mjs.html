<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">public/statefulpatterns.mjs</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/public/CsoundAudioNode.js~CsoundAudioNode.html">CsoundAudioNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/public/csoundac.mjs~ChordPatterns.html">ChordPatterns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/public/csoundac.mjs~PitvPatterns.html">PitvPatterns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/public/csoundac.mjs~ScalePatterns.html">ScalePatterns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/public/statefulpatterns.mjs~StatefulPatterns.html">StatefulPatterns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Chord">Chord</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Clone">Clone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Pitv">Pitv</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Scale">Scale</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-frequencyToMidiInteger">frequencyToMidiInteger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-frequencyToMidiReal">frequencyToMidiReal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getFrequency">getFrequency</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hsvToRgb">hsvToRgb</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-print_counter">print_counter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setPitch">setPitch</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-set_instrument_count">set_instrument_count</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-track">track</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-diagnostic">diagnostic</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-diagnostic_level">diagnostic_level</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-audioContext">audioContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-chordn_counter">chordn_counter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-csound">csound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-csoundac">csoundac</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-csoundn">csoundn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-csoundn_counter">csoundn_counter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-instrument_count">instrument_count</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ALWAYS">ALWAYS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEBUG">DEBUG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ERROR">ERROR</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-INFORMATION">INFORMATION</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-NEVER">NEVER</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-WARNING">WARNING</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-audioContext">audioContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-csound">csound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-csoundac">csoundac</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-diagnostic_level_">diagnostic_level_</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">public/statefulpatterns.mjs</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * S T A T E F U L P A T T E R N S   M O D U L E   F O R   S T R U D E L
 *
 * Author: Michael Gogins
 * 
 * This module implements &quot;stateful Patterns&quot; by defining a base class, 
 * `StatefulPatterns`, that knows how to register class methods as Patterns.
 */
let csound = globalThis.__csound__;
let csoundac = globalThis.__csoundac__;
let audioContext = new AudioContext();

/**
 * Sets the level of diagnostic messages in this module.
 */
let diagnostic_level_ = 5;

/**
 * Gets and/or sets the level of diagnostic messages.
 */
export function diagnostic_level(new_level) {
    let old_level = diagnostic_level_;
    if (typeof new_level !== &apos;undefined&apos;) {
        diagnostic_level_ = new_level;
    }
    return old_level;
};

export const ALWAYS = 5;
export const DEBUG = 4;
export const INFORMATION = 3;
export const WARNING = 2;
export const ERROR = 1;
export const NEVER = 0;

/**
 * Prints a diagnostic message to both the Strudel logger and the Csound 
 * log. Messages are printed only for the specifed diagnostic level or less.
 */
export function diagnostic(message, level = WARNING) {
    if (level &gt;= diagnostic_level_) {
        const text = &apos;L&apos; + level + &apos; &apos; + audioContext.currentTime.toFixed(4) + &apos; [csac]&apos; + message;
        logger(text, &apos;debug&apos;);
        if (csound) csound.message(text);
    }
};

/**
 * This is a base class that can be used to _automatically_ define Patterns 
 * that hold state between queries. Derived classes, which must be defined at 
 * module scope, must in their constructor call `this.registerPatterns`, which 
 * will automatically register (most of) of their methods as Strudel Patterns, 
 * each of which takes an instance of the class as a first parameter, and the 
 * Pattern as the last parameter. Class methods must have the following syntax 
 * and semantics:
 * ```
 * Class.Pat(is_onset, [0 or more arguments to be patternified], hap) {...}
 * ```
 * Strudel will pass `true` for `is_onset` on the onset of the Pattern&apos;s cycle, 
 * and `false` for `is_onset` for every query in that cycle. Therefore, the 
 * class method must update its state if `is_onset` is true, and return the 
 * hap, without changing its value; and if &apos;is_onset&apos; is false, the method must 
 * update and return the hap, and its usually new value.
 *
 * In this way, derived classes act like stateful values that have Pattern 
 * methods as class methods.
 */
export class StatefulPatterns {
    constructor() {
    }
    registerPatterns() {
        for (let name of Object.getOwnPropertyNames(Object.getPrototypeOf(this))) {
            let method = this[name];
            if ((method instanceof Function) &amp;&amp;
                (method.name !== this.constructor.name) &amp;&amp; 
                (method.name !== &apos;registerMethods&apos;)) {
                let instance = this;
                // Problem: the Pattern function must explicitly declare its 
                // parameters. We can&apos;t push that information from the class 
                // method Function object into the Pattern function 
                // declaration, but we do know the arity of the class method, 
                // which is always at least 1 because of the need to pass the 
                // Hap.
                let arity = method.length;
                // For now, we will set up separate registrations for the 
                // first few arities. The actual arity of the Pattern function 
                // is always at least 3 because of the need to pass the class 
                // instance, the is_onset flag, and the Hap along with any 
                // patternifiable rguments.
                arity = arity + 1;
                if (arity === 3) {
                    let registration = register(name, (stateful, pat) =&gt; {
                        return pat.onTrigger((t, hap) =&gt; {
                            method.call(stateful, true, hap);
                            if (diagnostic_level_ &gt;= DEBUG) diagnostic(&apos;[registerStateful][&apos; + method.name + &apos;] onset:&apos; + JSON.stringify({x, stateful}, null, 4) + &apos;\n&apos;);
                        }, false).withHap((hap) =&gt; {
                            stateful.current_time = getAudioContext().currentTime;
                            if (diagnostic_level_ &gt;= DEBUG) diagnostic(&apos;[registerStateful][&apos; + method.name + &apos;] value:&apos; + JSON.stringify({x, stateful}, null, 4) + &apos;\n&apos;);
                            hap = method.call(stateful, false, hap);
                            return hap;
                        });
                    });
                    // There are no dynamic exports in JavaScript, so we just stuff 
                    // these into the window scope as global functions.
                    window[name] = registration;
                } else if (arity === 4) {
                    let registration = register(name, (stateful, p2, pat) =&gt; {
                        return pat.onTrigger((t, hap) =&gt; {
                            method.call(stateful, true, p2, hap);
                            if (diagnostic_level_ &gt;= DEBUG) diagnostic(&apos;[registerStateful][&apos; + method.name + &apos;] onset:&apos; + JSON.stringify({x, stateful}, null, 4) + &apos;\n&apos;);
                        }, false).withHap((hap) =&gt; {
                            stateful.current_time = getAudioContext().currentTime;
                            if (diagnostic_level_ &gt;= DEBUG) diagnostic(&apos;[registerStateful][&apos; + method.name + &apos;] value:&apos; + JSON.stringify({x, stateful}, null, 4) + &apos;\n&apos;);
                            hap = method.call(stateful, false, p2, hap);
                            return hap;
                        });
                    });
                    window[name] = registration;
                } else if (arity === 5) {
                    let registration = register(name, (stateful, p2, p3, pat) =&gt; {
                        return pat.onTrigger((t, hap) =&gt; {
                            method.call(stateful, true, p2, p3, hap);
                            if (diagnostic_level_ &gt;= DEBUG) diagnostic(&apos;[registerStateful][&apos; + method.name + &apos;] onset:&apos; + JSON.stringify({x, stateful}, null, 4) + &apos;\n&apos;);
                        }, false).withHap((hap) =&gt; {
                            stateful.current_time = getAudioContext().currentTime;
                            if (diagnostic_level_ &gt;= DEBUG) diagnostic(&apos;[registerStateful][&apos; + method.name + &apos;] value:&apos; + JSON.stringify({x, stateful}, null, 4) + &apos;\n&apos;);
                            hap = method.call(stateful, false, p2, p3, hap);
                            return hap;
                        });
                    });
                    window[name] = registration;
               } else if (arity === 6) {
                    let registration = register(name, (stateful, p2, p3, p4, pat) =&gt; {
                        return pat.onTrigger((t, hap) =&gt; {
                            method.call(stateful, true, p2, p3, p4, hap);
                            if (diagnostic_level_ &gt;= DEBUG) diagnostic(&apos;[registerStateful][&apos; + method.name + &apos;] onset:&apos; + JSON.stringify({x, stateful}, null, 4) + &apos;\n&apos;);
                        }, false).withHap((hap) =&gt; {
                            stateful.current_time = getAudioContext().currentTime;
                            if (diagnostic_level_ &gt;= DEBUG) diagnostic(&apos;[registerStateful][&apos; + method.name + &apos;] value:&apos; + JSON.stringify({x, stateful}, null, 4) + &apos;\n&apos;);
                            hap = method.call(stateful, false, p2, p3, p4, hap);
                            return hap;
                        });
                    });
                    window[name] = registration;
                }
            }
        }
    }
}

</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
