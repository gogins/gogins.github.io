{"version":3,"file":"midibridge_B6xfBOHn.mjs","sources":["../../../packages/desktopbridge/midibridge.mjs"],"sourcesContent":["import { Invoke } from './utils.mjs';\nimport { Pattern, noteToMidi } from '@strudel/core';\n\nconst ON_MESSAGE = 0x90;\nconst OFF_MESSAGE = 0x80;\nconst CC_MESSAGE = 0xb0;\n\nPattern.prototype.midi = function (output) {\n  return this.onTrigger((time, hap, currentTime, cps) => {\n    let { note, nrpnn, nrpv, ccn, ccv, velocity = 0.9, gain = 1 } = hap.value;\n    const offset = (time - currentTime) * 1000;\n    velocity = Math.floor(gain * velocity * 100);\n    const duration = Math.floor((hap.duration.valueOf() / cps) * 1000 - 10);\n    const roundedOffset = Math.round(offset);\n    const midichan = (hap.value.midichan ?? 1) - 1;\n    const requestedport = output ?? 'IAC';\n    const messagesfromjs = [];\n    if (note != null) {\n      const midiNumber = typeof note === 'number' ? note : noteToMidi(note);\n      messagesfromjs.push({\n        requestedport,\n        message: [ON_MESSAGE + midichan, midiNumber, velocity],\n        offset: roundedOffset,\n      });\n      messagesfromjs.push({\n        requestedport,\n        message: [OFF_MESSAGE + midichan, midiNumber, velocity],\n        offset: roundedOffset + duration,\n      });\n    }\n    if (ccv && ccn) {\n      if (typeof ccv !== 'number' || ccv < 0 || ccv > 1) {\n        throw new Error('expected ccv to be a number between 0 and 1');\n      }\n      if (!['string', 'number'].includes(typeof ccn)) {\n        throw new Error('expected ccn to be a number or a string');\n      }\n      const scaled = Math.round(ccv * 127);\n      messagesfromjs.push({\n        requestedport,\n        message: [CC_MESSAGE + midichan, ccn, scaled],\n        offset: roundedOffset,\n      });\n    }\n    // invoke is temporarily blocking, run in an async process\n    if (messagesfromjs.length) {\n      setTimeout(() => {\n        Invoke('sendmidi', { messagesfromjs });\n      });\n    }\n  });\n};\n"],"names":[],"mappings":"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"}