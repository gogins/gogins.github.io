{"version":3,"file":"serial_X-ANEiuu.mjs","sources":["../../../packages/serial/serial.mjs"],"sourcesContent":["/*\nserial.mjs - <short description TODO>\nCopyright (C) 2022 Strudel contributors - see <https://github.com/tidalcycles/strudel/blob/main/packages/serial/serial.mjs>\nThis program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more details. You should have received a copy of the GNU Affero General Public License along with this program.  If not, see <https://www.gnu.org/licenses/>.\n*/\n\nimport { Pattern, isPattern } from '@strudel/core';\n\nvar writeMessagers = {};\nvar choosing = false;\n\nexport async function getWriter(name, br) {\n  if (choosing) {\n    return;\n  }\n  choosing = true;\n  if (name in writeMessagers) {\n    return writeMessagers[name];\n  }\n  if ('serial' in navigator) {\n    const port = await navigator.serial.requestPort();\n    await port.open({ baudRate: br });\n    const encoder = new TextEncoder();\n    const writer = port.writable.getWriter();\n    writeMessagers[name] = function (message, chk) {\n      const encoded = encoder.encode(message);\n      if (!chk) {\n        writer.write(encoded);\n      } else {\n        const bytes = new Uint8Array(4);\n        bytes[0] = 124; // | symbol\n        bytes[1] = (chk >> 8) & 0xff;\n        bytes[2] = chk & 0xff;\n        bytes[3] = 59; // semicolon\n        const withchk = new Uint8Array(encoded.length + 4);\n        withchk.set(encoded);\n        withchk.set(bytes, encoded.length);\n        writer.write(withchk);\n      }\n    };\n  } else {\n    throw 'Webserial is not available in this browser.';\n  }\n}\n\nconst latency = 0.1;\n\n// crc16 (CCITT-FALSE) https://gist.github.com/tijnkooijmans/10981093\nfunction crc16(data) {\n  const length = data.length;\n  if (length == 0) {\n    return 0;\n  }\n\n  var crc = 0xffff;\n  for (var i = 0; i < length; ++i) {\n    crc ^= data.charCodeAt(i) << 8;\n    for (var j = 0; j < 8; ++j) {\n      crc = (crc & 0x8000) > 0 ? (crc << 1) ^ 0x1021 : crc << 1;\n    }\n  }\n\n  return crc & 0xffff;\n}\n\nPattern.prototype.serial = function (br = 115200, sendcrc = false, singlecharids = false, name = 'default') {\n  return this.withHap((hap) => {\n    if (!(name in writeMessagers)) {\n      getWriter(name, br);\n    }\n    const onTrigger = (time, hap, currentTime) => {\n      var message = '';\n      var chk = 0;\n      if (typeof hap.value === 'object') {\n        if ('action' in hap.value) {\n          var action = hap.value['action'];\n          if (singlecharids) {\n            action = action.charAt(0);\n          }\n          message += action + '(';\n          var first = true;\n          for (var [key, val] of Object.entries(hap.value)) {\n            if (key === 'action') {\n              continue;\n            }\n            if (first) {\n              first = false;\n            } else {\n              message += ',';\n            }\n            if (singlecharids) {\n              key = key.charAt(0);\n            }\n            message += key + ':' + val;\n          }\n          message += ')';\n          if (sendcrc) {\n            chk = crc16(message);\n          }\n        } else {\n          for (const [key, val] of Object.entries(hap.value)) {\n            message += `${key}:${val}`;\n          }\n        }\n      } else {\n        message = hap.value;\n      }\n      const offset = (time - currentTime + latency) * 1000;\n\n      window.setTimeout(function () {\n        writeMessagers[name](message, chk);\n      }, offset);\n    };\n    return hap.setContext({ ...hap.context, onTrigger, dominantTrigger: true });\n  });\n};\n"],"names":[],"mappings":"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"}